!function(t,e){var i,s=wp.media,o="ontouchend"in document;i=s.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n,s.view.settings=i.settings||{},delete i.settings,s.model.settings.post=s.view.settings.post,t.support.transition=function(){var t,i=document.documentElement.style,s={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};return(t=e.find(e.keys(s),function(t){return!e.isUndefined(i[t])}))&&{end:s[t]}}(),s.events=e.extend({},Backbone.Events),s.transition=function(i,s){var o=t.Deferred();return s=s||2e3,t.support.transition?(i instanceof t||(i=t(i)),i.first().one(t.support.transition.end,o.resolve),e.delay(o.resolve,s)):o.resolve(),o.promise()},s.controller.Region=function(t){e.extend(this,e.pick(t||{},"id","view","selector"))},s.controller.Region.extend=Backbone.Model.extend,e.extend(s.controller.Region.prototype,{mode:function(t){return t?t===this._mode?this:(this.trigger("deactivate"),this._mode=t,this.render(t),this.trigger("activate"),this):this._mode},render:function(t){if(t&&t!==this._mode)return this.mode(t);var e,i={view:null};return this.trigger("create",i),e=i.view,this.trigger("render",e),e&&this.set(e),this},get:function(){return this.view.views.first(this.selector)},set:function(t,e){return e&&(e.add=!1),this.view.views.set(this.selector,t,e)},trigger:function(t){var i,s;if(this._mode)return s=e.toArray(arguments),i=this.id+":"+t,s[0]=i+":"+this._mode,this.view.trigger.apply(this.view,s),s[0]=i,this.view.trigger.apply(this.view,s),this}}),s.controller.StateMachine=function(t){this.states=new Backbone.Collection(t)},s.controller.StateMachine.extend=Backbone.Model.extend,e.extend(s.controller.StateMachine.prototype,Backbone.Events,{state:function(t){return this.states=this.states||new Backbone.Collection,(t=t||this._state)&&!this.states.get(t)&&this.states.add({id:t}),this.states.get(t)},setState:function(t){var e=this.state();return e&&t===e.id||!this.states||!this.states.get(t)?this:(e&&(e.trigger("deactivate"),this._lastState=e.id),this._state=t,this.state().trigger("activate"),this)},lastState:function(){if(this._lastState)return this.state(this._lastState)}}),e.each(["on","off","trigger"],function(t){s.controller.StateMachine.prototype[t]=function(){return this.states=this.states||new Backbone.Collection,this.states[t].apply(this.states,arguments),this}}),s.controller.State=Backbone.Model.extend({constructor:function(){this.on("activate",this._preActivate,this),this.on("activate",this.activate,this),this.on("activate",this._postActivate,this),this.on("deactivate",this._deactivate,this),this.on("deactivate",this.deactivate,this),this.on("reset",this.reset,this),this.on("ready",this._ready,this),this.on("ready",this.ready,this),Backbone.Model.apply(this,arguments),this.on("change:menu",this._updateMenu,this)},ready:function(){},activate:function(){},deactivate:function(){},reset:function(){},_ready:function(){this._updateMenu()},_preActivate:function(){this.active=!0},_postActivate:function(){this.on("change:menu",this._menu,this),this.on("change:titleMode",this._title,this),this.on("change:content",this._content,this),this.on("change:toolbar",this._toolbar,this),this.frame.on("title:render:default",this._renderTitle,this),this._title(),this._menu(),this._toolbar(),this._content(),this._router()},_deactivate:function(){this.active=!1,this.frame.off("title:render:default",this._renderTitle,this),this.off("change:menu",this._menu,this),this.off("change:titleMode",this._title,this),this.off("change:content",this._content,this),this.off("change:toolbar",this._toolbar,this)},_title:function(){this.frame.title.render(this.get("titleMode")||"default")},_renderTitle:function(t){t.$el.text(this.get("title")||"")},_router:function(){var t,e=this.frame.router,i=this.get("router");this.frame.$el.toggleClass("hide-router",!i),i&&(this.frame.router.render(i),(t=e.get())&&t.select&&t.select(this.frame.content.mode()))},_menu:function(){var t,e=this.frame.menu,i=this.get("menu");this.frame.$el.toggleClass("hide-menu",!i),i&&(e.mode(i),(t=e.get())&&t.select&&t.select(this.id))},_updateMenu:function(){var t=this.previous("menu"),e=this.get("menu");t&&this.frame.off("menu:render:"+t,this._renderMenu,this),e&&this.frame.on("menu:render:"+e,this._renderMenu,this)},_renderMenu:function(t){var e=this.get("menuItem"),i=this.get("title"),s=this.get("priority");!e&&i&&(e={text:i},s&&(e.priority=s)),e&&t.set(this.id,e)}}),e.each(["toolbar","content"],function(t){s.controller.State.prototype["_"+t]=function(){var e=this.get(t);e&&this.frame[t].render(e)}}),s.selectionSync={syncSelection:function(){var t=this.get("selection"),i=this.frame._selection;this.get("syncSelection")&&i&&t&&(t.multiple&&(t.reset([],{silent:!0}),t.validateAll(i.attachments),i.difference=e.difference(i.attachments.models,t.models)),t.single(i.single))},recordSelection:function(){var t=this.get("selection"),e=this.frame._selection;this.get("syncSelection")&&e&&t&&(t.multiple?(e.attachments.reset(t.toArray().concat(e.difference)),e.difference=[]):e.attachments.add(t.toArray()),e.single=t._single)}},s.controller.Library=s.controller.State.extend({defaults:{id:"library",title:i.mediaLibraryTitle,multiple:!1,content:"upload",menu:"default",router:"browse",toolbar:"select",searchable:!0,filterable:!1,sortable:!0,autoSelect:!0,describe:!1,contentUserSetting:!0,syncSelection:!0},initialize:function(){var t,i=this.get("selection");this.get("library")||this.set("library",s.query()),i instanceof s.model.Selection||((t=i)||(t=this.get("library").props.toJSON(),t=e.omit(t,"orderby","query")),this.set("selection",new s.model.Selection(null,{multiple:this.get("multiple"),props:t}))),this.resetDisplays()},activate:function(){this.syncSelection(),wp.Uploader.queue.on("add",this.uploading,this),this.get("selection").on("add remove reset",this.refreshContent,this),this.get("router")&&this.get("contentUserSetting")&&(this.frame.on("content:activate",this.saveContentMode,this),this.set("content",getUserSetting("libraryContent",this.get("content"))))},deactivate:function(){this.recordSelection(),this.frame.off("content:activate",this.saveContentMode,this),this.get("selection").off(null,null,this),wp.Uploader.queue.off(null,null,this)},reset:function(){this.get("selection").reset(),this.resetDisplays(),this.refreshContent()},resetDisplays:function(){var t=s.view.settings.defaultProps;this._displays=[],this._defaultDisplaySettings={align:t.align||getUserSetting("align","none"),size:t.size||getUserSetting("imgsize","medium"),link:t.link||getUserSetting("urlbutton","file")}},display:function(t){var e=this._displays;return e[t.cid]||(e[t.cid]=new Backbone.Model(this.defaultDisplaySettings(t))),e[t.cid]},defaultDisplaySettings:function(t){var e=this._defaultDisplaySettings;return(e.canEmbed=this.canEmbed(t))&&(e.link="embed"),e},canEmbed:function(t){if(!t.get("uploading")){var i=t.get("type");if("audio"!==i&&"video"!==i)return!1}return e.contains(s.view.settings.embedExts,t.get("filename").split(".").pop())},refreshContent:function(){var t=this.get("selection"),e=this.frame,i=e.router.get(),s=e.content.mode();this.active&&!t.length&&i&&!i.get(s)&&this.frame.content.render(this.get("content"))},uploading:function(t){"upload"===this.frame.content.mode()&&this.frame.content.mode("browse"),this.get("autoSelect")&&(this.get("selection").add(t),this.frame.trigger("library:selection:add"))},saveContentMode:function(){if("browse"===this.get("router")){var t=this.frame.content.mode(),e=this.frame.router.get();e&&e.get(t)&&setUserSetting("libraryContent",t)}}}),e.extend(s.controller.Library.prototype,s.selectionSync),s.controller.ImageDetails=s.controller.State.extend({defaults:e.defaults({id:"image-details",title:i.imageDetailsTitle,content:"image-details",menu:!1,router:!1,toolbar:"image-details",editing:!1,priority:60},s.controller.Library.prototype.defaults),initialize:function(t){this.image=t.image,s.controller.State.prototype.initialize.apply(this,arguments)},activate:function(){this.frame.modal.$el.addClass("image-details")}}),s.controller.GalleryEdit=s.controller.Library.extend({defaults:{id:"gallery-edit",title:i.editGalleryTitle,multiple:!1,searchable:!1,sortable:!0,display:!1,content:"browse",toolbar:"gallery-edit",describe:!0,displaySettings:!0,dragInfo:!0,idealColumnWidth:170,editing:!1,priority:60,syncSelection:!1},initialize:function(){this.get("library")||this.set("library",new s.model.Selection),this.get("AttachmentView")||this.set("AttachmentView",s.view.Attachment.EditLibrary),s.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){this.get("library").props.set("type","image"),this.get("library").observe(wp.Uploader.queue),this.frame.on("content:render:browse",this.gallerySettings,this),s.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.get("library").unobserve(wp.Uploader.queue),this.frame.off("content:render:browse",this.gallerySettings,this),s.controller.Library.prototype.deactivate.apply(this,arguments)},gallerySettings:function(t){if(this.get("displaySettings")){var e=this.get("library");e&&t&&(e.gallery=e.gallery||new Backbone.Model,t.sidebar.set({gallery:new s.view.Settings.Gallery({controller:this,model:e.gallery,priority:40})}),t.toolbar.set("reverse",{text:i.reverseOrder,priority:80,click:function(){e.reset(e.toArray().reverse())}}))}}}),s.controller.GalleryAdd=s.controller.Library.extend({defaults:e.defaults({id:"gallery-library",title:i.addToGalleryTitle,multiple:"add",filterable:"uploaded",menu:"gallery",toolbar:"gallery-add",priority:100,syncSelection:!1},s.controller.Library.prototype.defaults),initialize:function(){this.get("library")||this.set("library",s.query({type:"image"})),s.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var t=this.get("library"),e=this.frame.state("gallery-edit").get("library");this.editLibrary&&this.editLibrary!==e&&t.unobserve(this.editLibrary),t.validator=function(t){return!!this.mirroring.get(t.cid)&&!e.get(t.cid)&&s.model.Selection.prototype.validator.apply(this,arguments)},t.reset(t.mirroring.models,{silent:!0}),t.observe(e),this.editLibrary=e,s.controller.Library.prototype.activate.apply(this,arguments)}}),s.controller.CollectionEdit=s.controller.Library.extend({defaults:{multiple:!1,sortable:!0,searchable:!1,content:"browse",describe:!0,dragInfo:!0,idealColumnWidth:170,editing:!1,priority:60,SettingsView:!1,syncSelection:!1},initialize:function(){var t=this.get("collectionType");"video"===this.get("type")&&(t="video-"+t),this.set("id",t+"-edit"),this.set("toolbar",t+"-edit"),this.get("library")||this.set("library",new s.model.Selection),this.get("AttachmentView")||this.set("AttachmentView",s.view.Attachment.EditLibrary),s.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){this.get("library").props.set("type",this.get("type")),this.get("library").observe(wp.Uploader.queue),this.frame.on("content:render:browse",this.renderSettings,this),s.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.get("library").unobserve(wp.Uploader.queue),this.frame.off("content:render:browse",this.renderSettings,this),s.controller.Library.prototype.deactivate.apply(this,arguments)},renderSettings:function(e){var o=this.get("library"),n=this.get("collectionType"),r=this.get("dragInfoText"),a=this.get("SettingsView"),l={};o&&e&&(o[n]=o[n]||new Backbone.Model,l[n]=new a({controller:this,model:o[n],priority:40}),e.sidebar.set(l),r&&e.toolbar.set("dragInfo",new s.View({el:t('<div class="instructions">'+r+"</div>")[0],priority:-40})),e.toolbar.set("reverse",{text:i.reverseOrder,priority:80,click:function(){o.reset(o.toArray().reverse())}}))}}),s.controller.CollectionAdd=s.controller.Library.extend({defaults:e.defaults({multiple:"add",filterable:"uploaded",priority:100,syncSelection:!1},s.controller.Library.prototype.defaults),initialize:function(){var t=this.get("collectionType");"video"===this.get("type")&&(t="video-"+t),this.set("id",t+"-library"),this.set("toolbar",t+"-add"),this.set("menu",t),this.get("library")||this.set("library",s.query({type:this.get("type")})),s.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var t=this.get("library"),e=this.get("editLibrary"),i=this.frame.state(this.get("collectionType")+"-edit").get("library");e&&e!==i&&t.unobserve(e),t.validator=function(t){return!!this.mirroring.get(t.cid)&&!i.get(t.cid)&&s.model.Selection.prototype.validator.apply(this,arguments)},t.reset(t.mirroring.models,{silent:!0}),t.observe(i),this.set("editLibrary",i),s.controller.Library.prototype.activate.apply(this,arguments)}}),s.controller.FeaturedImage=s.controller.Library.extend({defaults:e.defaults({id:"featured-image",title:i.setFeaturedImageTitle,multiple:!1,filterable:"uploaded",toolbar:"featured-image",priority:60,syncSelection:!0},s.controller.Library.prototype.defaults),initialize:function(){var t,e;this.get("library")||this.set("library",s.query({type:"image"})),s.controller.Library.prototype.initialize.apply(this,arguments),t=this.get("library"),e=t.comparator,t.comparator=function(t,i){var s=!!this.mirroring.get(t.cid),o=!!this.mirroring.get(i.cid);return!s&&o?-1:s&&!o?1:e.apply(this,arguments)},t.observe(this.get("selection"))},activate:function(){this.updateSelection(),this.frame.on("open",this.updateSelection,this),s.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.frame.off("open",this.updateSelection,this),s.controller.Library.prototype.deactivate.apply(this,arguments)},updateSelection:function(){var t,e=this.get("selection"),i=s.view.settings.post.featuredImageId;""!==i&&-1!==i&&(t=s.model.Attachment.get(i)).fetch(),e.reset(t?[t]:[])}}),s.controller.ReplaceImage=s.controller.Library.extend({defaults:e.defaults({id:"replace-image",title:i.replaceImageTitle,multiple:!1,filterable:"uploaded",toolbar:"replace",menu:!1,priority:60,syncSelection:!0},s.controller.Library.prototype.defaults),initialize:function(t){var e,i;this.image=t.image,this.get("library")||this.set("library",s.query({type:"image"})),s.controller.Library.prototype.initialize.apply(this,arguments),e=this.get("library"),i=e.comparator,e.comparator=function(t,e){var s=!!this.mirroring.get(t.cid),o=!!this.mirroring.get(e.cid);return!s&&o?-1:s&&!o?1:i.apply(this,arguments)},e.observe(this.get("selection"))},activate:function(){this.updateSelection(),s.controller.Library.prototype.activate.apply(this,arguments)},updateSelection:function(){var t=this.get("selection"),e=this.image.attachment;t.reset(e?[e]:[])}}),s.controller.EditImage=s.controller.State.extend({defaults:{id:"edit-image",title:i.editImage,menu:!1,toolbar:"edit-image",content:"edit-image",url:""},activate:function(){this.listenTo(this.frame,"toolbar:render:edit-image",this.toolbar)},deactivate:function(){this.stopListening(this.frame)},toolbar:function(){var t=this.frame,e=t.lastState(),o=e&&e.id;t.toolbar.set(new s.view.Toolbar({controller:t,items:{back:{style:"primary",text:i.back,priority:20,click:function(){o?t.setState(o):t.close()}}}}))}}),s.controller.MediaLibrary=s.controller.Library.extend({defaults:e.defaults({filterable:"uploaded",displaySettings:!1,priority:80,syncSelection:!1},s.controller.Library.prototype.defaults),initialize:function(t){this.media=t.media,this.type=t.type,this.set("library",s.query({type:this.type})),s.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){s.frame.lastMime&&(this.set("library",s.query({type:s.frame.lastMime})),delete s.frame.lastMime),s.controller.Library.prototype.activate.apply(this,arguments)}}),s.controller.Embed=s.controller.State.extend({defaults:{id:"embed",title:i.insertFromUrlTitle,content:"embed",menu:"default",toolbar:"main-embed",priority:120,type:"link",url:"",metadata:{}},sensitivity:200,initialize:function(t){this.metadata=t.metadata,this.debouncedScan=e.debounce(e.bind(this.scan,this),this.sensitivity),this.props=new Backbone.Model(this.metadata||{url:""}),this.props.on("change:url",this.debouncedScan,this),this.props.on("change:url",this.refresh,this),this.on("scan",this.scanImage,this)},scan:function(){var e,i=this,s={type:"link",scanners:[]};this.props.get("url")&&this.trigger("scan",s),s.scanners.length?(e=s.scanners=t.when.apply(t,s.scanners)).always(function(){i.get("scanners")===e&&i.set("loading",!1)}):s.scanners=null,s.loading=!!s.scanners,this.set(s)},scanImage:function(e){var i=this.frame,s=this,o=this.props.get("url"),n=new Image,r=t.Deferred();e.scanners.push(r.promise()),n.onload=function(){r.resolve(),s===i.state()&&o===s.props.get("url")&&(s.set({type:"image"}),s.props.set({width:n.width,height:n.height}))},n.onerror=r.reject,n.src=o},refresh:function(){this.frame.toolbar.get().refresh()},reset:function(){this.props.clear().set({url:""}),this.active&&this.refresh()}}),s.controller.Cropper=s.controller.State.extend({defaults:{id:"cropper",title:i.cropImage,toolbar:"crop",content:"crop",router:!1,canSkipCrop:!1},activate:function(){this.frame.on("content:create:crop",this.createCropContent,this),this.frame.on("close",this.removeCropper,this),this.set("selection",new Backbone.Collection(this.frame._selection.single))},deactivate:function(){this.frame.toolbar.mode("browse")},createCropContent:function(){this.cropperView=new wp.media.view.Cropper({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},removeCropper:function(){this.imgSelect.cancelSelection(),this.imgSelect.setOptions({remove:!0}),this.imgSelect.update(),this.cropperView.remove()},createCropToolbar:function(){var t,s;t=this.get("canSkipCrop")||!1,s={controller:this.frame,items:{insert:{style:"primary",text:i.cropImage,priority:80,requires:{library:!1,selection:!1},click:function(){var t=this,e=this.controller.state().get("selection").first();e.set({cropDetails:this.controller.state().imgSelect.getSelection()}),this.$el.text(i.cropping),this.$el.attr("disabled",!0),this.controller.state().doCrop(e).done(function(e){t.controller.trigger("cropped",e),t.controller.close()}).fail(function(){t.controller.trigger("content:error:crop")})}}}},t&&e.extend(s.items,{skip:{style:"secondary",text:i.skipCropping,priority:70,requires:{library:!1,selection:!1},click:function(){var t=this.controller.state().get("selection").first();this.controller.state().cropperView.remove(),this.controller.trigger("skippedcrop",t),this.controller.close()}}}),this.frame.toolbar.set(new wp.media.view.Toolbar(s))},doCrop:function(t){return wp.ajax.post("custom-header-crop",{nonce:t.get("nonces").edit,id:t.get("id"),cropDetails:t.get("cropDetails")})}}),s.View=wp.Backbone.View.extend({constructor:function(t){t&&t.controller&&(this.controller=t.controller),wp.Backbone.View.apply(this,arguments)},dispose:function(){return this.undelegateEvents(),this.model&&this.model.off&&this.model.off(null,null,this),this.collection&&this.collection.off&&this.collection.off(null,null,this),this.controller&&this.controller.off&&this.controller.off(null,null,this),this},remove:function(){return this.dispose(),wp.Backbone.View.prototype.remove.apply(this,arguments)}}),s.view.Frame=s.View.extend({initialize:function(){e.defaults(this.options,{mode:["select"]}),this._createRegions(),this._createStates(),this._createModes()},_createRegions:function(){this.regions=this.regions?this.regions.slice():[],e.each(this.regions,function(t){this[t]=new s.controller.Region({view:this,id:t,selector:".media-frame-"+t})},this)},_createStates:function(){this.states=new Backbone.Collection(null,{model:s.controller.State}),this.states.on("add",function(t){t.frame=this,t.trigger("ready")},this),this.options.states&&this.states.add(this.options.states)},_createModes:function(){this.activeModes=new Backbone.Collection,this.activeModes.on("add remove reset",e.bind(this.triggerModeEvents,this)),e.each(this.options.mode,function(t){this.activateMode(t)},this)},reset:function(){return this.states.invoke("trigger","reset"),this},triggerModeEvents:function(t,i,s){var o,n,r={add:"activate",remove:"deactivate"};e.each(s,function(t,e){t&&(o=e)}),e.has(r,o)&&(n=t.get("id")+":"+r[o],this.trigger(n))},activateMode:function(t){if(!this.isModeActive(t))return this.activeModes.add([{id:t}]),this.$el.addClass("mode-"+t),this},deactivateMode:function(t){return this.isModeActive(t)?(this.activeModes.remove(this.activeModes.where({id:t})),this.$el.removeClass("mode-"+t),this.trigger(t+":deactivate"),this):this},isModeActive:function(t){return Boolean(this.activeModes.where({id:t}).length)}}),e.extend(s.view.Frame.prototype,s.controller.StateMachine.prototype),s.view.MediaFrame=s.view.Frame.extend({className:"media-frame",template:s.template("media-frame"),regions:["menu","title","content","toolbar","router"],events:{"click div.media-frame-title h1":"toggleMenu"},initialize:function(){s.view.Frame.prototype.initialize.apply(this,arguments),e.defaults(this.options,{title:"",modal:!0,uploader:!0}),this.$el.addClass("wp-core-ui"),this.options.modal&&(this.modal=new s.view.Modal({controller:this,title:this.options.title}),this.modal.content(this)),!wp.Uploader.limitExceeded&&wp.Uploader.browser.supported||(this.options.uploader=!1),this.options.uploader&&(this.uploader=new s.view.UploaderWindow({controller:this,uploader:{dropzone:this.modal?this.modal.$el:this.$el,container:this.$el}}),this.views.set(".media-frame-uploader",this.uploader)),this.on("attach",e.bind(this.views.ready,this.views),this),this.on("title:create:default",this.createTitle,this),this.title.mode("default"),this.on("title:render",function(t){t.$el.append('<span class="dashicons dashicons-arrow-down"></span>')}),this.on("menu:create:default",this.createMenu,this)},render:function(){return!this.state()&&this.options.state&&this.setState(this.options.state),s.view.Frame.prototype.render.apply(this,arguments)},createTitle:function(t){t.view=new s.View({controller:this,tagName:"h1"})},createMenu:function(t){t.view=new s.view.Menu({controller:this})},toggleMenu:function(){this.$el.find(".media-menu").toggleClass("visible")},createToolbar:function(t){t.view=new s.view.Toolbar({controller:this})},createRouter:function(t){t.view=new s.view.Router({controller:this})},createIframeStates:function(i){var o,n=s.view.settings,r=n.tabs,a=n.tabUrl;r&&a&&((o=t("#post_ID")).length&&(a+="&post_id="+o.val()),e.each(r,function(t,s){this.state("iframe:"+s).set(e.defaults({tab:s,src:a+"&tab="+s,title:t,content:"iframe",menu:"default"},i))},this),this.on("content:create:iframe",this.iframeContent,this),this.on("menu:render:default",this.iframeMenu,this),this.on("open",this.hijackThickbox,this),this.on("close",this.restoreThickbox,this))},iframeContent:function(t){this.$el.addClass("hide-toolbar"),t.view=new s.view.Iframe({controller:this})},iframeMenu:function(t){var i={};t&&(e.each(s.view.settings.tabs,function(t,e){i["iframe:"+e]={text:this.state("iframe:"+e).get("title"),priority:200}},this),t.set(i))},hijackThickbox:function(){var t=this;window.tb_remove&&!this._tb_remove&&(this._tb_remove=window.tb_remove,window.tb_remove=function(){t.close(),t.reset(),t.setState(t.options.state),t._tb_remove.call(window)})},restoreThickbox:function(){this._tb_remove&&(window.tb_remove=this._tb_remove,delete this._tb_remove)}}),e.each(["open","close","attach","detach","escape"],function(t){s.view.MediaFrame.prototype[t]=function(){return this.modal&&this.modal[t].apply(this.modal,arguments),this}}),s.view.MediaFrame.Select=s.view.MediaFrame.extend({initialize:function(){s.view.MediaFrame.prototype.initialize.apply(this,arguments),e.defaults(this.options,{selection:[],library:{},multiple:!1,state:"library"}),this.createSelection(),this.createStates(),this.bindHandlers()},createSelection:function(){var t=this.options.selection;t instanceof s.model.Selection||(this.options.selection=new s.model.Selection(t,{multiple:this.options.multiple})),this._selection={attachments:new s.model.Attachments,difference:[]}},createStates:function(){var t=this.options;this.options.states||this.states.add([new s.controller.Library({library:s.query(t.library),multiple:t.multiple,title:t.title,priority:20})])},bindHandlers:function(){this.on("router:create:browse",this.createRouter,this),this.on("router:render:browse",this.browseRouter,this),this.on("content:create:browse",this.browseContent,this),this.on("content:render:upload",this.uploadContent,this),this.on("toolbar:create:select",this.createSelectToolbar,this)},browseRouter:function(t){t.set({upload:{text:i.uploadFilesTitle,priority:20},browse:{text:i.mediaLibraryTitle,priority:40}})},browseContent:function(t){var e=this.state();this.$el.removeClass("hide-toolbar"),t.view=new s.view.AttachmentsBrowser({controller:this,collection:e.get("library"),selection:e.get("selection"),model:e,sortable:e.get("sortable"),search:e.get("searchable"),filters:e.get("filterable"),display:e.has("display")?e.get("display"):e.get("displaySettings"),dragInfo:e.get("dragInfo"),idealColumnWidth:e.get("idealColumnWidth"),suggestedWidth:e.get("suggestedWidth"),suggestedHeight:e.get("suggestedHeight"),AttachmentView:e.get("AttachmentView")})},uploadContent:function(){this.$el.removeClass("hide-toolbar"),this.content.set(new s.view.UploaderInline({controller:this}))},createSelectToolbar:function(t,e){(e=e||this.options.button||{}).controller=this,t.view=new s.view.Toolbar.Select(e)}}),s.view.MediaFrame.Post=s.view.MediaFrame.Select.extend({initialize:function(){this.counts={audio:{count:s.view.settings.attachmentCounts.audio,state:"playlist"},video:{count:s.view.settings.attachmentCounts.video,state:"video-playlist"}},e.defaults(this.options,{multiple:!0,editing:!1,state:"insert",metadata:{}}),s.view.MediaFrame.Select.prototype.initialize.apply(this,arguments),this.createIframeStates()},createStates:function(){var t=this.options;this.states.add([new s.controller.Library({id:"insert",title:i.insertMediaTitle,priority:20,toolbar:"main-insert",filterable:"all",library:s.query(t.library),multiple:!!t.multiple&&"reset",editable:!0,allowLocalEdits:!0,displaySettings:!0,displayUserSettings:!0}),new s.controller.Library({id:"gallery",title:i.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:s.query(e.defaults({type:"image"},t.library))}),new s.controller.Embed({metadata:t.metadata}),new s.controller.EditImage({model:t.editImage}),new s.controller.GalleryEdit({library:t.selection,editing:t.editing,menu:"gallery"}),new s.controller.GalleryAdd,new s.controller.Library({id:"playlist",title:i.createPlaylistTitle,priority:60,toolbar:"main-playlist",filterable:"uploaded",multiple:"add",editable:!1,library:s.query(e.defaults({type:"audio"},t.library))}),new s.controller.CollectionEdit({type:"audio",collectionType:"playlist",title:i.editPlaylistTitle,SettingsView:s.view.Settings.Playlist,library:t.selection,editing:t.editing,menu:"playlist",dragInfoText:i.playlistDragInfo,dragInfo:!1}),new s.controller.CollectionAdd({type:"audio",collectionType:"playlist",title:i.addToPlaylistTitle}),new s.controller.Library({id:"video-playlist",title:i.createVideoPlaylistTitle,priority:60,toolbar:"main-video-playlist",filterable:"uploaded",multiple:"add",editable:!1,library:s.query(e.defaults({type:"video"},t.library))}),new s.controller.CollectionEdit({type:"video",collectionType:"playlist",title:i.editVideoPlaylistTitle,SettingsView:s.view.Settings.Playlist,library:t.selection,editing:t.editing,menu:"video-playlist",dragInfoText:i.videoPlaylistDragInfo,dragInfo:!1}),new s.controller.CollectionAdd({type:"video",collectionType:"playlist",title:i.addToVideoPlaylistTitle})]),s.view.settings.post.featuredImageId&&this.states.add(new s.controller.FeaturedImage)},bindHandlers:function(){var t;s.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("activate",this.activate,this),void 0!==e.find(this.counts,function(t){return 0===t.count})&&this.listenTo(s.model.Attachments.all,"change:type",this.mediaTypeCounts),this.on("menu:create:gallery",this.createMenu,this),this.on("menu:create:playlist",this.createMenu,this),this.on("menu:create:video-playlist",this.createMenu,this),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("toolbar:create:main-gallery",this.createToolbar,this),this.on("toolbar:create:main-playlist",this.createToolbar,this),this.on("toolbar:create:main-video-playlist",this.createToolbar,this),this.on("toolbar:create:featured-image",this.featuredImageToolbar,this),this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this),t={menu:{default:"mainMenu",gallery:"galleryMenu",playlist:"playlistMenu","video-playlist":"videoPlaylistMenu"},content:{embed:"embedContent","edit-image":"editImageContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar","main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar","main-playlist":"mainPlaylistToolbar","playlist-edit":"playlistEditToolbar","playlist-add":"playlistAddToolbar","main-video-playlist":"mainVideoPlaylistToolbar","video-playlist-edit":"videoPlaylistEditToolbar","video-playlist-add":"videoPlaylistAddToolbar"}},e.each(t,function(t,i){e.each(t,function(t,e){this.on(i+":render:"+e,this[t],this)},this)},this)},activate:function(){e.each(this.counts,function(t){t.count<1&&this.menuItemVisibility(t.state,"hide")},this)},mediaTypeCounts:function(t,e){void 0!==this.counts[e]&&this.counts[e].count<1&&(this.counts[e].count++,this.menuItemVisibility(this.counts[e].state,"show"))},mainMenu:function(t){t.set({"library-separator":new s.View({className:"separator",priority:100})})},menuItemVisibility:function(t,e){var i=this.menu.get();"hide"===e?i.hide(t):"show"===e&&i.show(t)},galleryMenu:function(t){var e=this.lastState(),o=e&&e.id,n=this;t.set({cancel:{text:i.cancelGalleryTitle,priority:20,click:function(){o?n.setState(o):n.close(),this.controller.modal.focusManager.focus()}},separateCancel:new s.View({className:"separator",priority:40})})},playlistMenu:function(t){var e=this.lastState(),o=e&&e.id,n=this;t.set({cancel:{text:i.cancelPlaylistTitle,priority:20,click:function(){o?n.setState(o):n.close()}},separateCancel:new s.View({className:"separator",priority:40})})},videoPlaylistMenu:function(t){var e=this.lastState(),o=e&&e.id,n=this;t.set({cancel:{text:i.cancelVideoPlaylistTitle,priority:20,click:function(){o?n.setState(o):n.close()}},separateCancel:new s.View({className:"separator",priority:40})})},embedContent:function(){var t=new s.view.Embed({controller:this,model:this.state()}).render();this.content.set(t),o||t.url.focus()},editSelectionContent:function(){var t,e=this.state(),o=e.get("selection");(t=new s.view.AttachmentsBrowser({controller:this,collection:o,selection:o,model:e,sortable:!0,search:!1,dragInfo:!0,AttachmentView:s.view.Attachment.EditSelection}).render()).toolbar.set("backToLibrary",{text:i.returnToLibrary,priority:-100,click:function(){this.controller.content.mode("browse")}}),this.content.set(t)},editImageContent:function(){var t=this.state().get("image"),e=new s.view.EditImage({model:t,controller:this}).render();this.content.set(e),e.loadEditor()},selectionStatusToolbar:function(t){var e=this.state().get("editable");t.set("selection",new s.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:e&&function(){this.controller.content.mode("edit-selection")}}).render())},mainInsertToolbar:function(t){var e=this;this.selectionStatusToolbar(t),t.set("insert",{style:"primary",priority:80,text:i.insertIntoPost,requires:{selection:!0},click:function(){var t=e.state(),i=t.get("selection");e.close(),t.trigger("insert",i).reset()}})},mainGalleryToolbar:function(t){var e=this;this.selectionStatusToolbar(t),t.set("gallery",{style:"primary",text:i.createNewGallery,priority:60,requires:{selection:!0},click:function(){var t=e.state().get("selection"),i=e.state("gallery-edit"),o=t.where({type:"image"});i.set("library",new s.model.Selection(o,{props:t.props.toJSON(),multiple:!0})),this.controller.setState("gallery-edit"),this.controller.modal.focusManager.focus()}})},mainPlaylistToolbar:function(t){var e=this;this.selectionStatusToolbar(t),t.set("playlist",{style:"primary",text:i.createNewPlaylist,priority:100,requires:{selection:!0},click:function(){var t=e.state().get("selection"),i=e.state("playlist-edit"),o=t.where({type:"audio"});i.set("library",new s.model.Selection(o,{props:t.props.toJSON(),multiple:!0})),this.controller.setState("playlist-edit"),this.controller.modal.focusManager.focus()}})},mainVideoPlaylistToolbar:function(t){var e=this;this.selectionStatusToolbar(t),t.set("video-playlist",{style:"primary",text:i.createNewVideoPlaylist,priority:100,requires:{selection:!0},click:function(){var t=e.state().get("selection"),i=e.state("video-playlist-edit"),o=t.where({type:"video"});i.set("library",new s.model.Selection(o,{props:t.props.toJSON(),multiple:!0})),this.controller.setState("video-playlist-edit"),this.controller.modal.focusManager.focus()}})},featuredImageToolbar:function(t){this.createSelectToolbar(t,{text:i.setFeaturedImage,state:this.options.state})},mainEmbedToolbar:function(t){t.view=new s.view.Toolbar.Embed({controller:this})},galleryEditToolbar:function(){var t=this.state().get("editing");this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:t?i.updateGallery:i.insertGallery,priority:80,requires:{library:!0},click:function(){var t=this.controller,e=t.state();t.close(),e.trigger("update",e.get("library")),t.setState(t.options.state),t.reset()}}}}))},galleryAddToolbar:function(){this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:i.addToGallery,priority:80,requires:{selection:!0},click:function(){var t=this.controller,e=t.state();t.state("gallery-edit").get("library").add(e.get("selection").models),e.trigger("reset"),t.setState("gallery-edit")}}}}))},playlistEditToolbar:function(){var t=this.state().get("editing");this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:t?i.updatePlaylist:i.insertPlaylist,priority:80,requires:{library:!0},click:function(){var t=this.controller,e=t.state();t.close(),e.trigger("update",e.get("library")),t.setState(t.options.state),t.reset()}}}}))},playlistAddToolbar:function(){this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:i.addToPlaylist,priority:80,requires:{selection:!0},click:function(){var t=this.controller,e=t.state();t.state("playlist-edit").get("library").add(e.get("selection").models),e.trigger("reset"),t.setState("playlist-edit")}}}}))},videoPlaylistEditToolbar:function(){var t=this.state().get("editing");this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:t?i.updateVideoPlaylist:i.insertVideoPlaylist,priority:140,requires:{library:!0},click:function(){var t=this.controller,e=t.state(),i=e.get("library");i.type="video",t.close(),e.trigger("update",i),t.setState(t.options.state),t.reset()}}}}))},videoPlaylistAddToolbar:function(){this.toolbar.set(new s.view.Toolbar({controller:this,items:{insert:{style:"primary",text:i.addToVideoPlaylist,priority:140,requires:{selection:!0},click:function(){var t=this.controller,e=t.state();t.state("video-playlist-edit").get("library").add(e.get("selection").models),e.trigger("reset"),t.setState("video-playlist-edit")}}}}))}}),s.view.MediaFrame.ImageDetails=s.view.MediaFrame.Select.extend({defaults:{id:"image",url:"",menu:"image-details",content:"image-details",toolbar:"image-details",type:"link",title:i.imageDetailsTitle,priority:120},initialize:function(t){this.image=new s.model.PostImage(t.metadata),this.options.selection=new s.model.Selection(this.image.attachment,{multiple:!1}),s.view.MediaFrame.Select.prototype.initialize.apply(this,arguments)},bindHandlers:function(){s.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("menu:create:image-details",this.createMenu,this),this.on("content:create:image-details",this.imageDetailsContent,this),this.on("content:render:edit-image",this.editImageContent,this),this.on("toolbar:render:image-details",this.renderImageDetailsToolbar,this),this.on("toolbar:render:replace",this.renderReplaceImageToolbar,this)},createStates:function(){this.states.add([new s.controller.ImageDetails({image:this.image,editable:!1}),new s.controller.ReplaceImage({id:"replace-image",library:s.query({type:"image"}),image:this.image,multiple:!1,title:i.imageReplaceTitle,toolbar:"replace",priority:80,displaySettings:!0}),new s.controller.EditImage({image:this.image,selection:this.options.selection})])},imageDetailsContent:function(t){t.view=new s.view.ImageDetails({controller:this,model:this.state().image,attachment:this.state().image.attachment})},editImageContent:function(){var t,e=this.state().get("image");e&&(t=new s.view.EditImage({model:e,controller:this}).render(),this.content.set(t),t.loadEditor())},renderImageDetailsToolbar:function(){this.toolbar.set(new s.view.Toolbar({controller:this,items:{select:{style:"primary",text:i.update,priority:80,click:function(){var t=this.controller,e=t.state();t.close(),e.trigger("update",t.image.toJSON()),t.setState(t.options.state),t.reset()}}}}))},renderReplaceImageToolbar:function(){var t=this,e=t.lastState(),o=e&&e.id;this.toolbar.set(new s.view.Toolbar({controller:this,items:{back:{text:i.back,priority:20,click:function(){o?t.setState(o):t.close()}},replace:{style:"primary",text:i.replace,priority:80,click:function(){var t=this.controller,e=t.state(),i=e.get("selection").single();t.close(),t.image.changeAttachment(i,e.display(i)),e.trigger("replace",t.image.toJSON()),t.setState(t.options.state),t.reset()}}}}))}}),s.view.Modal=s.View.extend({tagName:"div",template:s.template("media-modal"),attributes:{tabindex:0},events:{"click .media-modal-backdrop, .media-modal-close":"escapeHandler",keydown:"keydown"},initialize:function(){e.defaults(this.options,{container:document.body,title:"",propagate:!0,freeze:!0}),this.focusManager=new s.view.FocusManager({el:this.el})},prepare:function(){return{title:this.options.title}},attach:function(){return this.views.attached?this:(this.views.rendered||this.render(),this.$el.appendTo(this.options.container),this.views.attached=!0,this.views.ready(),this.propagate("attach"))},detach:function(){return this.$el.is(":visible")&&this.close(),this.$el.detach(),this.views.attached=!1,this.propagate("detach")},open:function(){var e,i=this.$el,s=this.options;return i.is(":visible")?this:(this.views.attached||this.attach(),s.freeze&&(this._freeze={scrollTop:t(window).scrollTop()}),t("body").addClass("modal-open"),i.show(),"ontouchend"in document&&(e=window.tinymce&&window.tinymce.activeEditor)&&!e.isHidden()&&e.iframeElement&&(e.iframeElement.focus(),e.iframeElement.blur(),setTimeout(function(){e.iframeElement.blur()},100)),this.$el.focus(),this.propagate("open"))},close:function(e){var i=this._freeze;return this.views.attached&&this.$el.is(":visible")?(t("body").removeClass("modal-open"),this.$el.hide().undelegate("keydown"),t("#wpbody-content").focus(),this.propagate("close"),i&&t(window).scrollTop(i.scrollTop),e&&e.escape&&this.propagate("escape"),this):this},escape:function(){return this.close({escape:!0})},escapeHandler:function(t){t.preventDefault(),this.escape()},content:function(t){return this.views.set(".media-modal-content",t),this},propagate:function(t){return this.trigger(t),this.options.propagate&&this.controller.trigger(t),this},keydown:function(t){27===t.which&&this.$el.is(":visible")&&(this.escape(),t.stopImmediatePropagation())}}),s.view.FocusManager=s.View.extend({events:{keydown:"constrainTabbing"},focus:function(){this.$(".media-menu-item").first().focus()},constrainTabbing:function(t){var e;if(9===t.keyCode)return(e=this.$(":tabbable")).last()[0]!==t.target||t.shiftKey?e.first()[0]===t.target&&t.shiftKey?(e.last().focus(),!1):void 0:(e.first().focus(),!1)}}),s.view.UploaderWindow=s.View.extend({tagName:"div",className:"uploader-window",template:s.template("uploader-window"),initialize:function(){var i;this.$browser=t('<a href="#" class="browser" />').hide().appendTo("body"),!(i=this.options.uploader=e.defaults(this.options.uploader||{},{dropzone:this.$el,browser:this.$browser,params:{}})).dropzone||i.dropzone instanceof t||(i.dropzone=t(i.dropzone)),this.controller.on("activate",this.refresh,this),this.controller.on("detach",function(){this.$browser.remove()},this)},refresh:function(){this.uploader&&this.uploader.refresh()},ready:function(){var i,o=s.view.settings.post.id;this.uploader||(o&&(this.options.uploader.params.post_id=o),this.uploader=new wp.Uploader(this.options.uploader),(i=this.uploader.dropzone).on("dropzone:enter",e.bind(this.show,this)),i.on("dropzone:leave",e.bind(this.hide,this)),t(this.uploader).on("uploader:ready",e.bind(this._ready,this)))},_ready:function(){this.controller.trigger("uploader:ready")},show:function(){var t=this.$el.show();e.defer(function(){t.css({opacity:1})})},hide:function(){var t=this.$el.css({opacity:0});s.transition(t).done(function(){"0"===t.css("opacity")&&t.hide()}),e.delay(function(){"0"===t.css("opacity")&&t.is(":visible")&&t.hide()},500)}}),s.view.EditorUploader=s.View.extend({tagName:"div",className:"uploader-editor",template:s.template("uploader-editor"),localDrag:!1,overContainer:!1,overDropzone:!1,draggingFile:null,initialize:function(){var i=this;return this.initialized=!1,window.tinyMCEPreInit&&window.tinyMCEPreInit.dragDropUpload&&this.browserSupport()?(this.$document=t(document),this.dropzones=[],this.files=[],this.$document.on("drop",".uploader-editor",e.bind(this.drop,this)),this.$document.on("dragover",".uploader-editor",e.bind(this.dropzoneDragover,this)),this.$document.on("dragleave",".uploader-editor",e.bind(this.dropzoneDragleave,this)),this.$document.on("click",".uploader-editor",e.bind(this.click,this)),this.$document.on("dragover",e.bind(this.containerDragover,this)),this.$document.on("dragleave",e.bind(this.containerDragleave,this)),this.$document.on("dragstart dragend drop",function(t){i.localDrag="dragstart"===t.type}),this.initialized=!0,this):this},browserSupport:function(){var t=!1,e=document.createElement("div");return t="draggable"in e||"ondragstart"in e&&"ondrop"in e,t=t&&!!(window.File&&window.FileList&&window.FileReader)},isDraggingFile:function(t){return null!==this.draggingFile?this.draggingFile:!e.isUndefined(t.originalEvent)&&!e.isUndefined(t.originalEvent.dataTransfer)&&(this.draggingFile=e.indexOf(t.originalEvent.dataTransfer.types,"Files")>-1&&-1===e.indexOf(t.originalEvent.dataTransfer.types,"text/plain"),this.draggingFile)},refresh:function(i){var s;for(s in this.dropzones)this.dropzones[s].toggle(this.overContainer||this.overDropzone);return e.isUndefined(i)||t(i.target).closest(".uploader-editor").toggleClass("droppable",this.overDropzone),this.overContainer||this.overDropzone||(this.draggingFile=null),this},render:function(){return this.initialized?(s.View.prototype.render.apply(this,arguments),t(".wp-editor-wrap, #wp-fullscreen-body").each(e.bind(this.attach,this)),this):this},attach:function(e,i){var s=this.$el.clone();return this.dropzones.push(s),t(i).append(s),this},drop:function(e){var i=null;if(this.containerDragleave(e),this.dropzoneDragleave(e),this.files=e.originalEvent.dataTransfer.files,!(this.files.length<1))return(i=t(e.target).parents(".wp-editor-wrap")).length>0&&i[0].id&&(window.wpActiveEditor=i[0].id.slice(3,-5)),this.workflow?(this.workflow.state().reset(),this.addFiles.apply(this),this.workflow.open()):(this.workflow=wp.media.editor.open("content",{frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0}),this.workflow.on("uploader:ready",this.addFiles,this)),!1},addFiles:function(){return this.files.length&&(this.workflow.uploader.uploader.uploader.addFile(e.toArray(this.files)),this.files=[]),this},containerDragover:function(t){!this.localDrag&&this.isDraggingFile(t)&&(this.overContainer=!0,this.refresh())},containerDragleave:function(){this.overContainer=!1,e.delay(e.bind(this.refresh,this),50)},dropzoneDragover:function(t){if(!this.localDrag&&this.isDraggingFile(t))return this.overDropzone=!0,this.refresh(t),!1},dropzoneDragleave:function(t){this.overDropzone=!1,e.delay(e.bind(this.refresh,this,t),50)},click:function(t){this.containerDragleave(t),this.dropzoneDragleave(t),this.localDrag=!1}}),s.view.UploaderInline=s.View.extend({tagName:"div",className:"uploader-inline",template:s.template("uploader-inline"),events:{"click .close":"hide"},initialize:function(){e.defaults(this.options,{message:"",status:!0,canClose:!1}),!this.options.$browser&&this.controller.uploader&&(this.options.$browser=this.controller.uploader.$browser),e.isUndefined(this.options.postId)&&(this.options.postId=s.view.settings.post.id),this.options.status&&this.views.set(".upload-inline-status",new s.view.UploaderStatus({controller:this.controller}))},prepare:function(){var t=this.controller.state().get("suggestedWidth"),e=this.controller.state().get("suggestedHeight"),i={};return i.message=this.options.message,i.canClose=this.options.canClose,t&&e&&(i.suggestedWidth=t,i.suggestedHeight=e),i},dispose:function(){return this.disposing?s.View.prototype.dispose.apply(this,arguments):(this.disposing=!0,this.remove())},remove:function(){var t=s.View.prototype.remove.apply(this,arguments);return e.defer(e.bind(this.refresh,this)),t},refresh:function(){var t=this.controller.uploader;t&&t.refresh()},ready:function(){var t,e=this.options.$browser;if(this.controller.uploader){if((t=this.$(".browser"))[0]===e[0])return;e.detach().text(t.text()),e[0].className=t[0].className,t.replaceWith(e.show())}return this.refresh(),this},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")}}),s.view.UploaderStatus=s.View.extend({className:"media-uploader-status",template:s.template("uploader-status"),events:{"click .upload-dismiss-errors":"dismiss"},initialize:function(){this.queue=wp.Uploader.queue,this.queue.on("add remove reset",this.visibility,this),this.queue.on("add remove reset change:percent",this.progress,this),this.queue.on("add remove reset change:uploading",this.info,this),this.errors=wp.Uploader.errors,this.errors.reset(),this.errors.on("add remove reset",this.visibility,this),this.errors.on("add",this.error,this)},dispose:function(){return wp.Uploader.queue.off(null,null,this),s.View.prototype.dispose.apply(this,arguments),this},visibility:function(){this.$el.toggleClass("uploading",!!this.queue.length),this.$el.toggleClass("errors",!!this.errors.length),this.$el.toggle(!!this.queue.length||!!this.errors.length)},ready:function(){e.each({$bar:".media-progress-bar div",$index:".upload-index",$total:".upload-total",$filename:".upload-filename"},function(t,e){this[e]=this.$(t)},this),this.visibility(),this.progress(),this.info()},progress:function(){var t=this.queue,i=this.$bar;i&&t.length&&i.width(t.reduce(function(t,i){if(!i.get("uploading"))return t+100;var s=i.get("percent");return t+(e.isNumber(s)?s:100)},0)/t.length+"%")},info:function(){var t,e=this.queue,i=0;e.length&&(t=this.queue.find(function(t,e){return i=e,t.get("uploading")}),this.$index.text(i+1),this.$total.text(e.length),this.$filename.html(t?this.filename(t.get("filename")):""))},filename:function(t){return s.truncate(e.escape(t),24)},error:function(t){this.views.add(".upload-errors",new s.view.UploaderStatusError({filename:this.filename(t.get("file").name),message:t.get("message")}),{at:0})},dismiss:function(t){var i=this.views.get(".upload-errors");t.preventDefault(),i&&e.invoke(i,"remove"),wp.Uploader.errors.reset()}}),s.view.UploaderStatusError=s.View.extend({className:"upload-error",template:s.template("uploader-status-error")}),s.view.Toolbar=s.View.extend({tagName:"div",className:"media-toolbar",initialize:function(){var t=this.controller.state(),e=this.selection=t.get("selection"),i=this.library=t.get("library");this._views={},this.primary=new s.view.PriorityList,this.secondary=new s.view.PriorityList,this.primary.$el.addClass("media-toolbar-primary search-form"),this.secondary.$el.addClass("media-toolbar-secondary"),this.views.set([this.secondary,this.primary]),this.options.items&&this.set(this.options.items,{silent:!0}),this.options.silent||this.render(),e&&e.on("add remove reset",this.refresh,this),i&&i.on("add remove reset",this.refresh,this)},dispose:function(){return this.selection&&this.selection.off(null,null,this),this.library&&this.library.off(null,null,this),s.View.prototype.dispose.apply(this,arguments)},ready:function(){this.refresh()},set:function(t,i,o){return o=o||{},e.isObject(t)?e.each(t,function(t,e){this.set(e,t,{silent:!0})},this):(i instanceof Backbone.View||(i.classes=["media-button-"+t].concat(i.classes||[]),i=new s.view.Button(i).render()),i.controller=i.controller||this.controller,this._views[t]=i,this[i.options.priority<0?"secondary":"primary"].set(t,i,o)),o.silent||this.refresh(),this},get:function(t){return this._views[t]},unset:function(t,e){return delete this._views[t],this.primary.unset(t,e),this.secondary.unset(t,e),e&&e.silent||this.refresh(),this},refresh:function(){var t=this.controller.state(),i=t.get("library"),s=t.get("selection");e.each(this._views,function(t){if(t.model&&t.options&&t.options.requires){var o=t.options.requires,n=!1;n=e.some(s.models,function(t){return!0===t.get("uploading")}),o.selection&&s&&!s.length?n=!0:o.library&&i&&!i.length&&(n=!0),t.model.set("disabled",n)}})}}),s.view.Toolbar.Select=s.view.Toolbar.extend({initialize:function(){var t=this.options;e.bindAll(this,"clickSelect"),e.defaults(t,{event:"select",state:!1,reset:!0,close:!0,text:i.select,requires:{selection:!0}}),t.items=e.defaults(t.items||{},{select:{style:"primary",text:t.text,priority:80,click:this.clickSelect,requires:t.requires}}),s.view.Toolbar.prototype.initialize.apply(this,arguments)},clickSelect:function(){var t=this.options,e=this.controller;t.close&&e.close(),t.event&&e.state().trigger(t.event),t.state&&e.setState(t.state),t.reset&&e.reset()}}),s.view.Toolbar.Embed=s.view.Toolbar.Select.extend({initialize:function(){e.defaults(this.options,{text:i.insertIntoPost,requires:!1}),s.view.Toolbar.Select.prototype.initialize.apply(this,arguments)},refresh:function(){var t=this.controller.state().props.get("url");this.get("select").model.set("disabled",!t||"http://"===t),s.view.Toolbar.Select.prototype.refresh.apply(this,arguments)}}),s.view.Button=s.View.extend({tagName:"a",className:"media-button",attributes:{href:"#"},events:{click:"click"},defaults:{text:"",style:"",size:"large",disabled:!1},initialize:function(){this.model=new Backbone.Model(this.defaults),e.each(this.defaults,function(t,i){var s=this.options[i];e.isUndefined(s)||(this.model.set(i,s),delete this.options[i])},this),this.model.on("change",this.render,this)},render:function(){var t=["button",this.className],i=this.model.toJSON();return i.style&&t.push("button-"+i.style),i.size&&t.push("button-"+i.size),t=e.uniq(t.concat(this.options.classes)),this.el.className=t.join(" "),this.$el.attr("disabled",i.disabled),this.$el.text(this.model.get("text")),this},click:function(t){"#"===this.attributes.href&&t.preventDefault(),this.options.click&&!this.model.get("disabled")&&this.options.click.apply(this,arguments)}}),s.view.ButtonGroup=s.View.extend({tagName:"div",className:"button-group button-large media-button-group",initialize:function(){this.buttons=e.map(this.options.buttons||[],function(t){return t instanceof Backbone.View?t:new s.view.Button(t).render()}),delete this.options.buttons,this.options.classes&&this.$el.addClass(this.options.classes)},render:function(){return this.$el.html(t(e.pluck(this.buttons,"el")).detach()),this}}),s.view.PriorityList=s.View.extend({tagName:"div",initialize:function(){this._views={},this.set(e.extend({},this._views,this.options.views),{silent:!0}),delete this.options.views,this.options.silent||this.render()},set:function(t,i,s){var o,n,r;return s=s||{},e.isObject(t)?(e.each(t,function(t,e){this.set(e,t)},this),this):(i instanceof Backbone.View||(i=this.toView(i,t,s)),i.controller=i.controller||this.controller,this.unset(t),o=i.options.priority||10,n=this.views.get()||[],e.find(n,function(t,e){if(t.options.priority>o)return r=e,!0}),this._views[t]=i,this.views.add(i,{at:e.isNumber(r)?r:n.length||0}),this)},get:function(t){return this._views[t]},unset:function(t){var e=this.get(t);return e&&e.remove(),delete this._views[t],this},toView:function(t){return new s.View(t)}}),s.view.MenuItem=s.View.extend({tagName:"a",className:"media-menu-item",attributes:{href:"#"},events:{click:"_click"},_click:function(e){var i=this.options.click;e&&e.preventDefault(),i?i.call(this):this.click(),o||t(".media-frame-content input").first().focus()},click:function(){var t=this.options.state;t&&(this.controller.setState(t),this.views.parent.$el.removeClass("visible"))},render:function(){var t=this.options;return t.text?this.$el.text(t.text):t.html&&this.$el.html(t.html),this}}),s.view.Menu=s.view.PriorityList.extend({tagName:"div",className:"media-menu",property:"state",ItemView:s.view.MenuItem,region:"menu",toView:function(t,e){return t=t||{},t[this.property]=t[this.property]||e,new this.ItemView(t).render()},ready:function(){s.view.PriorityList.prototype.ready.apply(this,arguments),this.visibility()},set:function(){s.view.PriorityList.prototype.set.apply(this,arguments),this.visibility()},unset:function(){s.view.PriorityList.prototype.unset.apply(this,arguments),this.visibility()},visibility:function(){var t=this.region,e=this.controller[t].get(),i=this.views.get(),s=!i||i.length<2;this===e&&this.controller.$el.toggleClass("hide-"+t,s)},select:function(t){var e=this.get(t);e&&(this.deselect(),e.$el.addClass("active"))},deselect:function(){this.$el.children().removeClass("active")},hide:function(t){var e=this.get(t);e&&e.$el.addClass("hidden")},show:function(t){var e=this.get(t);e&&e.$el.removeClass("hidden")}}),s.view.RouterItem=s.view.MenuItem.extend({click:function(){var t=this.options.contentMode;t&&this.controller.content.mode(t)}}),s.view.Router=s.view.Menu.extend({tagName:"div",className:"media-router",property:"contentMode",ItemView:s.view.RouterItem,region:"router",initialize:function(){this.controller.on("content:render",this.update,this),s.view.Menu.prototype.initialize.apply(this,arguments)},update:function(){var t=this.controller.content.mode();t&&this.select(t)}}),s.view.Sidebar=s.view.PriorityList.extend({className:"media-sidebar"}),s.view.Attachment=s.View.extend({tagName:"li",className:"attachment",template:s.template("attachment"),attributes:function(){return{tabIndex:0,role:"checkbox","aria-label":this.model.get("title"),"aria-checked":!1,"data-id":this.model.get("id")}},events:{"click .js--select-attachment":"toggleSelectionHandler","change [data-setting]":"updateSetting","change [data-setting] input":"updateSetting","change [data-setting] select":"updateSetting","change [data-setting] textarea":"updateSetting","click .close":"removeFromLibrary","click .check":"checkClickHandler","click a":"preventDefault",keydown:"toggleSelectionHandler"},buttons:{},initialize:function(){var t=this.options.selection;e.defaults(this.options,{rerenderOnModelChange:!0}).rerenderOnModelChange?this.model.on("change",this.render,this):this.model.on("change:percent",this.progress,this),this.model.on("change:title",this._syncTitle,this),this.model.on("change:caption",this._syncCaption,this),this.model.on("change:artist",this._syncArtist,this),this.model.on("change:album",this._syncAlbum,this),this.model.on("add",this.select,this),this.model.on("remove",this.deselect,this),t&&(t.on("reset",this.updateSelect,this),this.model.on("selection:single selection:unsingle",this.details,this),this.details(this.model,this.controller.state().get("selection")))},dispose:function(){var t=this.options.selection;return this.updateAll(),t&&t.off(null,null,this),s.View.prototype.dispose.apply(this,arguments),this},render:function(){var t=e.defaults(this.model.toJSON(),{orientation:"landscape",uploading:!1,type:"",subtype:"",icon:"",filename:"",caption:"",title:"",dateFormatted:"",width:"",height:"",compat:!1,alt:"",description:""},this.options);return t.buttons=this.buttons,t.describe=this.controller.state().get("describe"),"image"===t.type&&(t.size=this.imageSize()),t.can={},t.nonces&&(t.can.remove=!!t.nonces.delete,t.can.save=!!t.nonces.update),this.controller.state().get("allowLocalEdits")&&(t.allowLocalEdits=!0),t.uploading&&!t.percent&&(t.percent=0),this.views.detach(),this.$el.html(this.template(t)),this.$el.toggleClass("uploading",t.uploading),t.uploading?this.$bar=this.$(".media-progress-bar div"):delete this.$bar,this.updateSelect(),this.updateSave(),this.views.render(),this},progress:function(){this.$bar&&this.$bar.length&&this.$bar.width(this.model.get("percent")+"%")},toggleSelectionHandler:function(t){var e;if("INPUT"!==t.target.nodeName)if(37!==t.keyCode&&38!==t.keyCode&&39!==t.keyCode&&40!==t.keyCode){if("keydown"!==t.type||13===t.keyCode||32===t.keyCode){if(this.controller.isModeActive("grid")){if(this.controller.isModeActive("edit"))return this.controller.trigger("edit:attachment",this.model,t.currentTarget),void t.stopPropagation();this.controller.isModeActive("select")&&(e="toggle")}t.shiftKey?e="between":(t.ctrlKey||t.metaKey)&&(e="toggle"),this.toggleSelection({method:e}),this.controller.trigger("selection:toggle"),t.stopPropagation()}}else this.controller.trigger("attachment:keydown:arrow",t)},toggleSelection:function(t){var i,s,o,n,r=this.collection,a=this.options.selection,l=this.model,h=t&&t.method;if(a){if(i=a.single(),"between"===(h=e.isUndefined(h)?a.multiple:h)&&i&&a.multiple){if(i===l)return;return o=r.indexOf(i),n=r.indexOf(this.model),s=o<n?r.models.slice(o,n+1):r.models.slice(n,o+1),a.add(s),void a.single(l)}if("toggle"===h)return a[this.selected()?"remove":"add"](l),void a.single(l);if("add"===h)return a.add(l),void a.single(l);h||(h="add"),"add"!==h&&(h="reset"),this.selected()?a[i===l?"remove":"single"](l):(a[h](l),a.single(l))}},updateSelect:function(){this[this.selected()?"select":"deselect"]()},selected:function(){var t=this.options.selection;if(t)return!!t.get(this.model.cid)},select:function(t,e){var i=this.options.selection,s=this.controller;!i||e&&e!==i||this.$el.hasClass("selected")||(this.$el.addClass("selected").attr("aria-checked",!0),s.isModeActive("grid")&&s.isModeActive("select")||this.$(".check").attr("tabindex","0"))},deselect:function(t,e){var i=this.options.selection;!i||e&&e!==i||this.$el.removeClass("selected").attr("aria-checked",!1).find(".check").attr("tabindex","-1")},details:function(t,e){var i,s=this.options.selection;s===e&&(i=s.single(),this.$el.toggleClass("details",i===this.model))},preventDefault:function(t){t.preventDefault()},imageSize:function(t){var i=this.model.get("sizes");return t=t||"medium",i&&i[t]?e.clone(i[t]):{url:this.model.get("url"),width:this.model.get("width"),height:this.model.get("height"),orientation:this.model.get("orientation")}},updateSetting:function(e){var i,s,o=t(e.target).closest("[data-setting]");o.length&&(i=o.data("setting"),s=e.target.value,this.model.get(i)!==s&&this.save(i,s))},save:function(){var e=this,i=this._save=this._save||{status:"ready"},s=this.model.save.apply(this.model,arguments),o=i.requests?t.when(s,i.requests):s;i.savedTimer&&clearTimeout(i.savedTimer),this.updateSave("waiting"),i.requests=o,o.always(function(){i.requests===o&&(e.updateSave("resolved"===o.state()?"complete":"error"),i.savedTimer=setTimeout(function(){e.updateSave("ready"),delete i.savedTimer},2e3))})},updateSave:function(t){var e=this._save=this._save||{status:"ready"};return t&&t!==e.status&&(this.$el.removeClass("save-"+e.status),e.status=t),this.$el.addClass("save-"+e.status),this},updateAll:function(){var i,s=this.$("[data-setting]"),o=this.model;i=e.chain(s).map(function(e){var i,s,n=t("input, textarea, select, [value]",e);if(n.length)return i=t(e).data("setting"),s=n.val(),o.get(i)!==s?[i,s]:void 0}).compact().object().value(),e.isEmpty(i)||o.save(i)},removeFromLibrary:function(t){t.stopPropagation(),this.collection.remove(this.model)},checkClickHandler:function(t){var e=this.options.selection;e&&(t.stopPropagation(),e.where({id:this.model.get("id")}).length?(e.remove(this.model),this.$el.focus()):e.add(this.model))}}),e.each({caption:"_syncCaption",title:"_syncTitle",artist:"_syncArtist",album:"_syncAlbum"},function(t,e){s.view.Attachment.prototype[t]=function(t,i){var s=this.$('[data-setting="'+e+'"]');return s.length?i===s.find("input, textarea, select, [value]").val()?this:this.render():this}}),s.view.Attachment.Library=s.view.Attachment.extend({buttons:{check:!0}}),s.view.Attachment.EditLibrary=s.view.Attachment.extend({buttons:{close:!0}}),s.view.Attachments=s.View.extend({tagName:"ul",className:"attachments",attributes:{tabIndex:-1},initialize:function(){this.el.id=e.uniqueId("__attachments-view-"),e.defaults(this.options,{refreshSensitivity:o?300:200,refreshThreshold:3,AttachmentView:s.view.Attachment,sortable:!1,resize:!0,idealColumnWidth:t(window).width()<640?135:150}),this._viewsByCid={},this.$window=t(window),this.resizeEvent="resize.media-modal-columns",this.collection.on("add",function(t){this.views.add(this.createAttachmentView(t),{at:this.collection.indexOf(t)})},this),this.collection.on("remove",function(t){var e=this._viewsByCid[t.cid];delete this._viewsByCid[t.cid],e&&e.remove()},this),this.collection.on("reset",this.render,this),this.listenTo(this.controller,"library:selection:add",this.attachmentFocus),this.scroll=e.chain(this.scroll).bind(this).throttle(this.options.refreshSensitivity).value(),this.options.scrollElement=this.options.scrollElement||this.el,t(this.options.scrollElement).on("scroll",this.scroll),this.initSortable(),e.bindAll(this,"setColumns"),this.options.resize&&(this.on("ready",this.bindEvents),this.controller.on("open",this.setColumns),e.defer(this.setColumns,this))},bindEvents:function(){this.$window.off(this.resizeEvent).on(this.resizeEvent,e.debounce(this.setColumns,50))},attachmentFocus:function(){this.$("li:first").focus()},restoreFocus:function(){this.$("li.selected:first").focus()},arrowEvent:function(t){var e=this.$el.children("li"),i=this.columns,s=e.filter(":focus").index(),o=s+1<=i?1:Math.ceil((s+1)/i);if(-1!==s){if(37===t.keyCode){if(0===s)return;e.eq(s-1).focus()}if(38===t.keyCode){if(1===o)return;e.eq(s-i).focus()}if(39===t.keyCode){if(e.length===s)return;e.eq(s+1).focus()}if(40===t.keyCode){if(Math.ceil(e.length/i)===o)return;e.eq(s+i).focus()}}},dispose:function(){this.collection.props.off(null,null,this),this.options.resize&&this.$window.off(this.resizeEvent),s.View.prototype.dispose.apply(this,arguments)},setColumns:function(){var t=this.columns,e=this.$el.width();e&&(this.columns=Math.min(Math.round(e/this.options.idealColumnWidth),12)||1,t&&t===this.columns||this.$el.closest(".media-frame-content").attr("data-columns",this.columns))},initSortable:function(){var i=this.collection;!o&&this.options.sortable&&t.fn.sortable&&(this.$el.sortable(e.extend({disabled:!!i.comparator,containment:this.$el,tolerance:"pointer",start:function(t,e){e.item.data("sortableIndexStart",e.item.index())},update:function(t,e){var s=i.at(e.item.data("sortableIndexStart")),o=i.comparator;delete i.comparator,i.remove(s,{silent:!0}),i.add(s,{silent:!0,at:e.item.index()}),i.comparator=o,i.trigger("reset",i),i.saveMenuOrder()}},this.options.sortable)),i.props.on("change:orderby",function(){this.$el.sortable("option","disabled",!!i.comparator)},this),this.collection.props.on("change:orderby",this.refreshSortable,this),this.refreshSortable())},refreshSortable:function(){if(!o&&this.options.sortable&&t.fn.sortable){var e=this.collection,i="menuOrder"===e.props.get("orderby")||!e.comparator;this.$el.sortable("option","disabled",!i)}},createAttachmentView:function(t){var e=new this.options.AttachmentView({controller:this.controller,model:t,collection:this.collection,selection:this.options.selection});return this._viewsByCid[t.cid]=e},prepare:function(){this.collection.length?this.views.set(this.collection.map(this.createAttachmentView,this)):(this.views.unset(),this.collection.more().done(this.scroll))},ready:function(){this.scroll()},scroll:function(){var e,i=this,s=this.options.scrollElement,o=s.scrollTop;s==document&&(s=document.body,o=t(document).scrollTop()),t(s).is(":visible")&&this.collection.hasMore()&&(e=this.views.parent.toolbar,s.scrollHeight-(o+s.clientHeight)<s.clientHeight/3&&e.get("spinner").show(),s.scrollHeight<o+s.clientHeight*this.options.refreshThreshold&&this.collection.more().done(function(){i.scroll(),e.get("spinner").hide()}))}}),s.view.Search=s.View.extend({tagName:"input",className:"search",id:"media-search-input",attributes:{type:"search",placeholder:i.search},events:{input:"search",keyup:"search",change:"search",search:"search"},render:function(){return this.el.value=this.model.escape("search"),this},search:function(t){t.target.value?this.model.set("search",t.target.value):this.model.unset("search")}}),s.view.AttachmentFilters=s.View.extend({tagName:"select",className:"attachment-filters",id:"media-attachment-filters",events:{change:"change"},keys:[],initialize:function(){this.createFilters(),e.extend(this.filters,this.options.filters),this.$el.html(e.chain(this.filters).map(function(e,i){return{el:t("<option></option>").val(i).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value()),this.model.on("change",this.select,this),this.select()},createFilters:function(){this.filters={}},change:function(){var t=this.filters[this.el.value];t&&this.model.set(t.props)},select:function(){var t="all",i=this.model.toJSON();e.find(this.filters,function(s,o){if(e.all(s.props,function(t,s){return t===(e.isUndefined(i[s])?null:i[s])}))return t=o}),this.$el.val(t)}}),s.view.AttachmentFilters.Uploaded=s.view.AttachmentFilters.extend({createFilters:function(){var t,e=this.model.get("type"),o=s.view.settings.mimeTypes;o&&e&&(t=o[e]),this.filters={all:{text:t||i.allMediaItems,props:{uploadedTo:null,orderby:"date",order:"DESC"},priority:10},uploaded:{text:i.uploadedToThisPost,props:{uploadedTo:s.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20}}}}),s.view.AttachmentFilters.All=s.view.AttachmentFilters.extend({createFilters:function(){var t={};e.each(s.view.settings.mimeTypes||{},function(e,i){t[i]={text:e,props:{status:null,type:i,uploadedTo:null,orderby:"date",order:"DESC"}}}),t.all={text:i.allMediaItems,props:{status:null,type:null,uploadedTo:null,orderby:"date",order:"DESC"},priority:10},s.view.settings.post.id&&(t.uploaded={text:i.uploadedToThisPost,props:{status:null,type:null,uploadedTo:s.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20}),t.unattached={text:i.unattached,props:{status:null,uploadedTo:0,type:null,orderby:"menuOrder",order:"ASC"},priority:50},s.view.settings.mediaTrash&&this.controller.isModeActive("grid")&&(t.trash={text:i.trash,props:{uploadedTo:null,status:"trash",type:null,orderby:"date",order:"DESC"},priority:50}),this.filters=t}}),s.view.AttachmentsBrowser=s.View.extend({tagName:"div",className:"attachments-browser",initialize:function(){e.defaults(this.options,{filters:!1,search:!0,display:!1,sidebar:!0,AttachmentView:s.view.Attachment.Library}),this.listenTo(this.controller,"toggle:upload:attachment",e.bind(this.toggleUploader,this)),this.createToolbar(),this.options.sidebar&&this.createSidebar(),this.createUploader(),this.createAttachments(),this.updateContent(),this.options.sidebar&&"errors"!==this.options.sidebar||(this.$el.addClass("hide-sidebar"),"errors"===this.options.sidebar&&this.$el.addClass("sidebar-for-errors")),this.collection.on("add remove reset",this.updateContent,this)},dispose:function(){return this.options.selection.off(null,null,this),s.View.prototype.dispose.apply(this,arguments),this},createToolbar:function(){var e,o,n;n={controller:this.controller},this.controller.isModeActive("grid")&&(n.className="media-toolbar wp-filter"),this.toolbar=new s.view.Toolbar(n),this.views.add(this.toolbar),this.toolbar.set("spinner",new s.view.Spinner({priority:-60})),-1!==t.inArray(this.options.filters,["uploaded","all"])&&(this.toolbar.set("filtersLabel",new s.view.Label({value:i.filterByType,attributes:{for:"media-attachment-filters"},priority:-80}).render()),"uploaded"===this.options.filters?this.toolbar.set("filters",new s.view.AttachmentFilters.Uploaded({controller:this.controller,model:this.collection.props,priority:-80}).render()):(o=new s.view.AttachmentFilters.All({controller:this.controller,model:this.collection.props,priority:-80}),this.toolbar.set("filters",o.render()))),this.controller.isModeActive("grid")&&(e=s.View.extend({className:"view-switch media-grid-view-switch",template:s.template("media-library-view-switcher")}),this.toolbar.set("libraryViewSwitcher",new e({controller:this.controller,priority:-90}).render()),this.toolbar.set("dateFilterLabel",new s.view.Label({value:i.filterByDate,attributes:{for:"media-attachment-date-filters"},priority:-75}).render()),this.toolbar.set("dateFilter",new s.view.DateFilter({controller:this.controller,model:this.collection.props,priority:-75}).render()),this.toolbar.set("selectModeToggleButton",new s.view.SelectModeToggleButton({text:i.bulkSelect,controller:this.controller,priority:-70}).render()),this.toolbar.set("deleteSelectedButton",new s.view.DeleteSelectedButton({filters:o,style:"primary",disabled:!0,text:s.view.settings.mediaTrash?i.trashSelected:i.deleteSelected,controller:this.controller,priority:-60,click:function(){var e,o=[],n=this,r=this.controller.state().get("selection"),a=this.controller.state().get("library");if(r.length&&(s.view.settings.mediaTrash||confirm(i.warnBulkDelete))&&(!s.view.settings.mediaTrash||"trash"===r.at(0).get("status")||confirm(i.warnBulkTrash))){for(;r.length>0;)e=r.at(0),s.view.settings.mediaTrash&&"trash"===e.get("status")?(e.set("status","inherit"),o.push(e.save()),r.remove(e)):s.view.settings.mediaTrash?(e.set("status","trash"),o.push(e.save()),r.remove(e)):e.destroy();o.length?t.when.apply(null,o).then(function(){a._requery(!0),n.controller.trigger("selection:action:done")}):this.controller.trigger("selection:action:done")}}}).render())),this.options.search&&(this.toolbar.set("searchLabel",new s.view.Label({value:i.searchMediaLabel,attributes:{for:"media-search-input"},priority:60}).render()),this.toolbar.set("search",new s.view.Search({controller:this.controller,model:this.collection.props,priority:60}).render())),this.options.dragInfo&&this.toolbar.set("dragInfo",new s.View({el:t('<div class="instructions">'+i.dragInfo+"</div>")[0],priority:-40})),this.options.suggestedWidth&&this.options.suggestedHeight&&this.toolbar.set("suggestedDimensions",new s.View({el:t('<div class="instructions">'+i.suggestedDimensions+" "+this.options.suggestedWidth+" &times; "+this.options.suggestedHeight+"</div>")[0],priority:-40}))},updateContent:function(){var t,e=this;t=this.controller.isModeActive("grid")?e.attachmentsNoResults:e.uploader,this.collection.length?(t.$el.addClass("hidden"),e.toolbar.get("spinner").hide()):(this.toolbar.get("spinner").show(),this.dfd=this.collection.more().done(function(){e.collection.length?t.$el.addClass("hidden"):t.$el.removeClass("hidden"),e.toolbar.get("spinner").hide()}))},createUploader:function(){this.uploader=new s.view.UploaderInline({controller:this.controller,status:!1,message:this.controller.isModeActive("grid")?"":i.noItemsFound,canClose:this.controller.isModeActive("grid")}),this.uploader.hide(),this.views.add(this.uploader)},toggleUploader:function(){this.uploader.$el.hasClass("hidden")?this.uploader.show():this.uploader.hide()},createAttachments:function(){this.attachments=new s.view.Attachments({controller:this.controller,collection:this.collection,selection:this.options.selection,model:this.model,sortable:this.options.sortable,scrollElement:this.options.scrollElement,idealColumnWidth:this.options.idealColumnWidth,AttachmentView:this.options.AttachmentView}),this.attachments.listenTo(this.controller,"attachment:keydown:arrow",this.attachments.arrowEvent),this.attachments.listenTo(this.controller,"attachment:details:shift-tab",this.attachments.restoreFocus),this.views.add(this.attachments),this.controller.isModeActive("grid")&&(this.attachmentsNoResults=new s.View({controller:this.controller,tagName:"p"}),this.attachmentsNoResults.$el.addClass("hidden no-media"),this.attachmentsNoResults.$el.html(i.noMedia),this.views.add(this.attachmentsNoResults))},createSidebar:function(){var t=this.options.selection,e=this.sidebar=new s.view.Sidebar({controller:this.controller});this.views.add(e),this.controller.uploader&&e.set("uploads",new s.view.UploaderStatus({controller:this.controller,priority:40})),t.on("selection:single",this.createSingle,this),t.on("selection:unsingle",this.disposeSingle,this),t.single()&&this.createSingle()},createSingle:function(){var t=this.sidebar,e=this.options.selection.single();t.set("details",new s.view.Attachment.Details({controller:this.controller,model:e,priority:80})),t.set("compat",new s.view.AttachmentCompat({controller:this.controller,model:e,priority:120})),this.options.display&&t.set("display",new s.view.Settings.AttachmentDisplay({controller:this.controller,model:this.model.display(e),attachment:e,priority:160,userSettings:this.model.get("displayUserSettings")})),"insert"===this.model.id&&t.$el.addClass("visible")},disposeSingle:function(){var t=this.sidebar;t.unset("details"),t.unset("compat"),t.unset("display"),t.$el.removeClass("visible")}}),s.view.Selection=s.View.extend({tagName:"div",className:"media-selection",template:s.template("media-selection"),events:{"click .edit-selection":"edit","click .clear-selection":"clear"},initialize:function(){e.defaults(this.options,{editable:!1,clearable:!0}),this.attachments=new s.view.Attachments.Selection({controller:this.controller,collection:this.collection,selection:this.collection,model:new Backbone.Model}),this.views.set(".selection-view",this.attachments),this.collection.on("add remove reset",this.refresh,this),this.controller.on("content:activate",this.refresh,this)},ready:function(){this.refresh()},refresh:function(){if(this.$el.children().length){var t=this.collection,e="edit-selection"===this.controller.content.mode();this.$el.toggleClass("empty",!t.length),this.$el.toggleClass("one",1===t.length),this.$el.toggleClass("editing",e),this.$(".count").text(i.selected.replace("%d",t.length))}},edit:function(t){t.preventDefault(),this.options.editable&&this.options.editable.call(this,this.collection)},clear:function(t){t.preventDefault(),this.collection.reset(),this.controller.modal.focusManager.focus()}}),s.view.Attachment.Selection=s.view.Attachment.extend({className:"attachment selection",toggleSelection:function(){this.options.selection.single(this.model)}}),s.view.Attachments.Selection=s.view.Attachments.extend({events:{},initialize:function(){return e.defaults(this.options,{sortable:!0,resize:!1,AttachmentView:s.view.Attachment.Selection}),s.view.Attachments.prototype.initialize.apply(this,arguments)}}),s.view.Attachment.EditSelection=s.view.Attachment.Selection.extend({buttons:{close:!0}}),s.view.Settings=s.View.extend({events:{"click button":"updateHandler","change input":"updateHandler","change select":"updateHandler","change textarea":"updateHandler"},initialize:function(){this.model=this.model||new Backbone.Model,this.model.on("change",this.updateChanges,this)},prepare:function(){return e.defaults({model:this.model.toJSON()},this.options)},render:function(){return s.View.prototype.render.apply(this,arguments),e(this.model.attributes).chain().keys().each(this.update,this),this},update:function(t){var e,i=this.model.get(t),s=this.$('[data-setting="'+t+'"]');s.length&&(s.is("select")?(e=s.find('[value="'+i+'"]')).length?(s.find("option").prop("selected",!1),e.prop("selected",!0)):this.model.set(t,s.find(":selected").val()):s.hasClass("button-group")?s.find("button").removeClass("active").filter('[value="'+i+'"]').addClass("active"):s.is('input[type="text"], textarea')?s.is(":focus")||s.val(i):s.is('input[type="checkbox"]')&&s.prop("checked",!!i&&"false"!==i))},updateHandler:function(e){var i,s=t(e.target).closest("[data-setting]"),o=e.target.value;e.preventDefault(),s.length&&(s.is('input[type="checkbox"]')&&(o=s[0].checked),this.model.set(s.data("setting"),o),(i=s.data("userSetting"))&&setUserSetting(i,o))},updateChanges:function(t){t.hasChanged()&&e(t.changed).chain().keys().each(this.update,this)}}),s.view.Settings.AttachmentDisplay=s.view.Settings.extend({className:"attachment-display-settings",template:s.template("attachment-display-settings"),initialize:function(){var t=this.options.attachment;e.defaults(this.options,{userSettings:!1}),s.view.Settings.prototype.initialize.apply(this,arguments),this.model.on("change:link",this.updateLinkTo,this),t&&t.on("change:uploading",this.render,this)},dispose:function(){var t=this.options.attachment;t&&t.off(null,null,this),s.view.Settings.prototype.dispose.apply(this,arguments)},render:function(){var t=this.options.attachment;return t&&e.extend(this.options,{sizes:t.get("sizes"),type:t.get("type")}),s.view.Settings.prototype.render.call(this),this.updateLinkTo(),this},updateLinkTo:function(){var t=this.model.get("link"),e=this.$(".link-to-custom"),i=this.options.attachment;"none"===t||"embed"===t||!i&&"custom"!==t?e.addClass("hidden"):(i&&("post"===t?e.val(i.get("link")):"file"===t?e.val(i.get("url")):this.model.get("linkUrl")||e.val("http://"),e.prop("readonly","custom"!==t)),e.removeClass("hidden"),!o&&e.is(":visible")&&e.focus()[0].select())}}),s.view.Settings.Gallery=s.view.Settings.extend({className:"collection-settings gallery-settings",template:s.template("gallery-settings")}),s.view.Settings.Playlist=s.view.Settings.extend({className:"collection-settings playlist-settings",template:s.template("playlist-settings")}),s.view.Attachment.Details=s.view.Attachment.extend({tagName:"div",className:"attachment-details",template:s.template("attachment-details"),events:{"change [data-setting]":"updateSetting","change [data-setting] input":"updateSetting","change [data-setting] select":"updateSetting","change [data-setting] textarea":"updateSetting","click .delete-attachment":"deleteAttachment","click .trash-attachment":"trashAttachment","click .untrash-attachment":"untrashAttachment","click .edit-attachment":"editAttachment","click .refresh-attachment":"refreshAttachment",keydown:"toggleSelectionHandler"},initialize:function(){this.options=e.defaults(this.options,{rerenderOnModelChange:!1}),this.on("ready",this.initialFocus),s.view.Attachment.prototype.initialize.apply(this,arguments)},initialFocus:function(){o||this.$(":input").eq(0).focus()},deleteAttachment:function(t){t.preventDefault(),confirm(i.warnDelete)&&(this.model.destroy(),this.controller.modal.focusManager.focus())},trashAttachment:function(t){var e=this.controller.library;t.preventDefault(),s.view.settings.mediaTrash&&"edit-metadata"===this.controller.content.mode()?(this.model.set("status","trash"),this.model.save().done(function(){e._requery(!0)})):this.model.destroy()},untrashAttachment:function(t){var e=this.controller.library;t.preventDefault(),this.model.set("status","inherit"),this.model.save().done(function(){e._requery(!0)})},editAttachment:function(t){var e=this.controller.states.get("edit-image");window.imageEdit&&e?(t.preventDefault(),e.set("image",this.model),this.controller.setState("edit-image")):this.$el.addClass("needs-refresh")},refreshAttachment:function(t){this.$el.removeClass("needs-refresh"),t.preventDefault(),this.model.fetch()},toggleSelectionHandler:function(t){if("keydown"===t.type&&9===t.keyCode&&t.shiftKey&&t.target===this.$(":tabbable").get(0))return this.controller.trigger("attachment:details:shift-tab",t),!1;37!==t.keyCode&&38!==t.keyCode&&39!==t.keyCode&&40!==t.keyCode||this.controller.trigger("attachment:keydown:arrow",t)}}),s.view.AttachmentCompat=s.View.extend({tagName:"form",className:"compat-item",events:{submit:"preventDefault","change input":"save","change select":"save","change textarea":"save"},initialize:function(){this.model.on("change:compat",this.render,this)},dispose:function(){return this.$(":focus").length&&this.save(),s.View.prototype.dispose.apply(this,arguments)},render:function(){var t=this.model.get("compat");if(t&&t.item)return this.views.detach(),this.$el.html(t.item),this.views.render(),this},preventDefault:function(t){t.preventDefault()},save:function(t){var i={};t&&t.preventDefault(),e.each(this.$el.serializeArray(),function(t){i[t.name]=t.value}),this.model.saveCompat(i)}}),s.view.Iframe=s.View.extend({className:"media-iframe",render:function(){return this.views.detach(),this.$el.html('<iframe src="'+this.controller.state().get("src")+'" />'),this.views.render(),this}}),s.view.Embed=s.View.extend({className:"media-embed",initialize:function(){this.url=new s.view.EmbedUrl({controller:this.controller,model:this.model.props}).render(),this.views.set([this.url]),this.refresh(),this.model.on("change:type",this.refresh,this),this.model.on("change:loading",this.loading,this)},settings:function(t){this._settings&&this._settings.remove(),this._settings=t,this.views.add(t)},refresh:function(){var t,e=this.model.get("type");if("image"===e)t=s.view.EmbedImage;else{if("link"!==e)return;t=s.view.EmbedLink}this.settings(new t({controller:this.controller,model:this.model.props,priority:40}))},loading:function(){this.$el.toggleClass("embed-loading",this.model.get("loading"))}}),s.view.Label=s.View.extend({tagName:"label",className:"screen-reader-text",initialize:function(){this.value=this.options.value},render:function(){return this.$el.html(this.value),this}}),s.view.EmbedUrl=s.View.extend({tagName:"label",className:"embed-url",events:{input:"url",keyup:"url",change:"url"},initialize:function(){var i=this;this.$input=t('<input id="embed-url-field" type="url" />').val(this.model.get("url")),this.input=this.$input[0],this.spinner=t('<span class="spinner" />')[0],this.$el.append([this.input,this.spinner]),this.model.on("change:url",this.render,this),this.model.get("url")&&e.delay(function(){i.model.trigger("change:url")},500)},render:function(){if(!this.$input.is(":focus"))return this.input.value=this.model.get("url")||"http://",s.View.prototype.render.apply(this,arguments),this},ready:function(){o||this.focus()},url:function(t){this.model.set("url",t.target.value)},focus:function(){var t=this.$input;t.is(":visible")&&t.focus()[0].select()}}),s.view.EmbedLink=s.view.Settings.extend({className:"embed-link-settings",template:s.template("embed-link-settings"),initialize:function(){this.spinner=t('<span class="spinner" />'),this.$el.append(this.spinner[0]),this.listenTo(this.model,"change:url",this.updateoEmbed)},updateoEmbed:function(){var t=this.model.get("url");this.$(".setting.title").show(),this.$(".embed-container").hide().find(".embed-preview").html(""),t&&t.length<6||(this.spinner.show(),setTimeout(e.bind(this.fetch,this),500))},fetch:function(){t("#embed-url-field").val()===this.model.get("url")&&wp.ajax.send("parse-embed",{data:{post_ID:s.view.settings.post.id,shortcode:"[embed]"+this.model.get("url")+"[/embed]"}}).done(e.bind(this.renderoEmbed,this))},renderoEmbed:function(t){var e=t&&t.body||"";this.spinner.hide(),this.$(".setting.title").hide(),this.$(".embed-container").show().find(".embed-preview").html(e)}}),s.view.EmbedImage=s.view.Settings.AttachmentDisplay.extend({className:"embed-media-settings",template:s.template("embed-image-settings"),initialize:function(){s.view.Settings.AttachmentDisplay.prototype.initialize.apply(this,arguments),this.model.on("change:url",this.updateImage,this)},updateImage:function(){this.$("img").attr("src",this.model.get("url"))}}),s.view.ImageDetails=s.view.Settings.AttachmentDisplay.extend({className:"image-details",template:s.template("image-details"),events:e.defaults(s.view.Settings.AttachmentDisplay.prototype.events,{"click .edit-attachment":"editAttachment","click .replace-attachment":"replaceAttachment","click .advanced-toggle":"onToggleAdvanced",'change [data-setting="customWidth"]':"onCustomSize",'change [data-setting="customHeight"]':"onCustomSize",'keyup [data-setting="customWidth"]':"onCustomSize",'keyup [data-setting="customHeight"]':"onCustomSize"}),initialize:function(){this.options.attachment=this.model.attachment,this.listenTo(this.model,"change:url",this.updateUrl),this.listenTo(this.model,"change:link",this.toggleLinkSettings),this.listenTo(this.model,"change:size",this.toggleCustomSize),s.view.Settings.AttachmentDisplay.prototype.initialize.apply(this,arguments)},prepare:function(){var t=!1;return this.model.attachment&&(t=this.model.attachment.toJSON()),e.defaults({model:this.model.toJSON(),attachment:t},this.options)},render:function(){var t=this,e=arguments;return this.model.attachment&&"pending"===this.model.dfd.state()?this.model.dfd.done(function(){s.view.Settings.AttachmentDisplay.prototype.render.apply(t,e),t.postRender()}).fail(function(){t.model.attachment=!1,s.view.Settings.AttachmentDisplay.prototype.render.apply(t,e),t.postRender()}):(s.view.Settings.AttachmentDisplay.prototype.render.apply(this,arguments),this.postRender()),this},postRender:function(){setTimeout(e.bind(this.resetFocus,this),10),this.toggleLinkSettings(),"show"===getUserSetting("advImgDetails")&&this.toggleAdvanced(!0),this.trigger("post-render")},resetFocus:function(){this.$(".link-to-custom").blur(),this.$(".embed-media-settings").scrollTop(0)},updateUrl:function(){this.$(".image img").attr("src",this.model.get("url")),this.$(".url").val(this.model.get("url"))},toggleLinkSettings:function(){"none"===this.model.get("link")?this.$(".link-settings").addClass("hidden"):this.$(".link-settings").removeClass("hidden")},toggleCustomSize:function(){"custom"!==this.model.get("size")?this.$(".custom-size").addClass("hidden"):this.$(".custom-size").removeClass("hidden")},onCustomSize:function(e){var i,s=t(e.target).data("setting"),o=t(e.target).val();!/^\d+/.test(o)||parseInt(o,10)<1?e.preventDefault():"customWidth"===s?(i=Math.round(1/this.model.get("aspectRatio")*o),this.model.set("customHeight",i,{silent:!0}),this.$('[data-setting="customHeight"]').val(i)):(i=Math.round(this.model.get("aspectRatio")*o),this.model.set("customWidth",i,{silent:!0}),this.$('[data-setting="customWidth"]').val(i))},onToggleAdvanced:function(t){t.preventDefault(),this.toggleAdvanced()},toggleAdvanced:function(t){var e,i=this.$el.find(".advanced-section");i.hasClass("advanced-visible")||!1===t?(i.removeClass("advanced-visible"),i.find(".advanced-settings").addClass("hidden"),e="hide"):(i.addClass("advanced-visible"),i.find(".advanced-settings").removeClass("hidden"),e="show"),setUserSetting("advImgDetails",e)},editAttachment:function(t){var e=this.controller.states.get("edit-image");window.imageEdit&&e&&(t.preventDefault(),e.set("image",this.model.attachment),this.controller.setState("edit-image"))},replaceAttachment:function(t){t.preventDefault(),this.controller.setState("replace-image")}}),s.view.Cropper=s.View.extend({className:"crop-content",template:s.template("crop-content"),initialize:function(){e.bindAll(this,"onImageLoad")},ready:function(){this.controller.frame.on("content:error:crop",this.onError,this),this.$image=this.$el.find(".crop-image"),this.$image.on("load",this.onImageLoad),t(window).on("resize.cropper",e.debounce(this.onImageLoad,250))},remove:function(){t(window).off("resize.cropper"),this.$el.remove(),this.$el.off(),wp.media.View.prototype.remove.apply(this,arguments)},prepare:function(){return{title:i.cropYourImage,url:this.options.attachment.get("url")}},onImageLoad:function(){var t=this.controller.get("imgSelectOptions");"function"==typeof t&&(t=t(this.options.attachment,this.controller)),t=e.extend(t,{parent:this.$el}),this.trigger("image-loaded"),this.controller.imgSelect=this.$image.imgAreaSelect(t)},onError:function(){var t=this.options.attachment.get("filename");this.views.add(".upload-errors",new s.view.UploaderStatusError({filename:s.view.UploaderStatus.prototype.filename(t),message:_wpMediaViewsL10n.cropError}),{at:0})}}),s.view.EditImage=s.View.extend({className:"image-editor",template:s.template("image-editor"),initialize:function(t){this.editor=window.imageEdit,this.controller=t.controller,s.View.prototype.initialize.apply(this,arguments)},prepare:function(){return this.model.toJSON()},render:function(){return s.View.prototype.render.apply(this,arguments),this},loadEditor:function(){this.editor.open(this.model.get("id"),this.model.get("nonces").edit,this).done(e.bind(this.focus,this))},focus:function(){this.$(".imgedit-submit .button").eq(0).focus()},back:function(){var t=this.controller.lastState();this.controller.setState(t)},refresh:function(){this.model.fetch()},save:function(){var t=this,e=this.controller.lastState();this.model.fetch().done(function(){t.controller.setState(e)})}}),s.view.Spinner=s.View.extend({tagName:"span",className:"spinner",spinnerTimeout:!1,delay:400,show:function(){return this.spinnerTimeout||(this.spinnerTimeout=e.delay(function(t){t.show()},this.delay,this.$el)),this},hide:function(){return this.$el.hide(),this.spinnerTimeout=clearTimeout(this.spinnerTimeout),this}})}(jQuery,_);