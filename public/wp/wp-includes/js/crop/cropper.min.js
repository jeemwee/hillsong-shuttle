var CropDraggable=Class.create();Object.extend(Object.extend(CropDraggable.prototype,Draggable.prototype),{initialize:function(t){this.options=Object.extend({drawMethod:function(){}},arguments[1]||{}),this.element=$(t),this.handle=this.element,this.delta=this.currentDelta(),this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},draw:function(t){var i=Position.cumulativeOffset(this.element),e=this.currentDelta();i[0]-=e[0],i[1]-=e[1];var s=[0,1].map(function(e){return t[e]-i[e]-this.offset[e]}.bind(this));this.options.drawMethod(s)}});var Cropper={};Cropper.Img=Class.create(),Cropper.Img.prototype={initialize:function(t,i){if(this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:!1,onEndCrop:Prototype.emptyFunction,captureKeys:!0},i||{}),this.options.minWidth>0&&this.options.minHeight>0&&(this.options.ratioDim.x=this.options.minWidth,this.options.ratioDim.y=this.options.minHeight),this.img=$(t),this.clickCoords={x:0,y:0},this.dragging=!1,this.resizing=!1,this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent),this.isIE=/MSIE/.test(navigator.userAgent),this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent),this.ratioX=0,this.ratioY=0,this.attached=!1,$A(document.getElementsByTagName("script")).each(function(t){if(t.src.match(/cropper\.js/)){var i=t.src.replace(/cropper\.js(.*)?/,""),e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href=i+"cropper.css",e.media="screen",document.getElementsByTagName("head")[0].appendChild(e)}}),this.options.ratioDim.x>0&&this.options.ratioDim.y>0){var e=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/e,this.ratioY=this.options.ratioDim.y/e}this.subInitialize(),this.img.complete||this.isWebKit?this.onLoad():Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this))},getGCD:function(t,i){return 1},onLoad:function(){var t="imgCrop_",i=this.img.parentNode,e="";if(this.isOpera8&&(e=" opera8"),this.imgWrap=Builder.node("div",{class:t+"wrap"+e}),this.isIE){this.north=Builder.node("div",{class:t+"overlay "+t+"north"},[Builder.node("span")]),this.east=Builder.node("div",{class:t+"overlay "+t+"east"},[Builder.node("span")]),this.south=Builder.node("div",{class:t+"overlay "+t+"south"},[Builder.node("span")]),this.west=Builder.node("div",{class:t+"overlay "+t+"west"},[Builder.node("span")]);s=[this.north,this.east,this.south,this.west]}else{this.overlay=Builder.node("div",{class:t+"overlay"});var s=[this.overlay]}this.dragArea=Builder.node("div",{class:t+"dragArea"},s),this.handleN=Builder.node("div",{class:t+"handle "+t+"handleN"}),this.handleNE=Builder.node("div",{class:t+"handle "+t+"handleNE"}),this.handleE=Builder.node("div",{class:t+"handle "+t+"handleE"}),this.handleSE=Builder.node("div",{class:t+"handle "+t+"handleSE"}),this.handleS=Builder.node("div",{class:t+"handle "+t+"handleS"}),this.handleSW=Builder.node("div",{class:t+"handle "+t+"handleSW"}),this.handleW=Builder.node("div",{class:t+"handle "+t+"handleW"}),this.handleNW=Builder.node("div",{class:t+"handle "+t+"handleNW"}),this.selArea=Builder.node("div",{class:t+"selArea"},[Builder.node("div",{class:t+"marqueeHoriz "+t+"marqueeNorth"},[Builder.node("span")]),Builder.node("div",{class:t+"marqueeVert "+t+"marqueeEast"},[Builder.node("span")]),Builder.node("div",{class:t+"marqueeHoriz "+t+"marqueeSouth"},[Builder.node("span")]),Builder.node("div",{class:t+"marqueeVert "+t+"marqueeWest"},[Builder.node("span")]),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,Builder.node("div",{class:t+"clickArea"})]),Element.setStyle($(this.selArea),{backgroundColor:"transparent",backgroundRepeat:"no-repeat",backgroundPosition:"0 0"}),this.imgWrap.appendChild(this.img),this.imgWrap.appendChild(this.dragArea),this.dragArea.appendChild(this.selArea),this.dragArea.appendChild(Builder.node("div",{class:t+"clickArea"})),i.appendChild(this.imgWrap),Event.observe(this.dragArea,"mousedown",this.startDrag.bindAsEventListener(this)),Event.observe(document,"mousemove",this.onDrag.bindAsEventListener(this)),Event.observe(document,"mouseup",this.endCrop.bindAsEventListener(this));for(var a=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW],h=0;h<a.length;h++)Event.observe(a[h],"mousedown",this.startResize.bindAsEventListener(this));this.options.captureKeys&&Event.observe(document,"keydown",this.handleKeys.bindAsEventListener(this)),new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)}),this.setParams()},setParams:function(){this.imgW=this.img.width,this.imgH=this.img.height,this.isIE?(Element.setStyle($(this.north),{height:0}),Element.setStyle($(this.east),{width:0,height:0}),Element.setStyle($(this.south),{height:0}),Element.setStyle($(this.west),{width:0,height:0})):(Element.setStyle($(this.overlay),{width:this.imgW+"px",height:this.imgH+"px"}),Element.hide($(this.overlay)),Element.setStyle($(this.selArea),{backgroundImage:"url("+this.img.src+")"})),Element.setStyle($(this.imgWrap),{width:this.imgW+"px",height:this.imgH+"px"}),Element.hide($(this.selArea));var t=Position.positionedOffset(this.imgWrap);this.wrapOffsets={top:t[1],left:t[0]};var i={x1:0,y1:0,x2:0,y2:0};this.setAreaCoords(i),this.options.ratioDim.x>0&&this.options.ratioDim.y>0&&this.options.displayOnInit&&(i.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2),i.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2),i.x2=i.x1+this.options.ratioDim.x,i.y2=i.y1+this.options.ratioDim.y,Element.show(this.selArea),this.drawArea(),this.endCrop()),this.attached=!0},remove:function(){this.attached=!1,this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap),this.imgWrap.parentNode.removeChild(this.imgWrap),Event.stopObserving(this.dragArea,"mousedown",this.startDrag.bindAsEventListener(this)),Event.stopObserving(document,"mousemove",this.onDrag.bindAsEventListener(this)),Event.stopObserving(document,"mouseup",this.endCrop.bindAsEventListener(this));for(var t=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW],i=0;i<t.length;i++)Event.stopObserving(t[i],"mousedown",this.startResize.bindAsEventListener(this));this.options.captureKeys&&Event.stopObserving(document,"keydown",this.handleKeys.bindAsEventListener(this))},reset:function(){this.attached?this.setParams():this.onLoad(),this.endCrop()},handleKeys:function(t){var i={x:0,y:0};if(!this.dragging){switch(t.keyCode){case 37:i.x=-1;break;case 38:i.y=-1;break;case 39:i.x=1;break;case 40:i.y=1}0==i.x&&0==i.y||(t.shiftKey&&(i.x*=10,i.y*=10),this.moveArea([this.areaCoords.x1+i.x,this.areaCoords.y1+i.y]),Event.stop(t))}},calcW:function(){return this.areaCoords.x2-this.areaCoords.x1},calcH:function(){return this.areaCoords.y2-this.areaCoords.y1},moveArea:function(t){this.setAreaCoords({x1:t[0],y1:t[1],x2:t[0]+this.calcW(),y2:t[1]+this.calcH()},!0),this.drawArea()},cloneCoords:function(t){return{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}},setAreaCoords:function(t,i,e,s,a){var h=void 0!==e&&e;if(i){var o=t.x2-t.x1,r=t.y2-t.y1;t.x1<0&&(t.x1=0,t.x2=o),t.y1<0&&(t.y1=0,t.y2=r),t.x2>this.imgW&&(t.x2=this.imgW,t.x1=this.imgW-o),t.y2>this.imgH&&(t.y2=this.imgH,t.y1=this.imgH-r)}else if(t.x1<0&&(t.x1=0),t.y1<0&&(t.y1=0),t.x2>this.imgW&&(t.x2=this.imgW),t.y2>this.imgH&&(t.y2=this.imgH),void 0!==s){this.ratioX>0?this.applyRatio(t,{x:this.ratioX,y:this.ratioY},s,a):h&&this.applyRatio(t,{x:1,y:1},s,a);var n={a1:t.x1,a2:t.x2},d={a1:t.y1,a2:t.y2},l=this.options.minWidth,p=this.options.minHeight;0!=l&&0!=p||!h||(l>0?p=l:p>0&&(l=p)),this.applyMinDimension(n,l,s.x,{min:0,max:this.imgW}),this.applyMinDimension(d,p,s.y,{min:0,max:this.imgH}),t={x1:n.a1,y1:d.a1,x2:n.a2,y2:d.a2}}this.areaCoords=t},applyMinDimension:function(t,i,e,s){t.a2-t.a1<i&&(1==e?t.a2=t.a1+i:t.a1=t.a2-i,t.a1<s.min?(t.a1=s.min,t.a2=i):t.a2>s.max&&(t.a1=s.max-i,t.a2=s.max))},applyRatio:function(t,i,e,s){var a;"N"==s||"S"==s?(a=this.applyRatioToAxis({a1:t.y1,b1:t.x1,a2:t.y2,b2:t.x2},{a:i.y,b:i.x},{a:e.y,b:e.x},{min:0,max:this.imgW}),t.x1=a.b1,t.y1=a.a1,t.x2=a.b2,t.y2=a.a2):(a=this.applyRatioToAxis({a1:t.x1,b1:t.y1,a2:t.x2,b2:t.y2},{a:i.x,b:i.y},{a:e.x,b:e.y},{min:0,max:this.imgH}),t.x1=a.a1,t.y1=a.b1,t.x2=a.a2,t.y2=a.b2)},applyRatioToAxis:function(t,i,e,s){var a,h,o=Object.extend(t,{}),r=o.a2-o.a1,n=Math.floor(r*i.b/i.a),d=null;return 1==e.b?((a=o.b1+n)>s.max&&(d=(a=s.max)-o.b1),o.b2=a):((a=o.b2-n)<s.min&&(d=(a=s.min)+o.b2),o.b1=a),null!=d&&(h=Math.floor(d*i.a/i.b),1==e.a?o.a2=o.a1+h:o.a1=o.a1=o.a2-h),o},drawArea:function(){this.isIE||Element.show($(this.overlay));var t=this.calcW(),i=this.calcH(),e=this.areaCoords.x2,s=this.areaCoords.y2,a=this.selArea.style;a.left=this.areaCoords.x1+"px",a.top=this.areaCoords.y1+"px",a.width=t+"px",a.height=i+"px";var h=Math.ceil((t-6)/2)+"px",o=Math.ceil((i-6)/2)+"px";if(this.handleN.style.left=h,this.handleE.style.top=o,this.handleS.style.left=h,this.handleW.style.top=o,this.isIE){this.north.style.height=this.areaCoords.y1+"px";var r=this.east.style;r.top=this.areaCoords.y1+"px",r.height=i+"px",r.left=e+"px",r.width=this.img.width-e+"px";var n=this.south.style;n.top=s+"px",n.height=this.img.height-s+"px";var d=this.west.style;d.top=this.areaCoords.y1+"px",d.height=i+"px",d.width=this.areaCoords.x1+"px"}else a.backgroundPosition="-"+this.areaCoords.x1+"px -"+this.areaCoords.y1+"px";this.subDrawArea(),this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var t,i,e,s=document.createTextNode(" ");if(this.isIE)fixEl=this.selArea;else if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0],(t=Builder.node("div","")).style.visibility="hidden";var a=["SE","S","SW"];for(e=0;e<a.length;e++)(i=document.getElementsByClassName("imgCrop_handle"+a[e],this.selArea)[0]).childNodes.length&&i.removeChild(i.childNodes[0]),i.appendChild(t)}fixEl.appendChild(s),fixEl.removeChild(s)}},startResize:function(t){this.startCoords=this.cloneCoords(this.areaCoords),this.resizing=!0,this.resizeHandle=Element.classNames(Event.element(t)).toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,""),Event.stop(t)},startDrag:function(t){Element.show(this.selArea),this.clickCoords=this.getCurPos(t),this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y}),this.dragging=!0,this.onDrag(t),Event.stop(t)},getCurPos:function(t){return curPos={x:Event.pointerX(t)-this.wrapOffsets.left,y:Event.pointerY(t)-this.wrapOffsets.top}},onDrag:function(t){var i=null;if(this.dragging||this.resizing)var e=this.getCurPos(t),s=this.cloneCoords(this.areaCoords),a={x:1,y:1};this.dragging?(e.x<this.clickCoords.x&&(a.x=-1),e.y<this.clickCoords.y&&(a.y=-1),this.transformCoords(e.x,this.clickCoords.x,s,"x"),this.transformCoords(e.y,this.clickCoords.y,s,"y")):this.resizing&&((i=this.resizeHandle).match(/E/)?(this.transformCoords(e.x,this.startCoords.x1,s,"x"),e.x<this.startCoords.x1&&(a.x=-1)):i.match(/W/)&&(this.transformCoords(e.x,this.startCoords.x2,s,"x"),e.x<this.startCoords.x2&&(a.x=-1)),i.match(/N/)?(this.transformCoords(e.y,this.startCoords.y2,s,"y"),e.y<this.startCoords.y2&&(a.y=-1)):i.match(/S/)&&(this.transformCoords(e.y,this.startCoords.y1,s,"y"),e.y<this.startCoords.y1&&(a.y=-1))),(this.dragging||this.resizing)&&(this.setAreaCoords(s,!1,t.shiftKey,a,i),this.drawArea(),Event.stop(t))},transformCoords:function(t,i,e,s){var a=new Array;t<i?(a[0]=t,a[1]=i):(a[0]=i,a[1]=t),"x"==s?(e.x1=a[0],e.x2=a[1]):(e.y1=a[0],e.y2=a[1])},endCrop:function(){this.dragging=!1,this.resizing=!1,this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}},Cropper.ImgWithPreview=Class.create(),Object.extend(Object.extend(Cropper.ImgWithPreview.prototype,Cropper.Img.prototype),{subInitialize:function(){this.hasPreviewImg=!1,void 0!==this.options.previewWrap&&this.options.minWidth>0&&this.options.minHeight>0&&(this.previewWrap=$(this.options.previewWrap),this.previewImg=this.img.cloneNode(!1),this.options.displayOnInit=!0,this.hasPreviewImg=!0,Element.addClassName(this.previewWrap,"imgCrop_previewWrap"),Element.setStyle(this.previewWrap,{width:this.options.minWidth+"px",height:this.options.minHeight+"px"}),this.previewWrap.appendChild(this.previewImg))},subDrawArea:function(){if(this.hasPreviewImg){var t=this.calcW(),i=this.calcH(),e={x:this.imgW/t,y:this.imgH/i},s={x:t/this.options.minWidth,y:i/this.options.minHeight},a={w:Math.ceil(this.options.minWidth*e.x)+"px",h:Math.ceil(this.options.minHeight*e.y)+"px",x:"-"+Math.ceil(this.areaCoords.x1/s.x)+"px",y:"-"+Math.ceil(this.areaCoords.y1/s.y)+"px"},h=this.previewImg.style;h.width=a.w,h.height=a.h,h.left=a.x,h.top=a.y}}});