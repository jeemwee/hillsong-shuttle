window.wp=window.wp||{},function(e){"use strict";var t={},i={},n=wp.media,s=["encodedText"];wp.mce=wp.mce||{},wp.mce.View=function(e){e=e||{},this.type=e.type,_.extend(this,_.pick(e,s)),this.initialize.apply(this,arguments)},_.extend(wp.mce.View.prototype,{initialize:function(){},getHtml:function(){return""},loadingPlaceholder:function(){return'<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="wpview-loading"><ins></ins></div></div>'},render:function(i){!i&&this.rendered()||(this.unbind(),this.setContent('<p class="wpview-selection-before"> </p><div class="wpview-body" contenteditable="false"><div class="toolbar">'+(_.isFunction(t[this.type].edit)?'<div class="dashicons dashicons-edit edit"></div>':"")+'<div class="dashicons dashicons-no-alt remove"></div></div><div class="wpview-content wpview-type-'+this.type+'">'+(this.getHtml()||this.loadingPlaceholder())+"</div>"+(this.overlay?'<div class="wpview-overlay"></div>':"")+'</div><p class="wpview-selection-after"> </p>',"wrap"),e(this).trigger("ready"),this.rendered(!0))},unbind:function(){},getEditors:function(e){var t=[];return _.each(tinymce.editors,function(i){i.plugins.wpview&&(e&&e(i),t.push(i))},this),t},getNodes:function(t){var i=[],n=this;return this.getEditors(function(s){e(s.getBody()).find('[data-wpview-text="'+n.encodedText+'"]').each(function(n,o){t&&t(s,o,e(o).find(".wpview-content").get(0)),i.push(o)})}),i},setContent:function(e,t){this.getNodes(function(i,n,s){var o="wrap"===t||"replace"===t?n:s,a=e;_.isString(a)&&(a=i.dom.createFragment(a)),"replace"===t?i.dom.replace(a,o):(o.innerHTML="",o.appendChild(a))})},setIframes:function(t,i){var n=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,s="video"===this.type||"audio"===this.type||"playlist"===this.type;t||-1!==i.indexOf("<script")?this.getNodes(function(o,a,d){var r,c,p,h,w=o.dom,l="",m=o.getBody().className||"";d.innerHTML="",t=t||"",s&&(wp.mce.views.sandboxStyles?l=wp.mce.views.sandboxStyles:(tinymce.each(w.$('link[rel="stylesheet"]',o.getDoc().head),function(e){e.href&&-1===e.href.indexOf("skins/lightgray/content.min.css")&&-1===e.href.indexOf("skins/wordpress/wp-content.css")&&(l+=w.getOuterHTML(e)+"\n")}),wp.mce.views.sandboxStyles=l)),setTimeout(function(){if(r=w.add(d,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no",class:"wpview-sandbox",style:{width:"100%",display:"block"}}),(c=r.contentWindow.document).open(),c.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+t+l+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+m+'">'+i+"</body></html>"),c.close(),h=function(){r.contentWindow&&e(r).height(e(c.body).height())},n)new n(_.debounce(function(){h()},100)).observe(c.body,{attributes:!0,childList:!0,subtree:!0});else for(p=1;p<6;p++)setTimeout(h,700*p);s&&o.on("wp-body-class-change",function(){c.body.className=o.getBody().className})},50)}):this.setContent(i)},setError:function(e,t){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(t||"no")+'"></div><p>'+e+"</p></div>")},rendered:function(t){var i;return this.getNodes(function(n,s){null!=t?e(s).data("rendered",!0===t):i=i||!e(s).data("rendered")}),!i}}),wp.mce.View.extend=Backbone.View.extend,wp.mce.views={register:function(e,i){var n={type:e,View:{},toView:function(e){var t=wp.shortcode.next(this.type,e);if(t)return{index:t.index,content:t.content,options:{shortcode:t.shortcode}}}};(i=_.defaults(i,n)).View=wp.mce.View.extend(i.View),t[e]=i},get:function(e){return t[e]},unregister:function(e){delete t[e]},unbind:function(){_.each(i,function(e){e.unbind()})},toViews:function(e){var i,n=[{content:e}];return _.each(t,function(e,t){i=n.slice(),n=[],_.each(i,function(i){var s,o=i.content;if(i.processed)n.push(i);else{for(;o&&(s=e.toView(o));)s.index&&n.push({content:o.substring(0,s.index)}),n.push({content:wp.mce.views.toView(t,s.content,s.options),processed:!0}),o=o.slice(s.index+s.content.length);o&&n.push({content:o})}})}),_.pluck(n,"content").join("")},toView:function(e,t,n){var s,o,a=wp.mce.views.get(e),d=window.encodeURIComponent(t);return a?(wp.mce.views.getInstance(d)||((o=n).type=e,o.encodedText=d,s=new a.View(o),i[d]=s),wp.html.string({tag:"div",attrs:{class:"wpview-wrap","data-wpview-text":d,"data-wpview-type":e},content:" "})):t},refreshView:function(e,t){var n,s,o=window.encodeURIComponent(t);(s=wp.mce.views.getInstance(o))||((n=e.toView(t).options).type=e.type,n.encodedText=o,s=new e.View(n),i[o]=s),s.render()},getInstance:function(e){return i[e]},render:function(e){_.each(i,function(t){t.render(e)})},edit:function(t){var i=e(t).data("wpview-type"),n=wp.mce.views.get(i);n&&n.edit(t)}},wp.mce.views.register("gallery",{View:{template:n.template("editor-gallery"),postID:e("#post_ID").val(),initialize:function(e){this.shortcode=e.shortcode,this.fetch()},fetch:function(){var e=this;this.attachments=wp.media.gallery.attachments(this.shortcode,this.postID),this.dfd=this.attachments.more().done(function(){e.render(!0)})},getHtml:function(){var e,t=this.shortcode.attrs.named,i=!1;return this.dfd&&"pending"===this.dfd.state()&&!this.attachments.length?"":(this.attachments.length&&(i=this.attachments.toJSON(),_.each(i,function(e){e.sizes&&(e.sizes.thumbnail?e.thumbnail=e.sizes.thumbnail:e.sizes.full&&(e.thumbnail=e.sizes.full))})),e={attachments:i,columns:t.columns?parseInt(t.columns,10):wp.media.galleryDefaults.columns},this.template(e))}},edit:function(t){var i,n,s=wp.media.gallery,o=this;n=window.decodeURIComponent(e(t).attr("data-wpview-text")),(i=s.edit(n)).state("gallery-edit").on("update",function(i){var n=s.shortcode(i).string();e(t).attr("data-wpview-text",window.encodeURIComponent(n)),wp.mce.views.refreshView(o,n)}),i.on("close",function(){i.detach()})}}),wp.mce.av={View:{overlay:!0,action:"parse-media-shortcode",initialize:function(t){var i=this;this.shortcode=t.shortcode,_.bindAll(this,"setIframes","setNodes","fetch","stopPlayers"),e(this).on("ready",this.setNodes),e(document).on("media:edit",this.stopPlayers),this.fetch(),this.getEditors(function(e){e.on("hide",i.stopPlayers)})},setNodes:function(){this.parsed?this.setIframes(this.parsed.head,this.parsed.body):this.fail()},fetch:function(){var t=this;wp.ajax.send(this.action,{data:{post_ID:e("#post_ID").val()||0,type:this.shortcode.tag,shortcode:this.shortcode.string()}}).done(function(e){e?(t.parsed=e,t.setIframes(e.head,e.body)):t.fail(!0)}).fail(function(e){t.fail(e||!0)})},fail:function(e){if(!this.error){if(!e)return;this.error=e}this.error.message?"not-embeddable"===this.error.type&&"embed"===this.type||"not-ssl"===this.error.type||"no-items"===this.error.type?this.setError(this.error.message,"admin-media"):this.setContent("<p>"+this.original+"</p>","replace"):this.error.statusText?this.setError(this.error.statusText,"admin-media"):this.original&&this.setContent("<p>"+this.original+"</p>","replace")},stopPlayers:function(t){var i="remove"===t;this.getNodes(function(t,n,s){var o,a,d=e("iframe.wpview-sandbox",s).get(0);if(d&&(a=d.contentWindow)&&a.mejs)try{for(o in a.mejs.players)a.mejs.players[o].pause(),i&&a.mejs.players[o].remove()}catch(e){}})},unbind:function(){this.stopPlayers("remove")}},edit:function(t){var i,n,s,o=wp.media[this.type],a=this;e(document).trigger("media:edit"),n=window.decodeURIComponent(e(t).attr("data-wpview-text")),(i=o.edit(n)).on("close",function(){i.detach()}),s=function(n){var s=wp.media[a.type].shortcode(n).string();e(t).attr("data-wpview-text",window.encodeURIComponent(s)),wp.mce.views.refreshView(a,s),i.detach()},_.isArray(a.state)?_.each(a.state,function(e){i.state(e).on("update",s)}):i.state(a.state).on("update",s),i.open()}},wp.mce.views.register("video",_.extend({},wp.mce.av,{state:"video-details"})),wp.mce.views.register("audio",_.extend({},wp.mce.av,{state:"audio-details"})),wp.mce.views.register("playlist",_.extend({},wp.mce.av,{state:["playlist-edit","video-playlist-edit"]})),wp.mce.embedMixin={View:_.extend({},wp.mce.av.View,{overlay:!0,action:"parse-embed",initialize:function(t){this.content=t.content,this.original=t.url||t.shortcode.string(),t.url?this.shortcode=n.embed.shortcode({url:t.url}):this.shortcode=t.shortcode,_.bindAll(this,"setIframes","setNodes","fetch"),e(this).on("ready",this.setNodes),this.fetch()}}),edit:function(t){var i,s,o=n.embed,a=this,d="embedURL"===this.type;e(document).trigger("media:edit"),s=window.decodeURIComponent(e(t).attr("data-wpview-text")),(i=o.edit(s,d)).on("close",function(){i.detach()}),i.state("embed").props.on("change:url",function(e,t){t&&(i.state("embed").metadata=e.toJSON())}),i.state("embed").on("select",function(){var n;n=d?i.state("embed").metadata.url:o.shortcode(i.state("embed").metadata).string(),e(t).attr("data-wpview-text",window.encodeURIComponent(n)),wp.mce.views.refreshView(a,n),i.detach()}),i.open()}},wp.mce.views.register("embed",_.extend({},wp.mce.embedMixin)),wp.mce.views.register("embedURL",_.extend({},wp.mce.embedMixin,{toView:function(e){var t=/(?:^|<p>)(https?:\/\/[^\s"]+?)(?:<\/p>\s*|$)/gi.exec(tinymce.trim(e));if(t)return{index:t.index,content:t[0],options:{url:t[1]}}}}))}(jQuery);