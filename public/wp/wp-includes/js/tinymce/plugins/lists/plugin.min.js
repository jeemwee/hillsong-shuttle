tinymce.PluginManager.add("lists",function(e){function t(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)}function n(e){return e.parentNode.firstChild==e}function r(e){return e.parentNode.lastChild==e}function a(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}var i=this;e.on("init",function(){function o(e){function t(t){var r,a,i;a=e[t?"startContainer":"endContainer"],i=e[t?"startOffset":"endOffset"],1==a.nodeType&&(r=N.create("span",{"data-mce-type":"bookmark"}),a.hasChildNodes()?(i=Math.min(i,a.childNodes.length-1),t?a.insertBefore(r,a.childNodes[i]):N.insertAfter(r,a.childNodes[i])):a.appendChild(r),a=r,i=0),n[t?"startContainer":"endContainer"]=a,n[t?"startOffset":"endOffset"]=i}var n={};return t(!0),e.collapsed||t(),n}function d(e){function t(t){var n,r,a;n=a=e[t?"startContainer":"endContainer"],r=e[t?"startOffset":"endOffset"],n&&(1==n.nodeType&&(r=function(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}(n),n=n.parentNode,N.remove(a)),e[t?"startContainer":"endContainer"]=n,e[t?"startOffset":"endOffset"]=r)}t(!0),t();var n=N.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),y.setRng(n)}function s(t,n){var r,a,i,o=N.createFragment(),d=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&((a=N.create(n)).tagName===e.settings.forced_root_block&&N.setAttribs(a,e.settings.forced_root_block_attrs),o.appendChild(a)),t)for(;r=t.firstChild;){var s=r.nodeName;i||"SPAN"==s&&"bookmark"==r.getAttribute("data-mce-type")||(i=!0),d[s]?(o.appendChild(r),a=null):n?(a||(a=N.create(n),o.appendChild(a)),a.appendChild(r)):o.appendChild(r)}return e.settings.forced_root_block?i||tinymce.Env.ie&&!(tinymce.Env.ie>10)||a.appendChild(N.create("br",{"data-mce-bogus":"1"})):o.appendChild(N.create("br")),o}function f(){return tinymce.grep(y.getSelectedBlocks(),function(e){return/^(LI|DT|DD)$/.test(e.nodeName)})}function l(e,t,n){var r,a,i=N.select('span[data-mce-type="bookmark"]',e);n=n||s(t),(r=N.createRng()).setStartAfter(t),r.setEndAfter(e),a=r.extractContents(),N.isEmpty(a)||N.insertAfter(a,e),N.insertAfter(n,e),N.isEmpty(t.parentNode)&&(tinymce.each(i,function(e){t.parentNode.parentNode.insertBefore(e,t.parentNode)}),N.remove(t.parentNode)),N.remove(t)}function c(e){var n,r;if((n=e.nextSibling)&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.appendChild(r);N.remove(n)}if((n=e.previousSibling)&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.insertBefore(r,e.firstChild);N.remove(n)}}function p(e){function a(e){N.isEmpty(e)&&N.remove(e)}var i,o=e.parentNode,d=o.parentNode;return"DD"==e.nodeName?(N.rename(e,"DT"),!0):n(e)&&r(e)?("LI"==d.nodeName?(N.insertAfter(e,d),a(d),N.remove(o)):t(d)?N.remove(o,!0):(d.insertBefore(s(e),o),N.remove(o)),!0):n(e)?("LI"==d.nodeName?(N.insertAfter(e,d),e.appendChild(o),a(d)):t(d)?d.insertBefore(e,o):(d.insertBefore(s(e),o),N.remove(e)),!0):r(e)?("LI"==d.nodeName?N.insertAfter(e,d):t(d)?N.insertAfter(e,o):(N.insertAfter(s(e),o),N.remove(e)),!0):("LI"==d.nodeName?(o=d,i=s(e,"LI")):i=t(d)?s(e,"LI"):s(e),l(o,e,i),function(e){tinymce.each(tinymce.grep(N.select("ol,ul",e)),function(e){var n,r=e.parentNode;"LI"==r.nodeName&&r.firstChild==e&&(n=r.previousSibling)&&"LI"==n.nodeName&&(n.appendChild(e),N.isEmpty(r)&&N.remove(r)),t(r)&&(n=r.previousSibling)&&"LI"==n.nodeName&&n.appendChild(e)})}(o.parentNode),!0)}function m(e){function n(n,r){var a;if(t(n)){for(;a=e.lastChild.firstChild;)r.appendChild(a);N.remove(n)}}var r,a;return"DT"==e.nodeName?(N.rename(e,"DD"),!0):(r=e.previousSibling)&&t(r)?(r.appendChild(e),!0):r&&"LI"==r.nodeName&&t(r.lastChild)?(r.lastChild.appendChild(e),n(e.lastChild,r.lastChild),!0):(r=e.nextSibling)&&t(r)?(r.insertBefore(e,r.firstChild),!0):(!r||"LI"!=r.nodeName||!t(e.lastChild))&&!(!(r=e.previousSibling)||"LI"!=r.nodeName||(a=N.create(e.parentNode.nodeName),r.appendChild(a),a.appendChild(e),n(e.lastChild,a),0))}function u(){var t=f();if(t.length){for(var n=o(y.getRng(!0)),r=0;r<t.length&&(m(t[r])||0!==r);r++);return d(n),e.nodeChanged(),!0}}function h(){var t=f();if(t.length){var n,r,a=o(y.getRng(!0)),i=e.getBody();for(n=t.length;n--;)for(var s=t[n].parentNode;s&&s!=i;){for(r=t.length;r--;)if(t[r]===s){t.splice(n,1);break}s=s.parentNode}for(n=0;n<t.length&&(p(t[n])||0!==n);n++);return d(a),e.nodeChanged(),!0}}function C(){var n=o(y.getRng(!0)),r=e.getBody();tinymce.each(f(),function(e){var n,a;if(N.isEmpty(e))p(e);else{for(n=e;n&&n!=r;n=n.parentNode)t(n)&&(a=n);l(a,e)}}),d(n)}function g(n){var r=N.getParent(y.getStart(),"OL,UL,DL");if(r)if(r.nodeName==n)C();else{var i=o(y.getRng(!0));c(N.rename(r,n)),d(i)}else!function(n){var r=y.getRng(!0),i=o(r),s="LI";"DL"==(n=n.toUpperCase())&&(s="DT"),tinymce.each(function(){function t(e){var t,n;for(t=r[e?"startContainer":"endContainer"],n=r[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=o;){if(a(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var n,i=[],o=e.getBody(),d=t(!0),s=t(),f=[],l=d;l&&(f.push(l),l!=s);l=l.nextSibling);return tinymce.each(f,function(e){if(a(e))return i.push(e),void(n=null);if(N.isBlock(e)||"BR"==e.nodeName)return"BR"==e.nodeName&&N.remove(e),void(n=null);var t=e.nextSibling;tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(a(t)||!t&&e.parentNode==o)?n=null:(n||(n=N.create("p"),e.parentNode.insertBefore(n,e),i.push(n)),n.appendChild(e))}),i}(),function(e){var r,a;(a=e.previousSibling)&&t(a)&&a.nodeName==n?(r=a,e=N.rename(e,s),a.appendChild(e)):(r=N.create(n),e.parentNode.insertBefore(r,e),r.appendChild(e),e=N.rename(e,s)),c(r)}),d(i)}(n)}function v(t){return function(){var n=N.getParent(e.selection.getStart(),"UL,OL,DL");return n&&n.nodeName==t}}var N=e.dom,y=e.selection;i.backspaceDelete=function(n){function r(e,n){var r,a,i=e.parentNode;if(t(n.lastChild)&&(a=n.lastChild),(r=n.lastChild)&&"BR"==r.nodeName&&e.hasChildNodes()&&N.remove(r),N.isEmpty(n)&&N.$(n).empty(),!N.isEmpty(e))for(;r=e.firstChild;)n.appendChild(r);a&&n.appendChild(a),N.remove(e),N.isEmpty(i)&&N.remove(i)}if(y.isCollapsed()){var a=N.getParent(y.getStart(),"LI");if(a){var i=y.getRng(!0),s=N.getParent(function(t,n){var r,a,i=t.startContainer,o=t.startOffset;if(3==i.nodeType&&(n?o<i.data.length:o>0))return i;for(r=e.schema.getNonEmptyElements(),a=new tinymce.dom.TreeWalker(t.startContainer);i=a[n?"next":"prev"]();){if("LI"==i.nodeName&&!i.hasChildNodes())return i;if(r[i.nodeName])return i;if(3==i.nodeType&&i.data.length>0)return i}}(i,n),"LI");if(s&&s!=a){var f=o(i);return n?r(s,a):r(a,s),d(f),!0}if(!s&&!n&&C(a.parentNode.nodeName))return!0}}},e.addCommand("Indent",function(){if(!u())return!0}),e.addCommand("Outdent",function(){if(!h())return!0}),e.addCommand("InsertUnorderedList",function(){g("UL")}),e.addCommand("InsertOrderedList",function(){g("OL")}),e.addCommand("InsertDefinitionList",function(){g("DL")}),e.addQueryStateHandler("InsertUnorderedList",v("UL")),e.addQueryStateHandler("InsertOrderedList",v("OL")),e.addQueryStateHandler("InsertDefinitionList",v("DL")),e.on("keydown",function(t){9==t.keyCode&&e.dom.getParent(e.selection.getStart(),"LI,DT,DD")&&(t.preventDefault(),t.shiftKey?h():u())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){for(var r=e.selection.getSelectedBlocks(),a=!1,i=0,o=r.length;!a&&i<o;i++){var d=r[i].nodeName;a="LI"==d&&n(r[i])||"UL"==d||"OL"==d||"DD"==d}t.disabled(a)})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?i.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&i.backspaceDelete(!0)&&e.preventDefault()})});