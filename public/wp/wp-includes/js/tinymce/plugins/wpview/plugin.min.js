tinymce.PluginManager.add("wpview",function(e){function t(e){return n(e,"wpview-wrap")}function n(e,t){for(;e&&e.parentNode;){if(e.className&&-1!==(" "+e.className+" ").indexOf(" "+t+" "))return e;e=e.parentNode}return!1}function i(n){return(n=t(n))?window.decodeURIComponent(e.dom.getAttrib(n,"data-wpview-text")||""):""}function o(e){e.stopPropagation()}function r(t,n){var i=t?"before":"after",o=t?0:1;l(),e.selection.setCursorLocation(e.dom.select(".wpview-selection-"+i,n)[0],o),e.nodeChanged()}function a(t,n,i){var o=e.dom,a=o.create("p");b.ie&&b.ie<11||(a.innerHTML='<br data-mce-bogus="1">'),n?t.parentNode.insertBefore(a,t):o.insertAfter(a,t),l(),n&&i===C.ENTER?r(n,t):e.selection.setCursorLocation(a,0),e.nodeChanged()}function s(t){e.undoManager.transact(function(){a(t),e.dom.remove(t)})}function c(t){var n,r=e.dom;t&&t!==p&&(e.getBody().focus(),l(),p=t,r.setAttrib(t,"data-mce-selected",1),n=r.create("div",{class:"wpview-clipboard",contenteditable:"true"},i(t)),e.dom.select(".wpview-body",t)[0].appendChild(n),r.bind(n,"beforedeactivate focusin focusout",o),r.bind(p,"beforedeactivate focusin focusout",o),E?e.selection.select(n):e.selection.select(n,!0),e.nodeChanged(),e.fire("wpview-selected",t))}function l(){var t,n=e.dom;p&&(t=e.dom.select(".wpview-clipboard",p)[0],n.unbind(t),n.remove(t),n.unbind(p,"beforedeactivate focusin focusout click mouseup",o),n.setAttrib(p,"data-mce-selected",null)),p=null}function u(e){return e.replace(/<div[^>]+data-wpview-text=\"([^"]+)"[^>]*>[\s\S]+?wpview-selection-after[^>]+>(?:&nbsp;|\u00a0)*<\/p><\/div>/g,"$1")}function d(e){return e<=47&&e!==C.SPACEBAR&&e!==C.ENTER&&e!==C.DELETE&&e!==C.BACKSPACE&&(e<37||e>40)||e>=224||e>=144&&e<=150||e>=91&&e<=93||e>=112&&e<=135}var p,f,v,g,w,m,b=tinymce.Env,C=tinymce.util.VK,S=tinymce.dom.TreeWalker,y=!1,x=!0,h=function(){return!1},E=/iPad|iPod|iPhone/.test(navigator.userAgent);return"undefined"!=typeof wp&&wp.mce?(e.on("BeforeAddUndo",function(e){e.lastLevel&&u(e.level.content)===u(e.lastLevel.content)&&e.preventDefault()}),e.on("BeforeSetContent",function(t){var n;t.content&&(p&&s(p),n=e.selection.getNode(),(!t.content.match(/^\s*(https?:\/\/[^\s"]+)\s*$/i)||"P"===n.nodeName&&n.parentNode===e.getBody()&&e.dom.isEmpty(n))&&(t.content=wp.mce.views.toViews(t.content)))}),e.on("SetContent",function(){wp.mce.views.render()}),e.on("click",function(n){var i,o=n.clientX,a=n.clientY,s=e.getBody(),c=s.getBoundingClientRect(),l=s.firstChild,u=l.getBoundingClientRect(),d=s.lastChild,p=d.getBoundingClientRect();a<u.top&&(i=t(l))?(r(!0,i),n.preventDefault()):a>p.bottom&&(i=t(d))?(r(!1,i),n.preventDefault()):tinymce.each(e.dom.select(".wpview-wrap"),function(e){var t=e.getBoundingClientRect();a>=t.top&&a<=t.bottom&&(o<c.left?(r(!0,e),n.preventDefault()):o>c.right&&(r(!1,e),n.preventDefault()))})}),e.on("init",function(){var n=!1,i=e.selection,o=window.MutationObserver||window.WebKitMutationObserver;e.on("BeforeSetContent",function(){var n,o=t(i.getNode());o&&(!o.nextSibling||t(o.nextSibling)?(n=e.getDoc().createTextNode(""),e.dom.insertAfter(n,o)):n=new S(o.nextSibling,o.nextSibling).next(),i.select(n),i.collapse(!0))}),e.dom.bind(e.getDoc(),"touchmove",function(){n=!0}),e.on("mousedown mouseup click touchend",function(i){var o=t(i.target);if(x=!1,o){if(i.stopImmediatePropagation(),i.preventDefault(),!("touchend"!==i.type&&"mousedown"!==i.type||i.metaKey||i.ctrlKey)){if(e.dom.hasClass(i.target,"edit"))return wp.mce.views.edit(o),e.focus(),!1;if(e.dom.hasClass(i.target,"remove"))return s(o),!1}return"touchend"===i.type&&n?n=!1:c(o),!1}"touchend"!==i.type&&"mousedown"!==i.type||l(),"touchend"===i.type&&n&&(n=!1)},!0),o&&new o(function(){e.fire("wp-body-class-change")}).observe(e.getBody(),{attributes:!0,attributeFilter:["class"]})}),e.on("PreProcess",function(t){tinymce.each(e.dom.select("div[data-wpview-text]",t.node),function(e){e.textContent=e.innerText="Â "})}),e.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]*)"[^>]*>[\s\S]*?<\/div>/g,function(e,t){return t?"<p>"+window.decodeURIComponent(t)+"</p>":""}))}),e.on("keydown",function(n){var i,o,u,f,g,w,m,b=n.keyCode,S=e.dom,x=e.selection;if(p){if((n.metaKey||n.ctrlKey)&&b!==C.BACKSPACE&&86!==b||b>=112&&b<=123)return void((n.metaKey||n.ctrlKey)&&88===b&&(y=p));if((o=t(x.getNode()))!==p)return void l();b===C.LEFT?(r(!0,o),n.preventDefault()):b===C.UP?(o.previousSibling?t(o.previousSibling)?r(!0,o.previousSibling):(l(),x.select(o.previousSibling,!0),x.collapse()):r(!0,o),n.preventDefault()):b===C.RIGHT?(r(!1,o),n.preventDefault()):b===C.DOWN?(o.nextSibling?t(o.nextSibling)?r(!1,o.nextSibling):(l(),x.setCursorLocation(o.nextSibling,0)):r(!1,o),n.preventDefault()):d(b)||(s(p),b!==C.ENTER&&b!==C.DELETE&&b!==C.BACKSPACE||n.preventDefault())}else{if(n.metaKey||n.ctrlKey||b>=112&&b<=123)return;if(i=x.getNode(),v=i,o=t(i),x.isCollapsed()||((o=t((g=x.getRng()).endContainer))?(w=g.cloneRange(),x.select(o.previousSibling,!0),x.collapse(),m=x.getRng(),w.setEnd(m.endContainer,m.endOffset),x.setRng(w)):(o=t(g.startContainer))&&((w=g.cloneRange()).setStart(o.nextSibling,0),x.setRng(w))),!o)return void(n.keyCode===C.BACKSPACE&&(e.dom.isEmpty(i)?(o=t(i.previousSibling))&&(r(!1,o),e.dom.remove(i),n.preventDefault()):(g=x.getRng())&&0===g.startOffset&&0===g.endOffset&&(o=t(i.previousSibling))&&(r(!1,o),n.preventDefault())));if(!(u=S.hasClass(o,"wpview-selection-before"))&&!(f=S.hasClass(o,"wpview-selection-after")))return;if(d(b))return;f&&b===C.UP||u&&b===C.BACKSPACE?(o.previousSibling?t(o.previousSibling)?r(!1,o.previousSibling):S.isEmpty(o.previousSibling)&&b===C.BACKSPACE?S.remove(o.previousSibling):(x.select(o.previousSibling,!0),x.collapse()):r(!0,o),n.preventDefault()):!f||b!==C.DOWN&&b!==C.RIGHT?!u||b!==C.UP&&b!==C.LEFT?u&&b===C.DOWN?(o.nextSibling?t(o.nextSibling)?r(!0,o.nextSibling):x.setCursorLocation(o.nextSibling,0):r(!1,o),n.preventDefault()):f&&b===C.LEFT||u&&b===C.RIGHT?(c(o),n.preventDefault()):f&&b===C.BACKSPACE?(s(o),n.preventDefault()):f?a(o):u&&a(o,!0,b):(o.previousSibling&&(t(o.previousSibling)?r(b===C.UP,o.previousSibling):(x.select(o.previousSibling,!0),x.collapse())),n.preventDefault()):(o.nextSibling&&(t(o.nextSibling)?r(b===C.RIGHT,o.nextSibling):x.setCursorLocation(o.nextSibling,0)),n.preventDefault()),b===C.ENTER&&n.preventDefault()}}),e.on("keyup",function(){y&&(s(y),y=!1)}),e.on("focus",function(){var n;w=!0,e.dom.addClass(e.getBody(),"has-focus"),x&&(n=t(e.getBody().firstChild))&&r(!0,n),x=!1}),e.on("blur",function(){w=!1,e.dom.removeClass(e.getBody(),"has-focus")}),e.on("NodeChange",function(i){var o=e.dom,a=e.dom.select(".wpview-wrap"),s=i.element.className,c=t(i.element),u=v;if(v=!1,clearInterval(f),tinymce.each(a,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),w&&c)if("wpview-selection-before"!==s&&"wpview-selection-after"!==s||!e.selection.isCollapsed())n(i.element,"wpview-clipboard")||g||(l(),g++,r(!0,c));else{if(g=0,l(),u===c.previousSibling)return void r(!0,c);if(u===c.nextSibling)return void r(!1,c);o.addClass(c,s),f=setInterval(function(){o.hasClass(c,"wpview-cursor-hide")?o.removeClass(c,"wpview-cursor-hide"):o.addClass(c,"wpview-cursor-hide")},500)}}),e.on("BeforeExecCommand",function(){var n,i=e.selection.getNode();i&&("wpview-selection-before"===i.className||"wpview-selection-after"===i.className)&&(n=t(i))&&(a(n),m=n)}),e.on("ExecCommand",function(){var t,n;p&&(t=p,l(),c(t)),m&&((n=m.nextSibling)&&"P"===n.nodeName&&e.dom.isEmpty(n)&&(e.dom.remove(n),r(!1,m)),m=!1)}),e.on("ResolveName",function(n){e.dom.hasClass(n.target,"wpview-wrap")?(n.name=e.dom.getAttrib(n.target,"data-wpview-type")||"wpview",n.stopPropagation()):t(n.target)&&(n.preventDefault(),n.stopPropagation())}),{getViewText:i,setViewText:function(n,i){return!!(n=t(n))&&(e.dom.setAttrib(n,"data-wpview-text",window.encodeURIComponent(i||"")),!0)},getView:t}):{getViewText:h,setViewText:h,getView:h}});