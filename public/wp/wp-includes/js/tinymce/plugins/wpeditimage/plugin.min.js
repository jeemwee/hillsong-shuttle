tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,a,n){var i,o,c,d,s,r,l=tinymce.trim;return(i=a.match(/id=['"]([^'"]*)['"] ?/))&&(a=a.replace(i[0],"")),(o=a.match(/align=['"]([^'"]*)['"] ?/))&&(a=a.replace(o[0],"")),(c=a.match(/class=['"]([^'"]*)['"] ?/))&&(a=a.replace(c[0],"")),(r=a.match(/width=['"]([0-9]*)['"] ?/))&&(a=a.replace(r[0],"")),n=l(n),(s=n.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&s[2]?(d=l(s[2]),s=l(s[1])):(d=l(a).replace(/caption=['"]/,"").replace(/['"]$/,""),s=n),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",c=c&&c[1]?" "+c[1].replace(/[<>&]+/g,""):"",!r&&s&&(r=s.match(/width=['"]([0-9]*)['"]/)),r&&r[1]&&(r=r[1]),r&&d?(r=parseInt(r,10),e.getParam("wpeditimage_html5_captions")||(r+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+c+'" style="width: '+r+'px"><dt class="wp-caption-dt">'+s+'</dt><dd class="wp-caption-dd">'+d+"</dd></dl></div>"):n})}function a(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var a="";return-1===t.indexOf("<img ")?(a=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i))&&a[1]?"<p>"+a[1]+"</p>":"":(0!==(a=t.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(e,t,a,n){var i,o,c,d;return d=a.match(/width="([0-9]*)"/),(d=d&&d[1]?d[1]:"")&&n?(i=t.match(/id="([^"]*)"/),i=i&&i[1]?i[1]:"",o=t.match(/class="([^"]*)"/),o=o&&o[1]?o[1]:"",c=o.match(/align[a-z]+/i)||"alignnone",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),n=n.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),n=n.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+i+'" align="'+c+'" width="'+d+'"'+o+"]"+a+" "+n+"[/caption]"):a})).indexOf("[caption")&&(a=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),a)})}function n(e){return e&&!(!e.textContent&&!e.innerText)}function i(t){var a,i,o;"undefined"!=typeof wp&&wp.media?(o=function(t){var a,n,i,o,c,d,s,r,l=[],p=e.dom,m=/^\d+$/;return i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=p.getAttrib(t,"src"),i.alt=p.getAttrib(t,"alt"),i.title=p.getAttrib(t,"title"),s=p.getAttrib(t,"width"),r=p.getAttrib(t,"height"),(!m.test(s)||parseInt(s,10)<1)&&(s=t.naturalWidth||t.width),(!m.test(r)||parseInt(r,10)<1)&&(r=t.naturalHeight||t.height),i.customWidth=i.width=s,i.customHeight=i.height=r,a=tinymce.explode(t.className," "),n=[],tinymce.each(a,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):n.push(e)}),i.extraClasses=n.join(" "),(o=p.getParents(t,".wp-caption")).length&&(a=(o=o[0]).className.split(" "),tinymce.each(a,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&l.push(e)}),i.captionClassName=l.join(" "),(c=p.select("dd.wp-caption-dd",o)).length&&(c=c[0],i.caption=e.serializer.serialize(c).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(d=t.parentNode,i.linkUrl=p.getAttrib(d,"href"),i.linkTargetBlank="_blank"===p.getAttrib(d,"target"),i.linkRel=p.getAttrib(d,"rel"),i.linkClassName=d.className),i}(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:o,image:t}),a=wp.media({frame:"image",state:"image-details",metadata:o}),wp.media.events.trigger("editor:frame-create",{frame:a}),i=function(i){e.focus(),e.undoManager.transact(function(){!function(t,a){var i,o,d,s,r,l,p,m,g,u,h,w,f,N,v,C=e.dom;(i=tinymce.explode(a.extraClasses," "))||(i=[]),a.caption||i.push("align"+a.align),a.attachment_id&&(i.push("wp-image-"+a.attachment_id),a.size&&"custom"!==a.size&&i.push("size-"+a.size)),N=a.width,v=a.height,"custom"===a.size&&(N=a.customWidth,v=a.customHeight),w={src:a.url,width:N||null,height:v||null,alt:a.alt,title:a.title||null,class:i.join(" ")||null},C.setAttribs(t,w),f={href:a.linkUrl,rel:a.linkRel||null,target:a.linkTargetBlank?"_blank":null,class:a.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!n(t.parentNode)?a.linkUrl?C.setAttribs(t.parentNode,f):C.remove(t.parentNode,!0):a.linkUrl&&((p=C.getParent(t,"a"))&&C.insertAfter(t,p),p=C.create("a",f),t.parentNode.insertBefore(p,t),p.appendChild(t)),m=e.dom.getParent(t,".mceTemp"),d=t.parentNode&&"A"===t.parentNode.nodeName&&!n(t.parentNode)?t.parentNode:t,a.caption?(h=a.attachment_id?"attachment_"+a.attachment_id:null,o="wp-caption align"+(a.align||"none"),a.captionClassName&&(o+=" "+a.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),m?((u=C.select("dl.wp-caption",m)).length&&C.setAttribs(u,{id:h,class:o,style:"width: "+N+"px"}),(g=C.select(".wp-caption-dd",m)).length&&C.setHTML(g[0],a.caption)):(s="<dl "+(h=h?'id="'+h+'" ':"")+'class="'+o+'" style="width: '+N+'px"><dt class="wp-caption-dt">'+C.getOuterHTML(d)+'</dt><dd class="wp-caption-dd">'+a.caption+"</dd></dl>",(r=C.getParent(d,"p"))?(l=C.create("div",{class:"mceTemp"},s),r.parentNode.insertBefore(l,r),C.remove(d),C.isEmpty(r)&&C.remove(r)):C.setOuterHTML(d,'<div class="mceTemp">'+s+"</div>"))):m&&(r=C.create("p"),m.parentNode.insertBefore(r,m),r.appendChild(d),C.remove(m)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:a,image:t}),e.nodeChanged(),c(t)}(t,i)}),a.detach()},a.state("image-details").on("update",i),a.state("replace-image").on("replace",i),a.on("close",function(){e.focus(),a.detach(),p=!1}),a.open()):e.execCommand("mceImage")}function o(t){var a;"DIV"===t.nodeName&&e.dom.hasClass(t,"mceTemp")?a=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(a=e.dom.getParent(t,"div.mceTemp")),a?(a.nextSibling?e.selection.select(a.nextSibling):a.previousSibling?e.selection.select(a.previousSibling):e.selection.select(a.parentNode),e.selection.collapse(!0),e.dom.remove(a)):e.dom.remove(t),d(),e.nodeChanged(),e.undoManager.add()}function c(t){var a,n,i,o,c=e.dom;d(),t&&"IMG"===t.nodeName&&!s(t)&&(c.setAttrib(t,"data-wp-imgselect",1),a=c.getRect(t),n='<i class="dashicons dashicons-edit edit" data-mce-bogus="all"></i><i class="dashicons dashicons-no-alt remove" data-mce-bogus="all"></i>',i=c.create("p",{id:"wp-image-toolbar","data-mce-bogus":"all",contenteditable:!1},n),o=e.rtl?a.x+a.w-82:a.x,e.getBody().appendChild(i),c.setStyles(i,{top:a.y,left:o}),l=!0)}function d(){var t=e.dom.get("wp-image-toolbar");t&&e.dom.remove(t),e.dom.setAttrib(e.dom.select("img[data-wp-imgselect]"),"data-wp-imgselect",null),p=!1,l=!1}function s(t){var a=e.dom;return!!(a.hasClass(t,"mceItem")||a.getAttrib(t,"data-mce-placeholder")||a.getAttrib(t,"data-mce-object"))}function r(e){return e&&"I"===e.nodeName&&"wp-image-toolbar"===e.parentNode.id}var l=!1,p=!1;return"ontouchend"in document&&e.on("click",function(e){var t=e.target;p&&"IMG"===t.nodeName&&e.preventDefault(),r(t)&&(e.preventDefault(),e.stopPropagation())}),e.on("mouseup touchend",function(t){var a,n=t.target,l=e.dom;t.button&&t.button>1||(r(n)?((a=l.select("img[data-wp-imgselect]")[0])&&(e.selection.select(a),l.hasClass(n,"remove")?o(a):l.hasClass(n,"edit")&&(p||(i(a),p=!0))),t.preventDefault()):"IMG"!==n.nodeName||e.dom.getAttrib(n,"data-wp-imgselect")||s(n)?"IMG"!==n.nodeName&&d():c(n))}),e.on("init",function(){var t=e.dom,a=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),a),e.on("wpLoadImageForm",function(t){if(!e.getParam("wpeditimage_disable_captions")){t.data.splice(t.data.length-1,0,{type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})}}),e.on("wpNewImageRefresh",function(e){var a,n;(a=t.getParent(e.node,"dl.wp-caption"))&&(a.style.width||(n=(n=parseInt(e.node.clientWidth,10)+10)?n+"px":"50%",t.setStyle(a,"width",n)))}),e.on("wpImageFormSubmit",function(a){var n,i,o,c,d,s=a.imgData.data,r=a.imgData.node,l=a.imgData.caption,p="",m="",g="";s.id="__wp-temp-img-id",a.imgData.cancel=!0,s.style||(s.style=null),s.src?(l&&(l=(l=l.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />")),r?(d=r.id||null,t.setAttribs(r,s),n=t.getParent(r,"dl.wp-caption"),l?n?(i=t.select("dd.wp-caption-dd",n)[0])&&(i.innerHTML=l):(r.className&&(p=r.className.match(/wp-image-([0-9]+)/),m=r.className.match(/align(left|right|center|none)/)),m?(m=m[0],r.className=r.className.replace(/align(left|right|center|none)/g,"")):m="alignnone",m=' class="wp-caption '+m+'"',p&&(p=' id="attachment_'+p[1]+'"'),(g=s.width||r.clientWidth)&&(g=parseInt(g,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),r.parentNode&&"A"===r.parentNode.nodeName?(c=t.getOuterHTML(r.parentNode),o=r.parentNode):(c=t.getOuterHTML(r),o=r),c="<dl "+p+m+g+'><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+l+"</dd></dl>",(i=t.getParent(r,"p"))?(n=t.create("div",{class:"mceTemp"},c),t.insertAfter(n,i),e.selection.select(n),e.nodeChanged(),t.remove(o),t.isEmpty(i)&&t.remove(i)):e.selection.setContent('<div class="mceTemp">'+c+"</div>")):n&&(c="A"===r.parentNode.nodeName?t.getOuterHTML(r.parentNode):t.getOuterHTML(r),i=t.create("p",{},c),t.insertAfter(i,n.parentNode),e.selection.select(i),e.nodeChanged(),t.remove(n.parentNode))):(c=t.createHTML("img",s),l?(o=e.selection.getNode(),s.width&&(g=parseInt(s.width,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),c='<dl class="wp-caption alignnone"'+g+'><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+l+"</dd></dl>",(i="P"===o.nodeName?o:t.getParent(o,"p"))&&"P"===i.nodeName?(n=t.create("div",{class:"mceTemp"},c),i.parentNode.insertBefore(n,i),e.selection.select(n),e.nodeChanged(),t.isEmpty(i)&&t.remove(i)):e.selection.setContent('<div class="mceTemp">'+c+"</div>")):e.selection.setContent(c)),r=t.get("__wp-temp-img-id"),t.setAttrib(r,"id",d),a.imgData.node=r):r&&((n=t.getParent(r,"div.mceTemp"))?t.remove(n):"A"===r.parentNode.nodeName?t.remove(r.parentNode):t.remove(r),e.nodeChanged())}),e.on("wpLoadImageData",function(a){var n,i=a.imgData.data,o=a.imgData.node;(n=t.getParent(o,"dl.wp-caption"))&&(n=t.select("dd.wp-caption-dd",n)[0])&&(i.caption=e.serializer.serialize(n).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),t.bind(e.getDoc(),"dragstart",function(a){var n=e.selection.getNode();"IMG"===n.nodeName&&t.getParent(n,".wp-caption")&&a.preventDefault(),d()}),tinymce.Env.ie&&tinymce.Env.ie>10&&(t.bind(e.getBody(),"mscontrolselect",function(a){"IMG"===a.target.nodeName&&t.getParent(a.target,".wp-caption")?e.getBody().focus():"DL"===a.target.nodeName&&t.hasClass(a.target,"wp-caption")&&a.target.focus()}),e.on("click",function(a){"IMG"===a.target.nodeName&&t.getAttrib(a.target,"data-wp-imgselect")&&t.getParent(a.target,"dl.wp-caption")&&e.getBody().focus()}))}),e.on("ObjectResized",function(t){var a=t.target;"IMG"===a.nodeName&&e.undoManager.transact(function(){var n,i,o=e.dom;a.className=a.className.replace(/\bsize-[^ ]+/,""),(n=o.getParent(a,".wp-caption"))&&(i=t.width||o.getAttrib(a,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(n,"width",i+"px")),c(a)})}),e.on("BeforeExecCommand",function(t){var a,n,i,o,c=t.command,s=e.dom;"mceInsertContent"===c?(a=s.getParent(e.selection.getNode(),"div.mceTemp"))&&(n=s.create("p"),s.insertAfter(n,a),e.selection.setCursorLocation(n,0),e.nodeChanged()):"JustifyLeft"!==c&&"JustifyRight"!==c&&"JustifyCenter"!==c||(a=e.selection.getNode(),o="align"+(o=c.substr(7).toLowerCase()),i=s.getParent(a,"dl.wp-caption"),d(),i&&(s.hasClass(i,o)?(s.removeClass(i,o),s.addClass(i,"alignnone")):(i.className=i.className.replace(/align[^ ]+/g,""),s.addClass(i,o)),"IMG"===a.nodeName&&e.nodeChanged(),t.preventDefault()),"IMG"===a.nodeName&&(s.hasClass(a,o)?s.addClass(a,"alignnone"):s.removeClass(a,"alignnone")))}),e.on("keydown",function(t){var a,n,i,c,s=e.selection,r=t.keyCode,p=e.dom,m=tinymce.util.VK;if(r===m.ENTER)a=s.getNode(),(n=p.getParent(a,"div.mceTemp"))&&(p.events.cancel(t),tinymce.each(p.select("dt, dd",n),function(e){p.isEmpty(e)&&p.remove(e)}),c=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=p.create("p",null,c),"DD"===a.nodeName?p.insertAfter(i,n):n.parentNode.insertBefore(i,n),e.nodeChanged(),s.setCursorLocation(i,0));else if(r===m.DELETE||r===m.BACKSPACE){if("DIV"===(a=s.getNode()).nodeName&&p.hasClass(a,"mceTemp")?n=a:"IMG"!==a.nodeName&&"DT"!==a.nodeName&&"A"!==a.nodeName||(n=p.getParent(a,"div.mceTemp")),n)return p.events.cancel(t),o(a),!1;d()}if(l){if(t.ctrlKey||t.metaKey||t.altKey||r<48&&r!==m.SPACEBAR)return;d()}}),e.on("mousedown",function(e){r(e.target)?tinymce.Env.ie&&e.preventDefault():"IMG"!==e.target.nodeName&&d()}),e.on("BeforeAddUndo",function(e){e.level.content=e.level.content.replace(/ data-wp-imgselect="1"/g,"")}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.on("cut wpview-selected",function(){d()}),e.wpSetImgCaption=function(e){return t(e)},e.wpGetImgCaption=function(e){return a(e)},e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content),t.content=t.content.replace(/ data-wp-imgselect="1"/g,""))}),{_do_shcode:t,_get_shcode:a}});