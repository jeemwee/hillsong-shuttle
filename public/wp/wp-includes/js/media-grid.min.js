!function(t,e,i,o){var n,s=o.media;s.view.l10n?n=s.view.l10n:delete(n=s.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n).settings,s.controller.EditAttachmentMetadata=s.controller.State.extend({defaults:{id:"edit-attachment",title:n.attachmentDetails,content:"edit-metadata",menu:!1,toolbar:!1,router:!1}}),s.view.MediaFrame.Manage=s.view.MediaFrame.extend({initialize:function(){var i=this;e.defaults(this.options,{title:"",modal:!1,selection:[],library:{},multiple:"add",state:"library",uploader:!0,mode:["grid","edit"]}),this.$body=t(document.body),this.$window=t(window),this.$adminBar=t("#wpadminbar"),this.$window.on("scroll resize",e.debounce(e.bind(this.fixPosition,this),15)),t(document).on("click",".add-new-h2",e.bind(this.addNewClickHandler,this)),this.$el.addClass("wp-core-ui"),!o.Uploader.limitExceeded&&o.Uploader.browser.supported||(this.options.uploader=!1),this.options.uploader&&(this.uploader=new s.view.UploaderWindow({controller:this,uploader:{dropzone:document.body,container:document.body}}).render(),this.uploader.ready(),t("body").append(this.uploader.el),this.options.uploader=!1),this.gridRouter=new s.view.MediaFrame.Manage.Router,s.view.MediaFrame.prototype.initialize.apply(this,arguments),this.$el.appendTo(this.options.container),this.createStates(),this.bindRegionModeHandlers(),this.render(),t("#media-search-input").on("input",e.debounce(function(e){var o=t(e.currentTarget).val(),n="";o&&(n+="?search="+o),i.gridRouter.navigate(i.gridRouter.baseUrl(n))},1e3))},createStates:function(){var t=this.options;this.options.states||this.states.add([new s.controller.Library({library:s.query(t.library),multiple:t.multiple,title:t.title,content:"browse",toolbar:"select",contentUserSetting:!1,filterable:"all",autoSelect:!1})])},bindRegionModeHandlers:function(){this.on("content:create:browse",this.browseContent,this),this.on("edit:attachment",this.openEditAttachmentModal,this),this.on("select:activate",this.bindKeydown,this),this.on("select:deactivate",this.unbindKeydown,this)},handleKeydown:function(t){27===t.which&&(t.preventDefault(),this.deactivateMode("select").activateMode("edit"))},bindKeydown:function(){this.$body.on("keydown.select",e.bind(this.handleKeydown,this))},unbindKeydown:function(){this.$body.off("keydown.select")},fixPosition:function(){var t,e;this.isModeActive("select")&&(e=(t=this.$(".attachments-browser")).find(".media-toolbar"),t.offset().top+16<this.$window.scrollTop()+this.$adminBar.height()?(t.addClass("fixed"),e.css("width",t.width()+"px")):(t.removeClass("fixed"),e.css("width","")))},addNewClickHandler:function(t){t.preventDefault(),this.trigger("toggle:upload:attachment")},openEditAttachmentModal:function(t){o.media({frame:"edit-attachments",controller:this,library:this.state().get("library"),model:t})},browseContent:function(t){var i=this.state();this.browserView=t.view=new s.view.AttachmentsBrowser({controller:this,collection:i.get("library"),selection:i.get("selection"),model:i,sortable:i.get("sortable"),search:i.get("searchable"),filters:i.get("filterable"),display:i.get("displaySettings"),dragInfo:i.get("dragInfo"),sidebar:"errors",suggestedWidth:i.get("suggestedWidth"),suggestedHeight:i.get("suggestedHeight"),AttachmentView:i.get("AttachmentView"),scrollElement:document}),this.browserView.on("ready",e.bind(this.bindDeferred,this)),this.errors=o.Uploader.errors,this.errors.on("add remove reset",this.sidebarVisibility,this)},sidebarVisibility:function(){this.browserView.$(".media-sidebar").toggle(!!this.errors.length)},bindDeferred:function(){this.browserView.dfd&&this.browserView.dfd.done(e.bind(this.startHistory,this))},startHistory:function(){window.history&&window.history.pushState&&i.history.start({root:_wpMediaGridSettings.adminUrl,pushState:!0})}}),s.view.Attachment.Details.TwoColumn=s.view.Attachment.Details.extend({template:s.template("attachment-details-two-column"),editAttachment:function(t){t.preventDefault(),this.controller.content.mode("edit-image")},toggleSelectionHandler:function(){},render:function(){s.view.Attachment.Details.prototype.render.apply(this,arguments),s.mixin.removeAllPlayers(),this.$("audio, video").each(function(t,e){var i=s.view.MediaDetails.prepareSrc(e);new MediaElementPlayer(i,s.mixin.mejsSettings)})}}),s.view.MediaFrame.Manage.Router=i.Router.extend({routes:{"upload.php?item=:slug":"showItem","upload.php?search=:query":"search"},baseUrl:function(t){return"upload.php"+t},search:function(e){t("#media-search-input").val(e).trigger("input")},showItem:function(t){var e,i=s.frame.state().get("library");(e=i.findWhere({id:parseInt(t,10)}))?s.frame.trigger("edit:attachment",e):(e=s.attachment(t),s.frame.listenTo(e,"change",function(t){s.frame.stopListening(e),s.frame.trigger("edit:attachment",t)}),e.fetch())}}),s.view.EditImage.Details=s.view.EditImage.extend({initialize:function(t){this.editor=window.imageEdit,this.frame=t.frame,this.controller=t.controller,s.View.prototype.initialize.apply(this,arguments)},back:function(){this.frame.content.mode("edit-metadata")},save:function(){var t=this;this.model.fetch().done(function(){t.frame.content.mode("edit-metadata")})}}),s.view.MediaFrame.EditAttachments=s.view.MediaFrame.extend({className:"edit-attachment-frame",template:s.template("edit-attachment-frame"),regions:["title","content"],events:{"click .left":"previousMediaItem","click .right":"nextMediaItem",keydown:"keyEvent"},initialize:function(){s.view.Frame.prototype.initialize.apply(this,arguments),e.defaults(this.options,{modal:!0,state:"edit-attachment"}),this.controller=this.options.controller,this.gridRouter=this.controller.gridRouter,this.library=this.options.library,this.options.model&&(this.model=this.options.model),this.bindHandlers(),this.createStates(),this.createModal(),this.title.mode("default"),this.toggleNav()},bindHandlers:function(){this.on("title:create:default",this.createTitle,this),this.listenTo(this.model,"change:status destroy",this.close,this),this.on("content:create:edit-metadata",this.editMetadataMode,this),this.on("content:create:edit-image",this.editImageMode,this),this.on("content:render:edit-image",this.editImageModeRender,this),this.on("close",this.detach)},createModal:function(){var i=this;this.options.modal&&(this.modal=new s.view.Modal({controller:this,title:this.options.title}),this.modal.on("open",function(){t("body").on("keydown.media-modal",e.bind(i.keyEvent,i))}),this.modal.on("close",function(){i.modal.remove(),t("body").off("keydown.media-modal"),t('li.attachment[data-id="'+i.model.get("id")+'"]').focus(),i.resetRoute()}),this.modal.content(this),this.modal.open())},createStates:function(){this.states.add([new s.controller.EditAttachmentMetadata({model:this.model})])},editMetadataMode:function(t){t.view=new s.view.Attachment.Details.TwoColumn({controller:this,model:this.model}),t.view.views.set(".attachment-compat",new s.view.AttachmentCompat({controller:this,model:this.model})),this.model&&this.gridRouter.navigate(this.gridRouter.baseUrl("?item="+this.model.id))},editImageMode:function(t){var e=new s.controller.EditImage({model:this.model,frame:this});e._toolbar=function(){},e._router=function(){},e._menu=function(){},t.view=new s.view.EditImage.Details({model:this.model,frame:this,controller:e})},editImageModeRender:function(t){t.on("ready",t.loadEditor)},toggleNav:function(){this.$(".left").toggleClass("disabled",!this.hasPrevious()),this.$(".right").toggleClass("disabled",!this.hasNext())},rerender:function(){"edit-metadata"!==this.content.mode()?this.content.mode("edit-metadata"):this.content.render(),this.toggleNav()},previousMediaItem:function(){this.hasPrevious()?(this.model=this.library.at(this.getCurrentIndex()-1),this.rerender(),this.$(".left").focus()):this.$(".left").blur()},nextMediaItem:function(){this.hasNext()?(this.model=this.library.at(this.getCurrentIndex()+1),this.rerender(),this.$(".right").focus()):this.$(".right").blur()},getCurrentIndex:function(){return this.library.indexOf(this.model)},hasNext:function(){return this.getCurrentIndex()+1<this.library.length},hasPrevious:function(){return this.getCurrentIndex()-1>-1},keyEvent:function(t){("INPUT"!==t.target.tagName||t.target.readOnly||t.target.disabled)&&(39===t.keyCode&&this.nextMediaItem(),37===t.keyCode&&this.previousMediaItem())},resetRoute:function(){this.gridRouter.navigate(this.gridRouter.baseUrl(""))}}),s.view.SelectModeToggleButton=s.view.Button.extend({initialize:function(){s.view.Button.prototype.initialize.apply(this,arguments),this.listenTo(this.controller,"select:activate select:deactivate",this.toggleBulkEditHandler),this.listenTo(this.controller,"selection:action:done",this.back)},back:function(){this.controller.deactivateMode("select").activateMode("edit")},click:function(){s.view.Button.prototype.click.apply(this,arguments),this.controller.isModeActive("select")?this.back():this.controller.deactivateMode("edit").activateMode("select")},render:function(){return s.view.Button.prototype.render.apply(this,arguments),this.$el.addClass("select-mode-toggle-button"),this},toggleBulkEditHandler:function(){var t,e=this.controller.content.get().toolbar;t=e.$(".media-toolbar-secondary > *, .media-toolbar-primary > *"),this.controller.isModeActive("select")?(this.model.set("text",n.cancelSelection),t.not(".delete-selected-button").hide(),e.$(".select-mode-toggle-button").show(),e.$(".delete-selected-button").removeClass("hidden")):(this.model.set("text",n.bulkSelect),this.controller.content.get().$el.removeClass("fixed"),e.$el.css("width",""),e.$(".delete-selected-button").addClass("hidden"),t.not(".spinner, .delete-selected-button").show(),this.controller.state().get("selection").reset())}}),s.view.DeleteSelectedButton=s.view.Button.extend({initialize:function(){s.view.Button.prototype.initialize.apply(this,arguments),this.options.filters&&this.listenTo(this.options.filters.model,"change",this.filterChange),this.listenTo(this.controller,"selection:toggle",this.toggleDisabled)},filterChange:function(t){"trash"===t.get("status")?this.model.set("text",n.untrashSelected):s.view.settings.mediaTrash?this.model.set("text",n.trashSelected):this.model.set("text",n.deleteSelected)},toggleDisabled:function(){this.model.set("disabled",!this.controller.state().get("selection").length)},render:function(){return s.view.Button.prototype.render.apply(this,arguments),this.controller.isModeActive("select")?this.$el.addClass("delete-selected-button"):this.$el.addClass("delete-selected-button hidden"),this}}),s.view.DateFilter=s.view.AttachmentFilters.extend({id:"media-attachment-date-filters",createFilters:function(){var t={};e.each(s.view.settings.months||{},function(e,i){t[i]={text:e.text,props:{year:e.year,monthnum:e.month}}}),t.all={text:n.allDates,props:{monthnum:!1,year:!1},priority:10},this.filters=t}})}(jQuery,_,Backbone,wp);