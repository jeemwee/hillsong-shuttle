!function(e,t){var i=wp.customize;i.Setting=i.Value.extend({initialize:function(e,t,n){i.Value.prototype.initialize.call(this,t,n),this.id=e,this.transport=this.transport||"refresh",this.bind(this.preview)},preview:function(){switch(this.transport){case"refresh":return this.previewer.refresh();case"postMessage":return this.previewer.send("setting",[this.id,this()])}}}),i.Control=i.Class.extend({initialize:function(e,n){var r,s,o,a=this;this.params={},t.extend(this,n||{}),this.id=e,this.selector="#customize-control-"+e.replace(/\]/g,"").replace(/\[/g,"-"),this.container=t(this.selector),this.active=new i.Value(this.params.active),o=t.map(this.params.settings,function(e){return e}),i.apply(i,o.concat(function(){var e;a.settings={};for(e in a.params.settings)a.settings[e]=i(a.params.settings[e]);a.setting=a.settings.default||null,a.ready()})),a.elements=[],r=this.container.find("[data-customize-setting-link]"),s={},r.each(function(){var e,n=t(this);if(n.is(":radio")){if(e=n.prop("name"),s[e])return;s[e]=!0,n=r.filter('[name="'+e+'"]')}i(n.data("customizeSettingLink"),function(e){var t=new i.Element(n);a.elements.push(t),t.sync(e),t.set(e())})}),a.active.bind(function(e){a.toggle(e)}),a.toggle(a.active())},ready:function(){},toggle:function(e){e?this.container.slideDown():this.container.slideUp()},dropdownInit:function(){var e=this,t=this.container.find(".dropdown-status"),i=this.params,n=!1,r=function(e){"string"==typeof e&&i.statuses&&i.statuses[e]?t.html(i.statuses[e]).show():t.hide()};this.container.on("click keydown",".dropdown",function(t){"keydown"===t.type&&13!==t.which||(t.preventDefault(),n||e.container.toggleClass("open"),e.container.hasClass("open")&&e.container.parent().parent().find("li.library-selected").focus(),n=!0,setTimeout(function(){n=!1},400))}),this.setting.bind(r),r(this.setting())}}),i.ColorControl=i.Control.extend({ready:function(){var e=this,t=this.container.find(".color-picker-hex");t.val(e.setting()).wpColorPicker({change:function(){e.setting.set(t.wpColorPicker("color"))},clear:function(){e.setting.set(!1)}})}}),i.UploadControl=i.Control.extend({ready:function(){var e=this;this.params.removed=this.params.removed||"",this.success=t.proxy(this.success,this),this.uploader=t.extend({container:this.container,browser:this.container.find(".upload"),dropzone:this.container.find(".upload-dropzone"),success:this.success,plupload:{},params:{}},this.uploader||{}),e.params.extensions&&(e.uploader.plupload.filters=[{title:i.l10n.allowedFiles,extensions:e.params.extensions}]),e.params.context&&(e.uploader.params["post_data[context]"]=this.params.context),i.settings.theme.stylesheet&&(e.uploader.params["post_data[theme]"]=i.settings.theme.stylesheet),this.uploader=new wp.Uploader(this.uploader),this.remover=this.container.find(".remove"),this.remover.on("click keydown",function(t){"keydown"===t.type&&13!==t.which||(e.setting.set(e.params.removed),t.preventDefault())}),this.removerVisibility=t.proxy(this.removerVisibility,this),this.setting.bind(this.removerVisibility),this.removerVisibility(this.setting.get())},success:function(e){this.setting.set(e.get("url"))},removerVisibility:function(e){this.remover.toggle(e!=this.params.removed)}}),i.ImageControl=i.UploadControl.extend({ready:function(){var e,n=this;this.uploader={init:function(){var e,t;this.supports.dragdrop||(t=(e=n.container.find(".upload-fallback")).children().detach(),this.browser.detach().empty().append(t),e.append(this.browser).show())}},i.UploadControl.prototype.ready.call(this),this.thumbnail=this.container.find(".preview-thumbnail img"),this.thumbnailSrc=t.proxy(this.thumbnailSrc,this),this.setting.bind(this.thumbnailSrc),this.library=this.container.find(".library"),this.tabs={},e=this.library.find(".library-content"),this.library.children("ul").children("li").each(function(){var i=t(this),r=i.data("customizeTab"),s=e.filter('[data-customize-tab="'+r+'"]');n.tabs[r]={both:i.add(s),link:i,panel:s}}),this.library.children("ul").on("click keydown","li",function(e){if("keydown"!==e.type||13===e.which){var i=t(this).data("customizeTab"),r=n.tabs[i];e.preventDefault(),r.link.hasClass("library-selected")||(n.selected.both.removeClass("library-selected"),n.selected=r,n.selected.both.addClass("library-selected"))}}),this.library.on("click keydown","a",function(e){if("keydown"!==e.type||13===e.which){var i=t(this).data("customizeImageValue");i&&(n.setting.set(i),e.preventDefault())}}),this.tabs.uploaded&&(this.tabs.uploaded.target=this.library.find(".uploaded-target"),this.tabs.uploaded.panel.find(".thumbnail").length||this.tabs.uploaded.both.addClass("hidden")),e.each(function(){var e=n.tabs[t(this).data("customizeTab")];if(!e.link.hasClass("hidden"))return n.selected=e,e.both.addClass("library-selected"),!1}),this.dropdownInit()},success:function(e){i.UploadControl.prototype.success.call(this,e),this.tabs.uploaded&&this.tabs.uploaded.target.length&&(this.tabs.uploaded.both.removeClass("hidden"),e.element=t('<a href="#" class="thumbnail"></a>').data("customizeImageValue",e.get("url")).append('<img src="'+e.get("url")+'" />').appendTo(this.tabs.uploaded.target))},thumbnailSrc:function(e){/^(https?:)?\/\//.test(e)?this.thumbnail.prop("src",e).show():this.thumbnail.hide()}}),i.HeaderControl=i.Control.extend({ready:function(){this.btnRemove=t("#customize-control-header_image .actions .remove"),this.btnNew=t("#customize-control-header_image .actions .new"),_.bindAll(this,"openMedia","removeImage"),this.btnNew.on("click",this.openMedia),this.btnRemove.on("click",this.removeImage),i.HeaderTool.currentHeader=new i.HeaderTool.ImageModel,new i.HeaderTool.CurrentView({model:i.HeaderTool.currentHeader,el:".current .container"}),new i.HeaderTool.ChoiceListView({collection:i.HeaderTool.UploadsList=new i.HeaderTool.ChoiceList,el:".choices .uploaded .list"}),new i.HeaderTool.ChoiceListView({collection:i.HeaderTool.DefaultsList=new i.HeaderTool.DefaultsList,el:".choices .default .list"}),i.HeaderTool.combinedList=i.HeaderTool.CombinedList=new i.HeaderTool.CombinedList([i.HeaderTool.UploadsList,i.HeaderTool.DefaultsList])},calculateImageSelectOptions:function(e,t){var n,r,s,o,a,l,c=parseInt(_wpCustomizeHeader.data.width,10),d=parseInt(_wpCustomizeHeader.data.height,10),h=!!parseInt(_wpCustomizeHeader.data["flex-width"],10),u=!!parseInt(_wpCustomizeHeader.data["flex-height"],10);return a=e.get("width"),o=e.get("height"),this.headerImage=new i.HeaderTool.ImageModel,this.headerImage.set({themeWidth:c,themeHeight:d,themeFlexWidth:h,themeFlexHeight:u,imageWidth:a,imageHeight:o}),t.set("canSkipCrop",!this.headerImage.shouldBeCropped()),n=c/d,r=a,s=o,r/s>n?c=(d=s)*n:d=(c=r)/n,l={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:a,imageHeight:o,x1:0,y1:0,x2:c,y2:d},!1===u&&!1===h&&(l.aspectRatio=c+":"+d),!1===u&&(l.maxHeight=d),!1===h&&(l.maxWidth=c),l},openMedia:function(e){var t=_wpMediaViewsL10n;e.preventDefault(),this.frame=wp.media({button:{text:t.selectAndCrop,close:!1},states:[new wp.media.controller.Library({title:t.chooseImage,library:wp.media.query({type:"image"}),multiple:!1,priority:20,suggestedWidth:_wpCustomizeHeader.data.width,suggestedHeight:_wpCustomizeHeader.data.height}),new wp.media.controller.Cropper({imgSelectOptions:this.calculateImageSelectOptions})]}),this.frame.on("select",this.onSelect,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this),this.frame.open()},onSelect:function(){this.frame.setState("cropper")},onCropped:function(e){var t=e.post_content,i=e.attachment_id,n=e.width,r=e.height;this.setImageFromURL(t,i,n,r)},onSkippedCrop:function(e){var t=e.get("url"),i=e.get("width"),n=e.get("height");this.setImageFromURL(t,e.id,i,n)},setImageFromURL:function(e,t,n,r){var s,o={};o.url=e,o.thumbnail_url=e,o.timestamp=_.now(),t&&(o.attachment_id=t),n&&(o.width=n),r&&(o.height=r),s=new i.HeaderTool.ImageModel({header:o,choice:e.split("/").pop()}),i.HeaderTool.UploadsList.add(s),i.HeaderTool.currentHeader.set(s.toJSON()),s.save(),s.importImage()},removeImage:function(){i.HeaderTool.currentHeader.trigger("hide"),i.HeaderTool.CombinedList.trigger("control:removeImage")}}),i.defaultConstructor=i.Setting,i.control=new i.Values({defaultConstructor:i.Control}),i.PreviewFrame=i.Messenger.extend({sensitivity:2e3,initialize:function(e,n){var r=t.Deferred();r.promise(this),this.container=e.container,this.signature=e.signature,t.extend(e,{channel:i.PreviewFrame.uuid()}),i.Messenger.prototype.initialize.call(this,e,n),this.add("previewUrl",e.previewUrl),this.query=t.extend(e.query||{},{customize_messenger_channel:this.channel()}),this.run(r)},run:function(e){var n=this,r=!1,s=!1;this._ready&&this.unbind("ready",this._ready),this._ready=function(){s=!0,r&&e.resolveWith(n)},this.bind("ready",this._ready),this.bind("ready",function(e){e&&e.activeControls&&t.each(e.activeControls,function(e,t){var n=i.control(e);n&&n.active(t)})}),this.request=t.ajax(this.previewUrl(),{type:"POST",data:this.query,xhrFields:{withCredentials:!0}}),this.request.fail(function(){e.rejectWith(n,["request failure"])}),this.request.done(function(i){var o,a=n.request.getResponseHeader("Location"),l=n.signature;a&&a!=n.previewUrl()?e.rejectWith(n,["redirect",a]):"0"!==i?"-1"!==i?-1===(o=i.lastIndexOf(l))||o<i.lastIndexOf("</html>")?e.rejectWith(n,["unsigned"]):(i=i.slice(0,o)+i.slice(o+l.length),n.iframe=t("<iframe />").appendTo(n.container),n.iframe.one("load",function(){r=!0,s?e.resolveWith(n):setTimeout(function(){e.rejectWith(n,["ready timeout"])},n.sensitivity)}),n.targetWindow(n.iframe[0].contentWindow),n.targetWindow().document.open(),n.targetWindow().document.write(i),n.targetWindow().document.close()):e.rejectWith(n,["cheatin"]):n.login(e)})},login:function(e){var n,r=this;if(n=function(){e.rejectWith(r,["logged out"])},this.triedLogin)return n();t.get(i.settings.url.ajax,{action:"logged-in"}).fail(n).done(function(i){var s;"1"!==i&&n(),(s=t('<iframe src="'+r.previewUrl()+'" />').hide()).appendTo(r.container),s.load(function(){r.triedLogin=!0,s.remove(),r.run(e)})})},destroy:function(){i.Messenger.prototype.destroy.call(this),this.request.abort(),this.iframe&&this.iframe.remove(),delete this.request,delete this.iframe,delete this.targetWindow}}),function(){var e=0;i.PreviewFrame.uuid=function(){return"preview-"+e++}}(),i.Previewer=i.Messenger.extend({refreshBuffer:250,initialize:function(e,n){var r=this,s=/^https?/;t.extend(this,n||{}),this.refresh=function(e){var t,i=e.refresh,n=function(){t=null,i.call(e)};return function(){if("number"!=typeof t){if(!e.loading)return n();e.abort()}clearTimeout(t),t=setTimeout(n,e.refreshBuffer)}}(this),this.container=i.ensure(e.container),this.allowedUrls=e.allowedUrls,this.signature=e.signature,e.url=window.location.href,i.Messenger.prototype.initialize.call(this,e),this.add("scheme",this.origin()).link(this.origin).setter(function(e){var t=e.match(s);return t?t[0]:""}),this.add("previewUrl",e.previewUrl).setter(function(e){var i;return/\/wp-admin(\/|$)/.test(e.replace(/[#?].*$/,""))?null:(t.each([e.replace(s,r.scheme()),e],function(e,n){if(t.each(r.allowedUrls,function(e,t){var r;if(t=t.replace(/\/+$/,""),r=n.replace(t,""),0===n.indexOf(t)&&/^([/#?]|$)/.test(r))return i=n,!1}),i)return!1}),i||null)}),this.previewUrl.bind(this.refresh),this.scroll=0,this.bind("scroll",function(e){this.scroll=e}),this.bind("url",this.previewUrl)},query:function(){},abort:function(){this.loading&&(this.loading.destroy(),delete this.loading)},refresh:function(){var e=this;this.abort(),this.loading=new i.PreviewFrame({url:this.url(),previewUrl:this.previewUrl(),query:this.query()||{},container:this.container,signature:this.signature}),this.loading.done(function(){this.bind("synced",function(){e.preview&&e.preview.destroy(),e.preview=this,delete e.loading,e.targetWindow(this.targetWindow()),e.channel(this.channel()),e.send("active")}),this.send("sync",{scroll:e.scroll,settings:i.get()})}),this.loading.fail(function(t,i){"redirect"===t&&i&&e.previewUrl(i),"logged out"===t&&(e.preview&&(e.preview.destroy(),delete e.preview),e.login().done(e.refresh)),"cheatin"===t&&e.cheatin()})},login:function(){var e,n,r,s=this;return this._login?this._login:(e=t.Deferred(),this._login=e.promise(),n=new i.Messenger({channel:"login",url:i.settings.url.login}),r=t('<iframe src="'+i.settings.url.login+'" />').appendTo(this.container),n.targetWindow(r[0].contentWindow),n.bind("login",function(){r.remove(),n.destroy(),delete s._login,e.resolve()}),this._login)},cheatin:function(){t(document.body).empty().addClass("cheatin").append("<p>"+i.l10n.cheatin+"</p>")}}),i.controlConstructor={color:i.ColorControl,upload:i.UploadControl,image:i.ImageControl,header:i.HeaderControl},t(function(){if(i.settings=window._wpCustomizeSettings,i.l10n=window._wpCustomizeControlsL10n,i.settings){if(!t.support.postMessage||!t.support.cors&&i.settings.isCrossDomain)return window.location=i.settings.url.fallback;var e,n,r=t(document.body),s=r.children(".wp-full-overlay"),o=t("#customize-info .theme-name.site-title"),a=t(".customize-controls-close"),l=t("#save");t("#customize-controls").on("keydown",function(e){var i=13===e.which,n=t(e.target);i&&(n.is("input:not([type=button])")||n.is("select"))&&e.preventDefault()}),i.previewer=new i.Previewer({container:"#customize-preview",form:"#customize-controls",previewUrl:i.settings.url.preview,allowedUrls:i.settings.url.allowed,signature:"WP_CUSTOMIZER_SIGNATURE"},{nonce:i.settings.nonce,query:function(){return{wp_customize:"on",theme:i.settings.theme.stylesheet,customized:JSON.stringify(i.get()),nonce:this.nonce.preview}},save:function(){var e,n,s=this,o=t.extend(this.query(),{action:"customize_save",nonce:this.nonce.save}),a=i.state("processing");r.addClass("saving"),n=function(){var e=t.post(i.settings.url.ajax,o);i.trigger("save",e),e.always(function(){r.removeClass("saving")}),e.done(function(e){if("0"===e)return s.preview.iframe.hide(),void s.login().done(function(){s.save(),s.preview.iframe.show()});"-1"!==e?i.trigger("saved"):s.cheatin()})},0===a()?n():(e=function(){0===a()&&(i.state.unbind("change",e),n())},i.state.bind("change",e))}}),i.previewer.bind("nonce",function(e){t.extend(this.nonce,e)}),t.each(i.settings.settings,function(e,t){i.create(e,e,t.value,{transport:t.transport,previewer:i.previewer})}),t.each(i.settings.controls,function(e,t){var n=i.controlConstructor[t.type]||i.Control;i.control.add(e,new n(e,{params:t,previewer:i.previewer}))}),i.previewer.previewUrl()?i.previewer.refresh():i.previewer.previewUrl(i.settings.url.home),function(){var e=new i.Values,t=e.create("saved"),n=e.create("activated"),r=e.create("processing");e.bind("change",function(){n()?t()?(l.val(i.l10n.saved).prop("disabled",!0),a.find(".screen-reader-text").text(i.l10n.close)):(l.val(i.l10n.save).prop("disabled",!1),a.find(".screen-reader-text").text(i.l10n.cancel)):(l.val(i.l10n.activate).prop("disabled",!1),a.find(".screen-reader-text").text(i.l10n.cancel))}),t(!0),n(i.settings.theme.active),r(0),i.bind("change",function(){e("saved").set(!1)}),i.bind("saved",function(){e("saved").set(!0),e("activated").set(!0)}),n.bind(function(e){e&&i.trigger("activated")}),i.state=e}(),l.click(function(e){i.previewer.save(),e.preventDefault()}).keydown(function(e){9!==e.which&&(13===e.which&&i.previewer.save(),e.preventDefault())}),a.keydown(function(e){9!==e.which&&(13===e.which&&this.click(),e.preventDefault())}),t(".upload-dropzone a.upload").keydown(function(e){13===e.which&&this.click()}),t(".collapse-sidebar").on("click keydown",function(e){"keydown"===e.type&&13!==e.which||(s.toggleClass("collapsed").toggleClass("expanded"),e.preventDefault())}),o.length&&t("#customize-control-blogname input").on("input",function(){o.text(this.value)}),(e=new i.Messenger({url:i.settings.url.parent,channel:"loader"})).bind("back",function(){a.on("click.customize-controls-close",function(t){t.preventDefault(),e.send("close")})}),t(window).on("beforeunload",function(){if(!i.state("saved")())return i.l10n.saveAlert}),t.each(["saved","change"],function(t,n){i.bind(n,function(){e.send(n)})}),i.bind("activated",function(){e.targetWindow()?e.send("activated",i.settings.url.activated):i.settings.url.activated&&(window.location=i.settings.url.activated)}),e.send("ready"),t.each({background_image:{controls:["background_repeat","background_position_x","background_attachment"],callback:function(e){return!!e}},show_on_front:{controls:["page_on_front","page_for_posts"],callback:function(e){return"page"===e}},header_textcolor:{controls:["header_textcolor"],callback:function(e){return"blank"!==e}}},function(e,n){i(e,function(e){t.each(n.controls,function(t,r){i.control(r,function(t){var i=function(e){t.container.toggle(n.callback(e))};i(e.get()),e.bind(i)})})})}),i.control("display_header_text",function(e){var t="";e.elements[0].unsync(i("header_textcolor")),e.element=new i.Element(e.container.find("input")),e.element.set("blank"!==e.setting()),e.element.bind(function(n){n||(t=i("header_textcolor").get()),e.setting.set(n?t:"blank")}),e.setting.bind(function(t){e.element.set("blank"!==t)})}),i.trigger("ready"),(n=a).focus(),setTimeout(function(){n.focus()},200)}})}(wp,jQuery);