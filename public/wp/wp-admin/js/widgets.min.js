var wpWidgets;!function(e){wpWidgets={init:function(){var t,i,d=this,s=e(".widgets-chooser"),n=s.find(".widgets-chooser-sidebars"),a=e("div.widgets-sortables"),o=!("undefined"==typeof isRtl||!isRtl);e("#widgets-right .sidebar-name").click(function(){var t=e(this),i=t.closest(".widgets-holder-wrap");i.hasClass("closed")?(i.removeClass("closed"),t.parent().sortable("refresh")):i.addClass("closed")}),e("#widgets-left .sidebar-name").click(function(){e(this).closest(".widgets-holder-wrap").toggleClass("closed")}),e(document.body).bind("click.widgets-toggle",function(t){var i,d,s,n,a=e(t.target),r={"z-index":100};a.parents(".widget-top").length&&!a.parents("#available-widgets").length?(d=(i=a.closest("div.widget")).children(".widget-inside"),s=parseInt(i.find("input.widget-width").val(),10),n=i.parent().width(),d.is(":hidden")?(s>250&&s+30>n&&i.closest("div.widgets-sortables").length&&(r[i.closest("div.widget-liquid-right").length?o?"margin-right":"margin-left":o?"margin-left":"margin-right"]=n-(s+30)+"px",i.css(r)),i.addClass("open"),d.slideDown("fast")):d.slideUp("fast",function(){i.attr("style",""),i.removeClass("open")}),t.preventDefault()):a.hasClass("widget-control-save")?(wpWidgets.save(a.closest("div.widget"),0,1,0),t.preventDefault()):a.hasClass("widget-control-remove")?(wpWidgets.save(a.closest("div.widget"),1,1,0),t.preventDefault()):a.hasClass("widget-control-close")&&(wpWidgets.close(a.closest("div.widget")),t.preventDefault())}),a.children(".widget").each(function(){var t=e(this);wpWidgets.appendTitle(this),t.find("p.widget-error").length&&t.find("a.widget-action").trigger("click")}),e("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"document",start:function(t,s){var n=e(this).find(".widgets-chooser");s.helper.find("div.widget-description").hide(),i=this.id,n.length&&(e("#wpbody-content").append(n.hide()),s.helper.find(".widgets-chooser").remove(),d.clearWidgetSelection())},stop:function(){t&&e(t).hide(),t=""}}),a.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(t,i){var d,s=e(this),n=s.parent(),a=i.item.children(".widget-inside");"block"===a.css("display")&&(a.hide(),e(this).sortable("refreshPositions")),n.hasClass("closed")||(d=i.item.hasClass("ui-draggable")?s.height():1+s.height(),s.css("min-height",d+"px"))},stop:function(d,s){var n,a,o,r,l,c,g=s.item,h=i;if(g.hasClass("deleting"))return wpWidgets.save(g,1,0,1),void g.remove();n=g.find("input.add_new").val(),a=g.find("input.multi_number").val(),g.attr("style","").removeClass("ui-draggable"),i="",n&&("multi"===n?(g.html(g.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,a)})),g.attr("id",h.replace("__i__",a)),a++,e("div#"+h).find("input.multi_number").val(a)):"single"===n&&(g.attr("id","new-"+h),t="div#"+h),wpWidgets.save(g,0,0,1),g.find("input.add_new").val(""),e(document).trigger("widget-added",[g])),(o=g.parent()).parent().hasClass("closed")&&(o.parent().removeClass("closed"),(r=o.children(".widget")).length>1&&(l=r.get(0),c=g.get(0),l.id&&c.id&&l.id!==c.id&&e(l).before(g))),n?g.find("a.widget-action").trigger("click"):wpWidgets.saveOrder(o.attr("id"))},activate:function(){e(this).parent().addClass("widget-hover")},deactivate:function(){e(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(t,i){var d=e(i.sender);this.id.indexOf("orphaned_widgets")>-1?d.sortable("cancel"):d.attr("id").indexOf("orphaned_widgets")>-1&&!d.children(".widget").length&&d.parents(".orphan-sidebar").slideUp(400,function(){e(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables"),e("#available-widgets").droppable({tolerance:"pointer",accept:function(t){return"widget-list"!==e(t).parent().attr("id")},drop:function(t,i){i.draggable.addClass("deleting"),e("#removing-widget").hide().children("span").html("")},over:function(t,i){i.draggable.addClass("deleting"),e("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&e("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h4").html())},out:function(t,i){i.draggable.removeClass("deleting"),e("div.widget-placeholder").show(),e("#removing-widget").hide().children("span").html("")}}),e("#widgets-right .widgets-holder-wrap").each(function(t,i){var d=e(i),s=d.find(".sidebar-name h3").text(),a=d.find(".widgets-sortables").attr("id"),o=e('<li tabindex="0">').text(e.trim(s));0===t&&o.addClass("widgets-chooser-selected"),n.append(o),o.data("sidebarId",a)}),e("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var t=e(this).closest(".widget");t.hasClass("widget-in-question")||e("#widgets-left").hasClass("chooser")?d.closeChooser():(d.clearWidgetSelection(),e("#widgets-left").addClass("chooser"),t.addClass("widget-in-question").children(".widget-description").after(s),s.slideDown(300,function(){n.find(".widgets-chooser-selected").focus()}),n.find("li").on("focusin.widgets-chooser",function(){n.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),e(this).addClass("widgets-chooser-selected")}))}),s.on("click.widgets-chooser",function(t){var i=e(t.target);i.hasClass("button-primary")?(d.addWidget(s),d.closeChooser()):i.hasClass("button-secondary")&&d.closeChooser()}).on("keyup.widgets-chooser",function(t){t.which===e.ui.keyCode.ENTER?e(t.target).hasClass("button-secondary")?d.closeChooser():(d.addWidget(s),d.closeChooser()):t.which===e.ui.keyCode.ESCAPE&&d.closeChooser()})},saveOrder:function(t){var i={action:"widgets-order",savewidgets:e("#_wpnonce_widgets").val(),sidebars:[]};t&&e("#"+t).find(".spinner:first").css("display","inline-block"),e("div.widgets-sortables").each(function(){e(this).sortable&&(i["sidebars["+e(this).attr("id")+"]"]=e(this).sortable("toArray").join(","))}),e.post(ajaxurl,i,function(){e(".spinner").hide()})},save:function(t,i,d,s){var n,a=t.closest("div.widgets-sortables").attr("id"),o=t.find("form").serialize();t=e(t),e(".spinner",t).show(),n={action:"save-widget",savewidgets:e("#_wpnonce_widgets").val(),sidebar:a},i&&(n.delete_widget=1),o+="&"+e.param(n),e.post(ajaxurl,o,function(n){var a;i?(e("input.widget_number",t).val()||(a=e("input.widget-id",t).val(),e("#available-widgets").find("input.widget-id").each(function(){e(this).val()===a&&e(this).closest("div.widget").show()})),d?(s=0,t.slideUp("fast",function(){e(this).remove(),wpWidgets.saveOrder()})):t.remove()):(e(".spinner").hide(),n&&n.length>2&&(e("div.widget-content",t).html(n),wpWidgets.appendTitle(t),e(document).trigger("widget-updated",[t]))),s&&wpWidgets.saveOrder()})},appendTitle:function(t){var i=e('input[id*="-title"]',t).val()||"";i&&(i=": "+i.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),e(t).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(i)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","")})},addWidget:function(t){var i,d,s,n,a,o,r,l=t.find(".widgets-chooser-selected").data("sidebarId"),c=e("#"+l);d=(i=e("#available-widgets").find(".widget-in-question").clone()).attr("id"),s=i.find("input.add_new").val(),n=i.find("input.multi_number").val(),i.find(".widgets-chooser").remove(),"multi"===s?(i.html(i.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,n)})),i.attr("id",d.replace("__i__",n)),n++,e("#"+d).find("input.multi_number").val(n)):"single"===s&&(i.attr("id","new-"+d),e("#"+d).hide()),c.closest(".widgets-holder-wrap").removeClass("closed"),c.append(i),c.sortable("refresh"),wpWidgets.save(i,0,0,1),i.find("input.add_new").val(""),e(document).trigger("widget-added",[i]),o=(a=e(window).scrollTop())+e(window).height(),(r=c.offset()).bottom=r.top+c.outerHeight(),(a>r.bottom||o<r.top)&&e("html, body").animate({scrollTop:r.top-130},200),window.setTimeout(function(){i.find(".widget-title").trigger("click")},250)},closeChooser:function(){var t=this;e(".widgets-chooser").slideUp(200,function(){e("#wpbody-content").append(this),t.clearWidgetSelection()})},clearWidgetSelection:function(){e("#widgets-left").removeClass("chooser"),e(".widget-in-question").removeClass("widget-in-question")}},e(document).ready(function(){wpWidgets.init()})}(jQuery);