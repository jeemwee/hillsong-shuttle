tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return!(!e.dom.getAttrib(t,"data-mce-placeholder")&&!e.dom.getAttrib(t,"data-mce-object"))}function n(t){var n=e.$(t).parents("[contenteditable]");return n&&"false"===n.attr("contenteditable")}function a(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,n,a){var i,o,r,c,l,d;return(i=n.match(/id=['"]([^'"]*)['"] ?/))&&(n=n.replace(i[0],"")),(o=n.match(/align=['"]([^'"]*)['"] ?/))&&(n=n.replace(o[0],"")),(r=n.match(/class=['"]([^'"]*)['"] ?/))&&(n=n.replace(r[0],"")),(d=n.match(/width=['"]([0-9]*)['"] ?/))&&(n=n.replace(d[0],"")),a=u(a),(l=a.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&l[2]?(c=u(l[2]),l=u(l[1])):(c=u(n).replace(/caption=['"]/,"").replace(/['"]$/,""),l=a),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",r=r&&r[1]?" "+r[1].replace(/[<>&]+/g,""):"",!d&&l&&(d=l.match(/width=['"]([0-9]*)['"]/)),d&&d[1]&&(d=d[1]),d&&c?(d=parseInt(d,10),e.getParam("wpeditimage_html5_captions")||(d+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+r+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+l+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl></div>"):a})}function i(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=n.match(/width="([0-9]*)"/),c=c&&c[1]?c[1]:"",o=t.match(/class="([^"]*)"/),o=o&&o[1]?o[1]:"",r=o.match(/align[a-z]+/i)||"alignnone",c&&a?(i=t.match(/id="([^"]*)"/),i=i&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),a=a.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+a+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)})).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function o(e){return e&&!!(e.textContent||e.innerText).replace(/\ufeff/g,"")}function r(t,n){var a,i,r,c,l,d,m,p,g,u,f,h,w,N,v,b,_,C,y=e.dom;(a=tinymce.explode(n.extraClasses," "))||(a=[]),n.caption||a.push("align"+n.align),n.attachment_id&&(a.push("wp-image-"+n.attachment_id),n.size&&"custom"!==n.size&&a.push("size-"+n.size)),N=n.width,v=n.height,"custom"===n.size&&(N=n.customWidth,v=n.customHeight),h={src:n.url,width:N||null,height:v||null,title:n.title||null,class:a.join(" ")||null},y.setAttribs(t,h),e.$(t).attr("alt",n.alt||""),w={href:n.linkUrl,rel:n.linkRel||null,target:n.linkTargetBlank?"_blank":null,class:n.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!o(t.parentNode)?n.linkUrl?y.setAttribs(t.parentNode,w):y.remove(t.parentNode,!0):n.linkUrl&&((m=y.getParent(t,"a"))&&y.insertAfter(t,m),m=y.create("a",w),t.parentNode.insertBefore(m,t),m.appendChild(t)),p=e.dom.getParent(t,".mceTemp"),r=t.parentNode&&"A"===t.parentNode.nodeName&&!o(t.parentNode)?t.parentNode:t,n.caption?(n.caption=function(t){return!t||-1===t.indexOf("<")&&-1===t.indexOf(">")?t:(s||(s=new tinymce.html.Serializer({},e.schema)),s.serialize(e.parser.parse(t,{forced_root_block:!1})))}(n.caption),f=n.attachment_id?"attachment_"+n.attachment_id:null,i="wp-caption "+("align"+(n.align||"none")),n.captionClassName&&(i+=" "+n.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),p?((u=y.select("dl.wp-caption",p)).length&&y.setAttribs(u,{id:f,class:i,style:"width: "+N+"px"}),(g=y.select(".wp-caption-dd",p)).length&&y.setHTML(g[0],n.caption)):(c="<dl "+(f=f?'id="'+f+'" ':"")+'class="'+i+'" style="width: '+N+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n.caption+"</dd></dl>",d=y.create("div",{class:"mceTemp"},c),(l=y.getParent(r,"p"))?l.parentNode.insertBefore(d,l):r.parentNode.insertBefore(d,r),e.$(d).find("dt.wp-caption-dt").append(r),l&&y.isEmpty(l)&&y.remove(l))):p&&(l=y.create("p"),p.parentNode.insertBefore(l,p),l.appendChild(r),y.remove(p)),_=(b=e.$(t)).attr("srcset"),C=b.attr("src"),_&&C&&(C=C.replace(/[?#].*/,""),-1===_.indexOf(C)&&b.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:n,image:t}),e.nodeChanged()}function c(t){var n,a,i;"undefined"!=typeof wp&&wp.media?(i=function(t){var n,a,i,o,r,c,l,d,s=[],m=e.dom,p=/^\d+$/;return i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=m.getAttrib(t,"src"),i.alt=m.getAttrib(t,"alt"),i.title=m.getAttrib(t,"title"),l=m.getAttrib(t,"width"),d=m.getAttrib(t,"height"),(!p.test(l)||parseInt(l,10)<1)&&(l=t.naturalWidth||t.width),(!p.test(d)||parseInt(d,10)<1)&&(d=t.naturalHeight||t.height),i.customWidth=i.width=l,i.customHeight=i.height=d,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):a.push(e)}),i.extraClasses=a.join(" "),(o=m.getParents(t,".wp-caption")).length&&(n=(o=o[0]).className.split(" "),tinymce.each(n,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&s.push(e)}),i.captionClassName=s.join(" "),(r=m.select("dd.wp-caption-dd",o)).length&&(r=r[0],i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(c=t.parentNode,i.linkUrl=m.getAttrib(c,"href"),i.linkTargetBlank="_blank"===m.getAttrib(c,"target"),i.linkRel=m.getAttrib(c,"rel"),i.linkClassName=c.className),i}(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:i,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:i}),wp.media.events.trigger("editor:frame-create",{frame:n}),a=function(a){e.focus(),e.undoManager.transact(function(){r(t,a)}),n.detach()},n.state("image-details").on("update",a),n.state("replace-image").on("replace",a),n.on("close",function(){e.focus(),n.detach()}),n.open()):e.execCommand("mceImage")}function l(t){var n=e.dom.getParent(t,"div.mceTemp");n||"IMG"!==t.nodeName||(n=e.dom.getParent(t,"a")),n?(n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode),e.selection.collapse(!0),e.dom.remove(n)):e.dom.remove(t),e.nodeChanged(),e.undoManager.add()}var d,s,m,p,g=tinymce.each,u=tinymce.trim,f=tinymce.Env.iOS;return e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){l(e.selection.getNode())}}),e.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){c(e.selection.getNode())}}),g({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,n){var a=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+a,cmd:"alignnone"===n?"wpAlignNone":"Justify"+a.slice(0,1).toUpperCase()+a.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",function(a){var i;"IMG"===a.element.nodeName&&(i=e.dom.getParent(a.element,".wp-caption")||a.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n)))})}})}),e.once("preinit",function(){e.wp&&e.wp._createToolbar&&(d=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),e.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||t(e.element)||(e.toolbar=d)}),f&&e.on("init",function(){e.on("touchstart",function(e){"IMG"!==e.target.nodeName||n(e.target)||(m=!0)}),e.dom.bind(e.getDoc(),"touchmove",function(){m=!1}),e.on("touchend",function(t){if(m&&"IMG"===t.target.nodeName&&!n(t.target)){var a=t.target;m=!1,window.setTimeout(function(){e.selection.select(a),e.nodeChanged()},100)}else d&&d.hide()})}),e.on("init",function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n),tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",function(n){"IMG"===n.target.nodeName&&t.getParent(n.target,".wp-caption")?e.getBody().focus():"DL"===n.target.nodeName&&t.hasClass(n.target,"wp-caption")&&n.target.focus()})}),e.on("ObjectResized",function(t){var n=t.target;"IMG"===n.nodeName&&e.undoManager.transact(function(){var a,i,o=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,""),(a=o.getParent(n,".wp-caption"))&&(i=t.width||o.getAttrib(n,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(a,"width",i+"px"))})}),e.on("pastePostProcess",function(t){e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")&&(e.$("img, audio, video, object, embed, iframe, script, style",t.node).remove(),e.$("*",t.node).each(function(t,n){e.dom.isBlock(n)&&(tinymce.trim(n.textContent||n.innerText)?(e.dom.insertAfter(e.dom.create("br"),n),e.dom.remove(n,!0)):e.dom.remove(n))}),e.$("br",t.node).each(function(t,n){n.nextSibling&&"BR"!==n.nextSibling.nodeName&&n.previousSibling&&"BR"!==n.previousSibling.nodeName||e.dom.remove(n)}),p=!0)}),e.on("BeforeExecCommand",function(t){var n,a,i,o,r,c,l=t.command,s=e.dom;if("mceInsertContent"===l||"Indent"===l||"Outdent"===l){if(n=e.selection.getNode(),c=s.getParent(n,"div.mceTemp")){if("mceInsertContent"!==l)return t.preventDefault(),t.stopImmediatePropagation(),!1;if(p)return void(p=!1);a=s.create("p"),s.insertAfter(a,c),e.selection.setCursorLocation(a,0),"IMG"===n.nodeName&&e.$(c).remove(),e.nodeChanged()}}else if("JustifyLeft"===l||"JustifyRight"===l||"JustifyCenter"===l||"wpAlignNone"===l){if(n=e.selection.getNode(),o="align"+l.slice(7).toLowerCase(),i=e.dom.getParent(n,".wp-caption"),"IMG"!==n.nodeName&&!i)return;n=i||n,r=e.dom.hasClass(n,o)?" alignnone":" "+o,n.className=u(n.className.replace(/ ?align(left|center|right|none)/g,"")+r),e.nodeChanged(),t.preventDefault(),d&&d.reposition(),e.fire("ExecCommand",{command:l,ui:t.ui,value:t.value})}}),e.on("keydown",function(t){var n,a,i,o,r=e.selection,c=t.keyCode,d=e.dom,s=tinymce.util.VK;if(c===s.ENTER)n=r.getNode(),(a=d.getParent(n,"div.mceTemp"))&&(d.events.cancel(t),tinymce.each(d.select("dt, dd",a),function(e){d.isEmpty(e)&&d.remove(e)}),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=d.create("p",null,o),"DD"===n.nodeName?d.insertAfter(i,a):a.parentNode.insertBefore(i,a),e.nodeChanged(),r.setCursorLocation(i,0));else if((c===s.DELETE||c===s.BACKSPACE)&&("DIV"===(n=r.getNode()).nodeName&&d.hasClass(n,"mceTemp")?a=n:"IMG"!==n.nodeName&&"DT"!==n.nodeName&&"A"!==n.nodeName||(a=d.getParent(n,"div.mceTemp")),a))return d.events.cancel(t),l(n),!1}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.wpSetImgCaption=function(e){return a(e)},e.wpGetImgCaption=function(e){return i(e)},e.on("beforeGetContent",function(t){"raw"!==t.format&&e.$('img[id="__wp-temp-img-id"]').attr("id",null)}),e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))}),function(){var t;e.on("dragstart",function(){var n=e.selection.getNode();"IMG"===n.nodeName&&((t=e.dom.getParent(n,".mceTemp"))||"A"!==n.parentNode.nodeName||o(n.parentNode)||(t=n.parentNode))}),e.on("drop",function(n){var a=e.dom,i=tinymce.dom.RangeUtils.getCaretRangeFromPoint(n.clientX,n.clientY,e.getDoc());i&&a.getParent(i.startContainer,".mceTemp")?n.preventDefault():t&&(n.preventDefault(),e.undoManager.transact(function(){i&&e.selection.setRng(i),e.selection.setNode(t),a.remove(t)})),t=null})}(),e.wp=e.wp||{},e.wp.isPlaceholder=t,{_do_shcode:a,_get_shcode:i}});