wp.textWidgets=function(t){"use strict";var e={dismissedPointers:[],idBases:["text"]};return e.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(e){var i=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,e),i.syncContainer=e.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",function(e){e.preventDefault(),i.customHtmlWidgetPointer.hide(),t("#"+i.fields.text.attr("id")+"-html").focus(),i.dismissPointers(["text_widget_custom_html"])}),i.customHtmlWidgetPointer.find(".add-widget").on("click",function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()})),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",function(t){t.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,function(t,e){t.on("input change",function(){var n=i.syncContainer.find(".sync-input."+e);n.val()!==t.val()&&(n.val(t.val()),n.trigger("change"))}),t.val(i.syncContainer.find(".sync-input."+e).val())})},dismissPointers:function(t){_.each(t,function(t){wp.ajax.post("dismiss-wp-pointer",{pointer:t}),e.dismissedPointers.push(t)})},openAvailableWidgetsPanel:function(){var t;wp.customize.section.each(function(e){e.extended(wp.customize.Widgets.SidebarSection)&&e.expanded()&&(t=wp.customize.control("sidebars_widgets["+e.params.sidebarId+"]"))}),t&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(t),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function(){var t;this.fields.title.is(document.activeElement)||(t=this.syncContainer.find(".sync-input.title"),this.fields.title.val(t.val())),t=this.syncContainer.find(".sync-input.text"),this.fields.text.is(":visible")?this.fields.text.is(document.activeElement)||this.fields.text.val(t.val()):this.editor&&!this.editorFocused&&t.val()!==this.fields.text.val()&&this.editor.setContent(wp.editor.autop(t.val()))},initializeEditor:function(){function i(){var d,s,u;if(document.getElementById(n))if(void 0!==window.tinymce){if(tinymce.get(n)&&(c=tinymce.get(n).isHidden(),wp.editor.remove(n)),t(document).one("wp-before-tinymce-init.text-widget-init",function(t,e){e.plugins&&(/\bwpview\b/.test(e.plugins)||(e.plugins+=",wpview"))}),wp.editor.initialize(n,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),u=function(e){e.show(),e.find(".close").focus(),wp.a11y.speak(e.find("h3, p").map(function(){return t(this).text()}).get().join("\n\n"))},!(d=window.tinymce.get(n)))throw new Error("Failed to initialize editor");s=function(){t(d.getWin()).on("unload",function(){_.defer(i)}),c&&switchEditors.go(n,"html"),t("#"+n+"-html").on("click",function(){a.pasteHtmlPointer.hide(),-1===e.dismissedPointers.indexOf("text_widget_custom_html")&&u(a.customHtmlWidgetPointer)}),t("#"+n+"-tmce").on("click",function(){a.customHtmlWidgetPointer.hide()}),d.on("pastepreprocess",function(t){var i=t.content;-1===e.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay(function(){u(a.pasteHtmlPointer)},250)})},d.initialized?s():d.on("init",s),a.editorFocused=!1,d.on("focus",function(){a.editorFocused=!0}),d.on("paste",function(){d.setDirty(!0),o()}),d.on("NodeChange",function(){r=!0}),d.on("NodeChange",_.debounce(o,l)),d.on("blur hide",function(){a.editorFocused=!1,o()}),a.editor=d}else wp.editor.initialize(n,{quicktags:!0,mediaButtons:!0})}var n,d,o,s,a=this,l=1e3,c=!1,r=!1;d=a.fields.text,n=d.attr("id"),s=d.val(),o=function(){a.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),a.editor.isHidden()||a.editor.save()),r&&s!==d.val()&&(d.trigger("change"),r=!1,s=d.val())},a.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function(){o()}),i()}}),e.widgetControls={},e.handleWidgetAdded=function(i,n){var d,o,s,a,l,c,r;o=(d=n.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==e.idBases.indexOf(o)&&(a=d.find(".widget-id").val(),e.widgetControls[a]||d.find(".visual").val()&&(c=t("<div></div>"),(r=n.find(".widget-content:first")).before(c),s=new e.TextWidgetControl({el:c,syncContainer:r}),e.widgetControls[a]=s,(l=function(){n.hasClass("open")?s.initializeEditor():setTimeout(l,50)})()))},e.setupAccessibleMode=function(){var i,n,d,o;0!==(i=t(".editwidget > form")).length&&(n=i.find("> .widget-control-actions > .id_base").val(),-1!==e.idBases.indexOf(n)&&i.find(".visual").val()&&(d=t("<div></div>"),(o=i.find("> .widget-inside")).before(d),new e.TextWidgetControl({el:d,syncContainer:o}).initializeEditor()))},e.handleWidgetUpdated=function(t,i){var n,d,o,s;s=(n=i.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==e.idBases.indexOf(s)&&(d=n.find("> .widget-id").val(),(o=e.widgetControls[d])&&o.updateFields())},e.init=function(){var i=t(document);i.on("widget-added",e.handleWidgetAdded),i.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function(){"widgets"===window.pagenow&&(t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget").one("click.toggle-widget-expanded",function(){var i=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);